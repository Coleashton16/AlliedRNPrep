<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Pediatric Heme-Onc Learning Hub</title>

	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		// Tailwind CSS configuration to use the Inter font and define custom animations.
		tailwind.config = {
			theme: {
				extend: {
					fontFamily: {
						sans: ['Inter', 'sans-serif'],
					},
					keyframes: {
						'fade-in': {
							'0%': { opacity: '0', transform: 'scale(0.95)' },
							'100%': { opacity: '1', transform: 'scale(1)' },
						},
					},
					animation: {
						'fade-in': 'fade-in 0.3s ease-out forwards',
					},
				},
			},
		};
	</script>

	<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
	<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

	<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="font-sans antialiased text-gray-900 bg-gray-100">
	<div id="root"></div>

	<script type="text/babel">
		// --- React and Library Setup ---
		// Destructure necessary hooks from the global React object.
		const { useState, useEffect, useCallback, useMemo } = React;

		// --- Mock Authentication Setup for Standalone Demo ---
		// This mock object simulates basic user authentication to allow progress tracking via localStorage.
		const mockAuth = {
			onAuthStateChanged: (callback) => {
				// Simulate an asynchronous authentication check, providing a unique user ID.
				setTimeout(() => callback({ uid: 'standalone-hemeonc-user' }), 100);
				return () => {}; // Returns an empty function as a cleanup/unsubscribe placeholder.
			},
			signInAnonymously: () => Promise.resolve({ user: { uid: 'standalone-hemeonc-user' } }), // Mock anonymous sign-in.
		};

		// --- Content & Data Structure for the Learning Modules ---
		// Transcribed Heme-Onc content structured for the modular app.
		const contentData = {
			'module-1-basics': {
				title: 'Module 1: Cellular Regulation Foundations',
				color: 'from-blue-500 to-indigo-600',
				description: 'Define cellular regulation, differentiate benign vs. malignant, and identify key risk factors.',
				steps: [
					{ id: 'm1-def', title: 'Definition & Scope', type: 'text', content: `
						<p class="text-xl font-semibold mb-3 text-blue-700">Why this matters:</p>
						<p>This module sets the foundational 'rules' for normal cell function (homeostasis). Understanding the norm is the key to identifying and intervening when cells "break the rules," leading to cancer.</p>
						<h4 class="text-lg font-bold mt-4 mb-2">Key Concepts:</h4>
						<ul>
							<li><strong>Cellular Regulation:</strong> Refers to all functions carried out within a cell to maintain homeostasis (stability), including responses to external signals (like hormones, cytokines) and producing an appropriate intracellular response.</li>
							<li><strong>Scope and Variation:</strong> Ranges from normal growth to malignant neoplasia.</li>
							<li><strong>Benign Neoplasm:</strong> Excessive growth of normal cells. They are **NOT** capable of metastasis (spreading).</li>
							<li><strong>Malignant Neoplasm (Cancer):</strong> Abnormal cells that grow and **ARE** capable of metastasis (spreading) to distant sites. This is the crucial difference.</li>
						</ul>
					`},
					{ id: 'm1-risk', title: 'Risk Factors & Context', type: 'text', content: `
						<p class="text-xl font-semibold mb-3 text-blue-700">Clinical Context:</p>
						<p>Understanding risk factors allows for effective prevention and targeted screening.</p>
						<h4 class="text-lg font-bold mt-4 mb-2">Primary Risk Factors for Impaired Cellular Regulation:</h4>
						<ul>
							<li><strong>Age:</strong> Incidence increases with age, but children face specific risks due to rapid growth.</li>
							<li><strong>Genetics/Race:</strong> Predisposing genetic conditions (e.g., Down syndrome) and racial predispositions exist.</li>
							<li><strong>Lifestyle/Environment:</strong> Smoking/tobacco, radiation (sunlight), exposure to environmental carcinogens (pollutants), poor nutrition, and a sedentary lifestyle.</li>
							<li><strong>Infectious Agents:</strong> Certain viruses (e.g., HPV, Hepatitis B) can be risk factors for specific cancers.</li>
						</ul>
						<h4 class="text-lg font-bold mt-4 mb-2">Nursing & Collaborative Interventions (Optimizing Regulation):</h4>
						<p>Interventions range from screening and prevention (e.g., sun protection, healthy diet) to advanced medical and surgical treatments (chemotherapy, radiation, surgery) aimed at restoring or controlling cellular growth.</p>
					`},
					{ id: 'm1-quiz', title: 'Module 1 Quiz', type: 'quiz',
						questions: [
							{ question: "What is the primary difference between a benign and malignant neoplasm?", options: ["Benign is always large; malignant is small.", "Malignant is capable of metastasis; benign is not.", "Benign is easily treated; malignant is incurable.", "Malignant always causes fever; benign does not."], correctAnswer: "Malignant is capable of metastasis; benign is not." },
							{ question: "Which risk factor is considered a lifestyle-related carcinogen?", options: ["Genetics", "Age", "Infectious Agents", "Smoking/tobacco exposure"], correctAnswer: "Smoking/tobacco exposure" },
							{ question: "Cellular regulation refers to a cell's ability to maintain:", options: ["Maturation", "Homeostasis", "Infection control", "Mitosis rate"], correctAnswer: "Homeostasis" }
						]
					}
				]
			},
			'module-2-peds-onc': {
				title: 'Module 2: The Pediatric Cancer Difference',
				color: 'from-purple-500 to-pink-600',
				description: 'Compare adult vs. pediatric cancers and recognize the "sneaky" S/S of childhood malignancy.',
				steps: [
					{ id: 'm2-why', title: 'Why Kids Are Different', type: 'text', content: `
						<p class="text-xl font-semibold mb-3 text-purple-700">The "Why" for Pediatric Cancers:</p>
						<p>You cannot treat children like tiny adults. Their physiology dictates that their cancers are fundamentally different and progress more rapidly.</p>
						<h4 class="text-lg font-bold mt-4 mb-2">Differences (Adults vs. Children):</h4>
						<table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
							<thead class="bg-purple-50">
								<tr>
									<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Feature</th>
									<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Adult Cancers</th>
									<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Childhood Cancers</th>
								</tr>
							</thead>
							<tbody class="bg-white divide-y divide-gray-200">
								<tr>
									<td class="px-3 py-2 whitespace-nowrap text-sm font-medium">Cell Type</td>
									<td class="px-3 py-2 text-sm text-gray-500">Epithelial (lung, colon, breast)</td>
									<td class="px-3 py-2 text-sm text-gray-500">Non-epithelial or Embryonal (blood, bone, CNS)</td>
								</tr>
								<tr>
									<td class="px-3 py-2 whitespace-nowrap text-sm font-medium">Growth Rate</td>
									<td class="px-3 py-2 text-sm text-gray-500">Slow growing, gradual onset</td>
									<td class="px-3 py-2 text-sm text-gray-500">Fast growing, may suddenly appear sick</td>
								</tr>
								<tr>
									<td class="px-3 py-2 whitespace-nowrap text-sm font-medium">Cause</td>
									<td class="px-3 py-2 text-sm text-gray-500">Usually environmental exposure (smoking, asbestos)</td>
									<td class="px-3 py-2 text-sm text-gray-500">Usually developmental/genetic, **not** linked to lifestyle/carcinogen exposure</td>
								</tr>
							</tbody>
						</table>
						<h4 class="text-lg font-bold mt-4 mb-2">Physiologic Drivers of Childhood Cancer:</h4>
						<ol class="list-decimal list-inside ml-4">
							<li><strong>Rapid Cell Growth:</strong> Children's normal growth rate facilitates the rapid progression of cancer.</li>
							<li><strong>Immature Immune System:</strong> The immune system is still developing, making it less effective at detecting and eliminating abnormal cells.</li>
							<li><strong>Fetal Cells:</strong> The continuing presence of fetal cells is related to the occurrence of some pediatric cancers.</li>
						</ol>
					`},
					{ id: 'm2-ss', title: 'The "Sneaky" Signs of Cancer (S/S)', type: 'text', content: `
						<p class="text-xl font-semibold mb-3 text-purple-700">Clinical Connection: The Delayed Diagnosis</p>
						<p>Many presenting S&S of cancer mimic common childhood illnesses, leading to diagnostic delays. Cancer is "sneaky."</p>
						<h4 class="text-lg font-bold mt-4 mb-2">Common S/S (Red Flags):</h4>
						<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
							<ul class="list-disc list-inside ml-4">
								<li>Persistent or unexplained **Pain** (bone or joint)</li>
								<li>**Cachexia** (unexplained weight loss, anorexia, early satiety)</li>
								<li>**Anemia** (pallor, fatigue)</li>
								<li>Frequent **Infections** (unexplained fever)</li>
								<li>**Bruising and Petechiae** (tiny red/purple dots)</li>
							</ul>
							<ul class="list-disc list-inside ml-4">
								<li>**Palpable Mass** (lump that wasn't there before)</li>
								<li>**Changes in Mental Health/Neurologic Status** (Increased intracranial pressure, altered consciousness, eye abnormalities)</li>
								<li>**Asthenia** (weakness)</li>
								<li>**Loss of weight** (unrelated to dieting/illness)</li>
							</ul>
						</div>
					`},
					{ id: 'm2-quiz', title: 'Module 2 Quiz', type: 'quiz',
						questions: [
							{ question: "Pediatric cancers are typically what cell type?", options: ["Epithelial", "Mesenchymal", "Embryonal", "Glandular"], correctAnswer: "Embryonal" },
							{ question: "What is the term for severe general weakness, often accompanying cancer-related weight loss?", options: ["Anemia", "Cachexia", "Asthenia", "Leukopenia"], correctAnswer: "Asthenia" },
							{ question: "Why does the rapid progression of childhood cancer occur?", options: ["High carcinogen exposure", "Lack of adult hormones", "Immature immune response and rapid cell growth", "Delayed hospital admission"], correctAnswer: "Immature immune response and rapid cell growth" }
						]
					}
				]
			},
			'module-3-leukemia': {
				title: 'Module 3: Acute Lymphocytic Leukemia (ALL)',
				color: 'from-orange-500 to-red-400',
				description: 'The most common pediatric malignancy: understand its pathogenesis, key symptoms, and phases of treatment.',
				steps: [
					{ id: 'm3-patho', title: 'Leukemia Pathophysiology', type: 'text', content: `
						<p class="text-xl font-semibold mb-3 text-red-700">What Happens in Leukemia?</p>
						<p>Leukemia is a cancer of the blood-forming tissues (bone marrow). It is the most commonly diagnosed pediatric malignancy.</p>
						<h4 class="text-lg font-bold mt-4 mb-2">The Crowding-Out Effect:</h4>
						<ol class="list-decimal list-inside ml-4">
							<li>Stem cells in bone marrow produce **immature, abnormal WBCs** (blasts) that cannot function normally.</li>
							<li>These immature cells multiply rapidly (cloning).</li>
							<li>The bone marrow fills up with abnormal WBCs, **crowding out** the production of normal, healthy cells.</li>
							<li>The abnormal cells spill into circulation, replacing normal WBCs, RBCs, and Platelets.</li>
						</ol>
						<h4 class="text-lg font-bold mt-4 mb-2">Results (Bone Marrow Failure):</h4>
						<ul>
							<li>**Low functional WBCs:** Protective functions are reduced $\rightarrow$ Vulnerable to **Infections** (Fever).</li>
							<li>**Low RBCs:** Reduced oxygen transport $\rightarrow$ **Anemia** (Pallor, Lethargy, Malaise).</li>
							<li>**Low Platelets:** Impaired clotting $\rightarrow$ **Bleeding** (Petechiae, Overt bleeding).</li>
						</ul>
						<h4 class="text-lg font-bold mt-4 mb-2">Key Cause Theory:</h4>
						<p>Etiology is not well understood, but theories suggest exposure to infections and **Genetic factors** (e.g., Down's syndrome has increased risk for ALL) and radiation exposure.</p>
					`},
					{ id: 'm3-ss-pain', title: 'Critical S/S and Treatment Phases', type: 'text', content: `
						<p class="text-xl font-semibold mb-3 text-red-700">Clinical Focus: The Pain</p>
						<h4 class="text-lg font-bold mt-4 mb-2">The Cardinal Symptom:</h4>
						<p class="font-bold text-lg text-red-600">***Pain (Joint or Bone)***</p>
						<p>This occurs because the bone marrow cavity is painfully expanding due to the sheer volume of rapidly proliferating, abnormal blast cells, pushing on the bone itself. This is often dismissed as "growing pains," leading to diagnostic delay.</p>

						<h4 class="text-lg font-bold mt-4 mb-2">Treatment Phases of ALL (The Marathon):</h4>
						<ul class="list-disc list-inside ml-4">
							<li>**Induction:** Initial phase aimed at achieving remission (ridding the body of as many leukemia cells as possible).</li>
							<li>**Consolidation:** Intensive therapy to maintain remission and reduce any remaining cancer cells.</li>
							<li>**Delayed Intensification:** Re-introduction of intensive drugs to prevent relapse.</li>
							<li>**Maintenance of Remission:** Long phase (2-3 years) of oral chemotherapy to prevent relapse, but this causes decreased resistance to infections.</li>
							<li>**CNS Treatment:** Chemotherapy and/or Radiation for CNS disease, T-cell leukemia, and testicular involvement.</li>
						</ul>
					`},
					{ id: 'm3-quiz', title: 'Module 3 Quiz', type: 'quiz',
						questions: [
							{ question: "The main reason a child with leukemia experiences pain is due to:", options: ["Neuropathy from chemotherapy", "Enlarged spleen pressing on nerves", "Abnormal cell proliferation causing pressure in the bone marrow", "Lack of calcium due to malnutrition"], correctAnswer: "Abnormal cell proliferation causing pressure in the bone marrow" },
							{ question: "The consequence of low platelet count in leukemia is:", options: ["Fever", "Anorexia", "Overt signs of bleeding", "Joint pain"], correctAnswer: "Overt signs of bleeding" },
							{ question: "Which phase of leukemia treatment is the longest, lasting 2-3 years?", options: ["Induction", "Consolidation", "Delayed Intensification", "Maintenance of remission"], correctAnswer: "Maintenance of remission" }
						]
					}
				]
			},
			'module-4-neutropenia': {
				title: 'Module 4: Oncologic Emergencies & Precautions',
				color: 'from-green-500 to-emerald-400',
				description: 'Master ANC calculation, neutropenic precautions, and recognition of tumor lysis syndrome (TLS).',
				steps: [
					{ id: 'm4-anc', title: 'Neutropenia & ANC Calculation', type: 'text', content: `
						<p class="text-xl font-semibold mb-3 text-green-700">Neutropenic Fever is a Medical Emergency!</p>
						<h4 class="text-lg font-bold mt-4 mb-2">Neutropenia Defined:</h4>
						<ul>
							<li>**Neutrophils:** A critical type of white blood cell that helps the body fight bacterial infection.</li>
							<li>**Neutropenia:** A condition where a person has a low count of neutrophils in their blood.</li>
						</ul>
						<h4 class="text-lg font-bold mt-4 mb-2">Absolute Neutrophil Count (ANC) Calculation:</h4>
						<p>ANC is the measure of the body's infection-fighting capability. It is the key value you monitor.</p>
						<p class="p-3 bg-gray-100 rounded-lg font-mono text-sm">
							ANC = ( [ % Segs + % Bands ] $\times$ WBC count ) / 100
						</p>
						<p>A score of **ANC < 1000** indicates risk of infection, necessitating special precautions.</p>
					`},
					{ id: 'm4-precautions', title: 'Neutropenic Precautions & TLS', type: 'text', content: `
						<p class="text-xl font-semibold mb-3 text-green-700">Your "Bubble Protocol":</p>
						<h4 class="text-lg font-bold mt-4 mb-2">Neutropenic Precautions:</h4>
						<p>Steps taken to prevent infections if a patient has moderate to severe neutropenia (ANC < 1000).</p>
						<ul class="list-disc list-inside ml-4">
							<li>Strict **Hand Hygiene** by everyone (staff, family, patient).</li>
							<li>Private room.</li>
							<li>**NO** fresh flowers, raw fruits, or raw vegetables (risk of fungal/bacterial pathogens).</li>
							<li>Patient must wear a mask outside the room.</li>
							<li>Avoid sick staff/visitors.</li>
							<li>No rectal temperatures or unnecessary invasive procedures.</li>
						</ul>
						<h4 class="text-lg font-bold mt-4 mb-2">Oncological Emergency: Tumor Lysis Syndrome (TLS)</h4>
						<p>Caused by rapid cancer cell lysis (breaking open) after chemo, dumping intracellular contents into the bloodstream. This is a toxic side effect.</p>
						<ul class="list-disc list-inside ml-4">
							<li>**Key Risk:** Hyperkalemia (risk of fatal arrhythmia) and Hyperuricemia (risk of renal failure).</li>
							<li>**Nursing Interventions:** Increased IV hydration (to flush toxins), strict I/O, daily weights, monitoring of renal function.</li>
						</ul>
					`},
					{ id: 'm4-quiz', title: 'Module 4 Quiz', type: 'quiz',
						questions: [
							{ question: "A patient's ANC is 550. This indicates:", options: ["Normal immune function", "Risk of infection requiring precautions", "Need for a platelet transfusion", "Tumor Lysis Syndrome"], correctAnswer: "Risk of infection requiring precautions" },
							{ question: "Which item should be immediately removed from the room of a patient on Neutropenic Precautions?", options: ["Television", "A sealed box of tissues", "A bouquet of fresh cut flowers", "A stuffed animal"], correctAnswer: "A bouquet of fresh cut flowers" },
							{ question: "The primary risk of hyperkalemia in Tumor Lysis Syndrome is:", options: ["Metabolic alkalosis", "Cardiac arrhythmias", "Severe pain", "Gastrointestinal bleeding"], correctAnswer: "Cardiac arrhythmias" }
						]
					}
				]
			},
			'module-5-chemo-care': {
				title: 'Module 5: Chemotherapy & Supportive Care',
				color: 'from-teal-500 to-cyan-600',
				description: 'Nursing care for chemo, managing extravasation, and key patient teaching highlights.',
				steps: [
					{ id: 'm5-care', title: 'Nursing Care during Chemotherapy', type: 'text', content: `
						<p class="text-xl font-semibold mb-3 text-teal-700">Chemo Side Effects are Your Responsibility to Manage:</p>
						<h4 class="text-lg font-bold mt-4 mb-2">Critical Nursing Interventions:</h4>
						<ul class="list-disc list-inside ml-4">
							<li>**Increased IV Hydration:** Before and after chemo infusion to prevent nephrotoxicity and flush toxic metabolites.</li>
							<li>**Monitor Renal Function:** Strict I/O, daily weights, and lab monitoring (BUN/Creatinine).</li>
							<li>**Observe for Bleeding/Infection:** Thorough physical assessment every 8 hours or more frequently.</li>
							<li>**Assess IV Lines:** Watch for patency, redness, swelling, and signs of **extravasation**.</li>
							<li>**Monitor Dietary Intake:** Chemotherapy often causes anorexia and GI upset.</li>
							<li>**Transfusions:** May need platelets or PRBC infusions (supportive care).</li>
						</ul>
					`},
					{ id: 'm5-extravasation', title: 'Extravasation & Patient Teaching', type: 'text', content: `
						<p class="text-xl font-semibold mb-3 text-teal-700">The Extravasation Emergency:</p>
						<h4 class="text-lg font-bold mt-4 mb-2">Extravasation Action Plan:</h4>
						<p>This occurs when a vesicant drug leaks into the surrounding tissue, causing damage.</p>
						<ol class="list-decimal list-inside ml-4">
							<li>**STOP** the infusion immediately.</li>
							<li>Do NOT remove the cannula (it may be needed to aspirate residual drug or inject an antidote).</li>
							<li>Follow specific hospital protocol (antidote injection, cold/warm pack application).</li>
							<li>Document thoroughly.</li>
						</ol>
						<h4 class="text-lg font-bold mt-4 mb-2">Patient Teaching Highlights:</h4>
						<ul class="list-disc list-inside ml-4">
							<li>**Oral Hygiene:** Maintain good oral hygiene (soft toothbrush, prevent mucositis).</li>
							<li>**Rest:** Ensure rest periods each day to combat fatigue.</li>
							<li>**Avoid Illness Exposure:** Strictly avoid exposure to contagious illnesses.</li>
							<li>**Skin/Sun:** Avoid sun exposure, check skin daily (risk of rash, burns).</li>
							<li>**Bowel Elimination:** Allow time for and eat foods to promote bowel elimination (manage constipation/diarrhea).</li>
							<li>**Prepare for Hair Loss (Alopecia):** Provide anticipatory guidance.</li>
						</ul>
					`},
					{ id: 'm5-case', title: 'Case Study: Chemo Complication', type: 'case_study', case: {
						scenario: `You are monitoring a 7-year-old child 12 hours after their first round of chemotherapy. The patient is receiving IV fluids at a high rate. The morning labs show K+ 6.1 (normal 3.5-5.0), Uric Acid 10.5 (high), and an increasing BUN. The patient reports general aches and nausea.`,
						question: `What is the most likely oncologic emergency and the priority nursing intervention? (Select one priority action)`,
						options: [
							"Option A: Administer a strong opioid painkiller and lower the IV fluid rate.",
							"Option B: Immediately notify the provider and administer a potassium-lowering medication (e.g., Kayexalate or glucose/insulin).",
							"Option C: Stop all IV fluids, remove the IV site, and administer an antiemetic.",
							"Option D: Initiate Neutropenic Precautions immediately.",
						],
						correctAnswer: "Option B: Immediately notify the provider and administer a potassium-lowering medication (e.g., Kayexalate or glucose/insulin).",
						explanation: `<strong>Rationale:</strong> The patient's clinical and lab picture (high K+, high Uric Acid, acute kidney injury signs, recent chemo) is classic for **Tumor Lysis Syndrome (TLS)**.
						<ul>
							<li><strong>Option B (Correct):</strong> Hyperkalemia (K+ > 6.0) is the most life-threatening component of TLS, risking fatal cardiac arrhythmias. Immediate intervention is required to lower potassium and treat the underlying TLS.</li>
							<li><strong>Option A (Incorrect):</strong> Lowering the IV rate is contraindicated; vigorous hydration is needed to flush uric acid and cell debris.</li>
							<li><strong>Option C (Incorrect):</strong> Stopping IV fluids is contraindicated, and TLS is not related to extravasation (which is a local IV complication).</li>
							<li><strong>Option D (Incorrect):</strong> Neutropenic precautions are baseline care for this patient, but TLS is the acute, life-threatening emergency demanding immediate action.</li>
						</ul>`
					}},
					{ id: 'm5-quiz', title: 'Module 5 Quiz', type: 'quiz',
						questions: [
							{ question: "The first action a nurse should take when noticing signs of extravasation during a vesicant chemotherapy infusion is:", options: ["Remove the IV catheter and elevate the extremity.", "Inject an antidote into the site.", "Stop the infusion immediately.", "Apply a warm pack to the site."], correctAnswer: "Stop the infusion immediately." },
							{ question: "Why is increased IV hydration critical for a patient receiving chemotherapy?", options: ["To prevent hypotension", "To promote wound healing", "To protect the kidneys from toxic metabolites and cell debris", "To ensure comfort and rest"], correctAnswer: "To protect the kidneys from toxic metabolites and cell debris" },
							{ question: "Mouth sores caused by chemotherapy are medically known as:", options: ["Alopecia", "Cachexia", "Asthenia", "Mucositis"], correctAnswer: "Mucositis" }
						]
					}
				]
			},
			'module-6-scd-basics': {
				title: 'Module 6: Sickle Cell Disease (SCD) Pathophysiology',
				color: 'from-orange-400 to-red-500',
				description: 'Understand the mechanism of sickling, the VOC crisis, and key triggers to avoid.',
				steps: [
					{ id: 'm6-patho', title: 'SCD: Hemoglobinopathy', type: 'text', content: `
						<p class="text-xl font-semibold mb-3 text-red-700">Cellular Regulation Failure: Sickle Cells</p>
						<p>Sickle cell disease is a hemoglobinopathy (abnormality in hemoglobin) where red blood cells (RBCs) produce abnormal hemoglobin (HbS) which, when deoxygenated, becomes rigid and distorts the cell shape.</p>
						<h4 class="text-lg font-bold mt-4 mb-2">The Sickling Process:</h4>
						<ul class="list-disc list-inside ml-4">
							<li>Normal RBCs are soft, flexible, and donut-shaped.</li>
							<li>Sickle RBCs are **hard, sticky, and crescent-shaped**.</li>
							<li>The deformed cells live for only about 10-20 days (normal is 120 days), leading to chronic **Anemia**.</li>
							<li>The rigid, sticky cells get **trapped** in small blood vessels, leading to a logjam.</li>
						</ul>
					`},
					{ id: 'm6-voc', title: 'Vaso-occlusive Crisis (VOC)', type: 'text', content: `
						<p class="text-xl font-semibold mb-3 text-red-700">The Vaso-occlusive Crisis (VOC):</p>
						<p>This is the most common reason for hospitalization in SCD patients.</p>
						<h4 class="text-lg font-bold mt-4 mb-2">Mechanism of Pain:</h4>
						<ol class="list-decimal list-inside ml-4">
							<li>Sickle cells clump together, causing a **vascular occlusion** (blockage).</li>
							<li>The blockage prevents blood flow and, critically, **oxygen** from reaching the downstream tissues and organs.</li>
							<li>Tissue hypoxia and ischemia (lack of blood flow) cause **EXTREME pain** and local tissue damage.</li>
						</ol>
						<h4 class="text-lg font-bold mt-4 mb-2">Key Triggers of Sickling:</h4>
						<p>Any condition that increases the body's need for oxygen or alters the transport of oxygen will trigger a crisis.</p>
						<ul class="list-disc list-inside ml-4">
							<li>**Fever/Infection** (increases metabolic rate/O2 demand)</li>
							<li>**Hypoxia** (e.g., high altitudes, poorly pressurized planes, hypoventilation)</li>
							<li>**Dehydration** (increases blood viscosity)</li>
							<li>Emotional stress or physical stress/overexertion</li>
							<li>**Cold** (causes vasoconstriction, promoting clogging)</li>
						</ul>
					`},
					{ id: 'm6-quiz', title: 'Module 6 Quiz', type: 'quiz',
						questions: [
							{ question: "The shape of the sickle cell is caused by an abnormality in which component?", options: ["Plasma", "White blood cells", "Hemoglobin", "Platelets"], correctAnswer: "Hemoglobin" },
							{ question: "What is the primary physiologic result of a Vaso-occlusive Crisis (VOC)?", options: ["Hypercoagulation", "Tissue ischemia and severe pain", "Rapid antibody production", "Leukopenia"], correctAnswer: "Tissue ischemia and severe pain" },
							{ question: "Which factor should a patient with SCD be taught to strictly avoid as it increases blood viscosity?", options: ["Adequate rest", "Vigorous hydration", "Dehydration", "Folic acid supplements"], correctAnswer: "Dehydration" }
						]
					}
				]
			},
			'module-7-scd-mgmt': {
				title: 'Module 7: Management of Sickle Cell Crisis',
				color: 'from-blue-600 to-sky-500',
				description: 'Master the H-O-P management protocol, education, and complication prevention for SCD.',
				steps: [
					{ id: 'm7-interventions', title: 'The H-O-P Management Protocol', type: 'text', content: `
						<p class="text-xl font-semibold mb-3 text-sky-700">The H-O-P Protocol is the Core Management Strategy for VOC:</p>
						<h4 class="text-lg font-bold mt-4 mb-2">The "H-O-P" Triangle:</h4>
						<ol class="list-decimal list-inside ml-4">
							<li>**H - Hydration (Vigorous):** Give IV fluids to reverse dehydration and dilute the blood, helping to "unstick" the clogged cells.</li>
							<li>**O - Oxygen (Supplemental):** Given to reverse existing hypoxia, which is a key trigger and perpetuator of sickling.</li>
							<li>**P - Pain Management (Aggressive):** Pain is severe and real. Use PCA (patient-controlled analgesia) with strong opioids (Morphine/Dilaudid). **NEVER** delay pain medication in a suspected crisis.</li>
						</ol>
						<h4 class="text-lg font-bold mt-4 mb-2">Other Interventions:</h4>
						<ul class="list-disc list-inside ml-4">
							<li>**Warmth:** Apply warm compresses; **AVOID cold** (cold causes vasoconstriction, worsening the crisis).</li>
							<li>**Rest:** Decrease the body's metabolic demand for oxygen.</li>
							<li>**Transfusions:** Blood product transfusion (packed RBCs) to improve oxygen-carrying capacity.</li>
						</ul>
					`},
					{ id: 'm7-prevention', title: 'Prevention and Education', type: 'text', content: `
						<p class="text-xl font-semibold mb-3 text-sky-700">Nursing Goal: Avoid Crises and Prevent Complications</p>
						<h4 class="text-lg font-bold mt-4 mb-2">Preventing Crises (Education):</h4>
						<ul class="list-disc list-inside ml-4">
							<li>**Stay Hydrated:** Especially during exercise or playing sports.</li>
							<li>**Avoid Sudden Temperature Changes:** Especially cold temps.</li>
							<li>**Avoid High Altitude:** Can trigger hypoxia.</li>
						</ul>
						<h4 class="text-lg font-bold mt-4 mb-2">Preventing Complications (Immunization/Meds):</h4>
						<ul class="list-disc list-inside ml-4">
							<li>**Prophylactic Antibiotics:** Penicillin (PCN) given daily from 2 months to 5 years to prevent fatal bacterial infections (due to splenic dysfunction).</li>
							<li>**Vaccines:** Stay up-to-date with Pneumococcal, H. Influenza, and Hep B vaccines.</li>
							<li>**Hydroxyurea:** Prescribed to prevent crises by increasing fetal hemoglobin (HbF).</li>
							<li>**Folic Acid:** Daily supplements to help the body rapidly produce new red cells.</li>
						</ul>
					`},
					{ id: 'm7-case', title: 'Case Study: SCD Complication', type: 'case_study', case: {
						scenario: `An 8-year-old patient with Sickle Cell Disease is admitted for a severe VOC and has been receiving H-O-P for 12 hours. The patient now develops a new **fever (38.8°C/101.8°F)**, cough, and reports **chest pain**. Oxygen saturation drops from 95% to 88% on room air.`,
						question: `What is the most serious and life-threatening complication the nurse should suspect, and what is the immediate priority action? (Select all that apply.)`,
						options: [
							"Option A: Suspect Acute Chest Syndrome (ACS).",
							"Option B: Suspect a Stroke/CVA.",
							"Option C: Immediately administer a blood product transfusion and broad-spectrum IV antibiotics.",
							"Option D: Continue H-O-P and apply a cold compress to the chest for pain.",
							"Option E: Initiate a fever workup (blood cultures) and notify the provider for likely respiratory support.",
						],
						correctAnswer: [
							"Option A: Suspect Acute Chest Syndrome (ACS).",
							"Option C: Immediately administer a blood product transfusion and broad-spectrum IV antibiotics.",
							"Option E: Initiate a fever workup (blood cultures) and notify the provider for likely respiratory support.",
						],
						explanation: `<strong>Rationale:</strong>
						The signs (fever, chest pain, cough, new hypoxia) are the classic presentation of <strong>Acute Chest Syndrome (ACS)</strong>, a leading cause of death in SCD.
						<ul>
							<li><strong>Option A (Correct):</strong> ACS is the complication to suspect; it is essentially a VOC in the lungs that causes inflammation and infection.</li>
							<li><strong>Option C (Correct):</strong> Treatment for ACS involves aggressive pain control, oxygen, prompt transfusion (often exchange transfusion), and <strong>immediate initiation of broad-spectrum antibiotics</strong> due to the high likelihood of bacterial pneumonia.</li>
							<li><strong>Option E (Correct):</strong> Fever requires a full sepsis workup, and the worsening respiratory status necessitates rapid notification of the provider for escalation of care and potential ventilatory support.</li>
							<li><strong>Option B (Incorrect):</strong> While stroke is a risk, the respiratory signs point to ACS.</li>
							<li><strong>Option D (Incorrect):</strong> A cold compress is strictly contraindicated as it causes vasoconstriction, worsening the sickling process.</li>
						</ul>`
					}},
					{ id: 'm7-quiz', title: 'Module 7 Quiz', type: 'quiz',
						questions: [
							{ question: "What are the three priority components of the H-O-P protocol for a Vaso-occlusive Crisis?", options: ["Heat, Opioids, Positioning", "Hydration, Oxygen, Pain Management", "Hemoglobin, Opioid, Penicillin", "Hygiene, Orientation, Pressure"], correctAnswer: "Hydration, Oxygen, Pain Management" },
							{ question: "Why is Penicillin prophylaxis given to young children with Sickle Cell Disease?", options: ["To prevent severe anemia", "To prevent Vaso-occlusive Crises", "To prevent life-threatening bacterial infections (due to splenic damage)", "To reduce bone pain"], correctAnswer: "To prevent life-threatening bacterial infections (due to splenic damage)" },
							{ question: "The medication Hydroxyurea works by promoting the production of what, which helps prevent sickling?", options: ["Platelets", "Fetal hemoglobin (HbF)", "Normal adult hemoglobin (HbA)", "Neutrophils"], correctAnswer: "Fetal hemoglobin (HbF)" }
						]
					}
				]
			}
		};

		// The pre-assessment quiz data is compiled from the first 3 quiz questions of each module.
		const preAssessmentQuizData = [
			// Module 1 Questions
			{ moduleId: 'module-1-basics', question: "What is the primary difference between a benign and malignant neoplasm?", options: ["Benign is always large; malignant is small.", "Malignant is capable of metastasis; benign is not.", "Benign is easily treated; malignant is incurable.", "Malignant always causes fever; benign does not."], correctAnswer: "Malignant is capable of metastasis; benign is not." },
			{ moduleId: 'module-1-basics', question: "Which risk factor is considered a lifestyle-related carcinogen?", options: ["Genetics", "Age", "Infectious Agents", "Smoking/tobacco exposure"], correctAnswer: "Smoking/tobacco exposure" },
			{ moduleId: 'module-1-basics', question: "Cellular regulation refers to a cell's ability to maintain:", options: ["Maturation", "Homeostasis", "Infection control", "Mitosis rate"], correctAnswer: "Homeostasis" },

			// Module 2 Questions
			{ moduleId: 'module-2-peds-onc', question: "Pediatric cancers are typically what cell type?", options: ["Epithelial", "Mesenchymal", "Embryonal", "Glandular"], correctAnswer: "Embryonal" },
			{ moduleId: 'module-2-peds-onc', question: "What is the term for severe general weakness, often accompanying cancer-related weight loss?", options: ["Anemia", "Cachexia", "Asthenia", "Leukopenia"], correctAnswer: "Asthenia" },
			{ moduleId: 'module-2-peds-onc', question: "Why does the rapid progression of childhood cancer occur?", options: ["High carcinogen exposure", "Lack of adult hormones", "Immature immune response and rapid cell growth", "Delayed hospital admission"], correctAnswer: "Immature immune response and rapid cell growth" },

			// Module 3 Questions
			{ moduleId: 'module-3-leukemia', question: "The main reason a child with leukemia experiences pain is due to:", options: ["Neuropathy from chemotherapy", "Enlarged spleen pressing on nerves", "Abnormal cell proliferation causing pressure in the bone marrow", "Lack of calcium due to malnutrition"], correctAnswer: "Abnormal cell proliferation causing pressure in the bone marrow" },
			{ moduleId: 'module-3-leukemia', question: "The consequence of low platelet count in leukemia is:", options: ["Fever", "Anorexia", "Overt signs of bleeding", "Joint pain"], correctAnswer: "Overt signs of bleeding" },
			{ moduleId: 'module-3-leukemia', question: "Which phase of leukemia treatment is the longest, lasting 2-3 years?", options: ["Induction", "Consolidation", "Delayed Intensification", "Maintenance of remission"], correctAnswer: "Maintenance of remission" },

			// Module 4 Questions
			{ moduleId: 'module-4-neutropenia', question: "A patient's ANC is 550. This indicates:", options: ["Normal immune function", "Risk of infection requiring precautions", "Need for a platelet transfusion", "Tumor Lysis Syndrome"], correctAnswer: "Risk of infection requiring precautions" },
			{ moduleId: 'module-4-neutropenia', question: "Which item should be immediately removed from the room of a patient on Neutropenic Precautions?", options: ["Television", "A sealed box of tissues", "A bouquet of fresh cut flowers", "A stuffed animal"], correctAnswer: "A bouquet of fresh cut flowers" },
			{ moduleId: 'module-4-neutropenia', question: "The primary risk of hyperkalemia in Tumor Lysis Syndrome is:", options: ["Metabolic alkalosis", "Cardiac arrhythmias", "Severe pain", "Gastrointestinal bleeding"], correctAnswer: "Cardiac arrhythmias" },

			// Module 5 Questions
			{ moduleId: 'module-5-chemo-care', question: "The first action a nurse should take when noticing signs of extravasation during a vesicant chemotherapy infusion is:", options: ["Remove the IV catheter and elevate the extremity.", "Inject an antidote into the site.", "Stop the infusion immediately.", "Apply a warm pack to the site."], correctAnswer: "Stop the infusion immediately." },
			{ moduleId: 'module-5-chemo-care', question: "Why is increased IV hydration critical for a patient receiving chemotherapy?", options: ["To prevent hypotension", "To promote wound healing", "To protect the kidneys from toxic metabolites and cell debris", "To ensure comfort and rest"], correctAnswer: "To protect the kidneys from toxic metabolites and cell debris" },
			{ moduleId: 'module-5-chemo-care', question: "Mouth sores caused by chemotherapy are medically known as:", options: ["Alopecia", "Cachexia", "Asthenia", "Mucositis"], correctAnswer: "Mucositis" },

			// Module 6 Questions
			{ moduleId: 'module-6-scd-basics', question: "The shape of the sickle cell is caused by an abnormality in which component?", options: ["Plasma", "White blood cells", "Hemoglobin", "Platelets"], correctAnswer: "Hemoglobin" },
			{ moduleId: 'module-6-scd-basics', question: "What is the primary physiologic result of a Vaso-occlusive Crisis (VOC)?", options: ["Hypercoagulation", "Tissue ischemia and severe pain", "Rapid antibody production", "Leukopenia"], correctAnswer: "Tissue ischemia and severe pain" },
			{ moduleId: 'module-6-scd-basics', question: "Which factor should a patient with SCD be taught to strictly avoid as it increases blood viscosity?", options: ["Adequate rest", "Vigorous hydration", "Dehydration", "Folic acid supplements"], correctAnswer: "Dehydration" },

			// Module 7 Questions
			{ moduleId: 'module-7-scd-mgmt', question: "What are the three priority components of the H-O-P protocol for a Vaso-occlusive Crisis?", options: ["Heat, Opioids, Positioning", "Hydration, Oxygen, Pain Management", "Hemoglobin, Opioid, Penicillin", "Hygiene, Orientation, Pressure"], correctAnswer: "Hydration, Oxygen, Pain Management" },
			{ moduleId: 'module-7-scd-mgmt', question: "Why is Penicillin prophylaxis given to young children with Sickle Cell Disease?", options: ["To prevent severe anemia", "To prevent Vaso-occlusive Crises", "To prevent life-threatening bacterial infections (due to splenic damage)", "To reduce bone pain"], correctAnswer: "To prevent life-threatening bacterial infections (due to splenic damage)" },
			{ moduleId: 'module-7-scd-mgmt', question: "The medication Hydroxyurea works by promoting the production of what, which helps prevent sickling?", options: ["Platelets", "Fetal hemoglobin (HbF)", "Normal adult hemoglobin (HbA)", "Neutrophils"], correctAnswer: "Fetal hemoglobin (HbF)" }
		];

		// --- Helper Functions ---
		const cn = (...classes) => classes.filter(Boolean).join(' ');

		// --- Child Components ---

		/**
		 * Quiz component for interactive multiple-choice questions.
		 */
		const Quiz = ({ questions, onComplete, isPreAssessment = false }) => {
			const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
			const [selectedOption, setSelectedOption] = useState([]);
			const [feedback, setFeedback] = useState(null);
			const [answers, setAnswers] = useState([]);

			const currentQuestion = questions[currentQuestionIndex];

			// Determine if the current question is multi-select (SATA)
			const isMultiSelect = Array.isArray(currentQuestion.correctAnswer) && currentQuestion.correctAnswer.length > 1;

			const handleOptionSelect = (option) => {
				if (feedback && !isPreAssessment) return;

				if (isMultiSelect) {
					setSelectedOption(prevSelected => {
						if (prevSelected.includes(option)) {
							return prevSelected.filter(item => item !== option);
						} else {
							return [...prevSelected, option];
						}
					});
				} else {
					// Single select logic
					setSelectedOption([option]); // Always store as array internally for consistent checking
				}
			};

			const checkCorrectness = (options, correctAnswers) => {
				if (Array.isArray(correctAnswers)) {
					// Multi-select (SATA) check: Must contain ALL correct answers and ONLY those correct answers.
					const correctCount = correctAnswers.filter(ans => options.includes(ans)).length;
					return correctCount === correctAnswers.length && options.length === correctAnswers.length;
				} else {
					// Single select check
					return options[0] === correctAnswers;
				}
			};

			const handlePreAssessmentNext = () => {
				if (selectedOption.length === 0) return;

				const isCorrect = checkCorrectness(selectedOption, currentQuestion.correctAnswer);

				const updatedAnswers = [...answers, { question: currentQuestion, isCorrect }];
				setAnswers(updatedAnswers);

				if (currentQuestionIndex < questions.length - 1) {
					setCurrentQuestionIndex(currentQuestionIndex + 1);
					setSelectedOption([]);
					setFeedback(null);
				} else {
					onComplete(updatedAnswers);
				}
			};

			const handleRegularQuizSubmit = () => {
				if (selectedOption.length === 0) return;
				const isCorrect = checkCorrectness(selectedOption, currentQuestion.correctAnswer);
				setFeedback(isCorrect ? 'correct' : 'incorrect');
			};

			const handleRegularQuizNext = () => {
				if (!feedback) return; // Cannot proceed without submitting first

				const isCorrect = checkCorrectness(selectedOption, currentQuestion.correctAnswer);
				const finalAnswers = [...answers, { question: currentQuestion, isCorrect, score: isCorrect ? 1 : 0 }];
				
				if (currentQuestionIndex < questions.length - 1) {
					setAnswers(finalAnswers);
					setCurrentQuestionIndex(currentQuestionIndex + 1);
					setSelectedOption([]);
					setFeedback(null);
				} else {
					const finalScore = finalAnswers.reduce((acc, ans) => acc + (ans.score || 0), 0);
					onComplete({ score: finalScore, total: questions.length });
				}
			};

			const selectedAnswerText = isMultiSelect ? selectedOption : selectedOption[0];
			
			return (
				<div className="p-4 bg-white rounded-xl shadow-lg border border-gray-200 animate-fade-in">
					<h4 className="font-extrabold text-2xl text-gray-800 mb-4 flex justify-between items-center">
						<span>{isPreAssessment ? 'Diagnostic Question' : 'Module Quiz'}</span>
						<span className="text-lg font-semibold text-indigo-600">{currentQuestionIndex + 1} of {questions.length}</span>
					</h4>
					
					{isMultiSelect && <p className="text-sm font-bold text-red-500 mb-2">**SELECT ALL THAT APPLY (SATA)**</p>}
					
					<p className="font-semibold text-gray-700 mb-4 text-lg">{currentQuestion.question}</p>
					<div className="space-y-3">
						{currentQuestion.options.map((option, index) => {
							const isSelected = selectedOption.includes(option);
							const isCorrectOption = Array.isArray(currentQuestion.correctAnswer)
								? currentQuestion.correctAnswer.includes(option)
								: option === currentQuestion.correctAnswer;
							
							let optionClass = 'bg-gray-50 hover:bg-gray-100 border-gray-300';

							if (feedback && !isPreAssessment) {
								if (isCorrectOption) {
									optionClass = 'bg-green-100 border-green-500 text-green-800 font-medium';
								} else if (isSelected && !isCorrectOption) {
									optionClass = 'bg-red-100 border-red-500 text-red-800 font-medium';
								}
							} else if (isSelected) {
								optionClass = 'bg-indigo-100 border-indigo-500 text-indigo-800 font-medium shadow-inner';
							}

							return (
								<div
									key={index}
									onClick={() => handleOptionSelect(option)}
									className={cn('p-3 rounded-xl border-2 cursor-pointer transition-all duration-150 flex items-center', optionClass)}
								>
									<span className="flex-1">{option}</span>
									{feedback && !isPreAssessment && (isCorrectOption || (isSelected && !isCorrectOption)) && (
										isCorrectOption ? <span className="text-green-600 ml-2">✓</span> : <span className="text-red-600 ml-2">✗</span>
									)}
								</div>
							);
						})}
					</div>
					<div className="mt-6 text-center">
						{isPreAssessment ? (
							<button
								onClick={handlePreAssessmentNext}
								disabled={selectedOption.length === 0}
								className="px-8 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors transform hover:scale-105"
							>
								{currentQuestionIndex < questions.length - 1 ? 'Next Question' : 'Finish Assessment'}
							</button>
						) : (
							<>
								{!feedback ? (
									<button
										onClick={handleRegularQuizSubmit}
										disabled={selectedOption.length === 0}
										className="px-8 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors transform hover:scale-105"
									>
										Submit Answer
									</button>
								) : (
									<button
										onClick={handleRegularQuizNext}
										className="px-8 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition-colors transform hover:scale-105"
									>
										{currentQuestionIndex < questions.length - 1 ? 'Next Question' : 'View Score'}
									</button>
								)}
							</>
						)}
					</div>
				</div>
			);
		};

		/**
		 * PreAssessmentQuiz component to handle the initial diagnostic quiz.
		 */
		const PreAssessmentQuiz = ({ onComplete, onExit }) => {
			const [results, setResults] = useState(null);

			const handleQuizComplete = (finalAnswers) => {
				const moduleResults = {};
				finalAnswers.forEach(answer => {
					const { moduleId } = answer.question;
					if (!moduleResults[moduleId]) {
						moduleResults[moduleId] = { correct: 0, total: 0 };
					}
					if (answer.isCorrect) {
						moduleResults[moduleId].correct++;
					}
					moduleResults[moduleId].total++;
				});

				const completedModules = [];
				for (const moduleId in moduleResults) {
					// Test-out criteria: 100% correct in that module's diagnostic questions.
					if (moduleResults[moduleId].correct === moduleResults[moduleId].total) {
						completedModules.push(moduleId);
					}
				}
				setResults({ completedModules, total: finalAnswers.length, correct: finalAnswers.filter(a => a.isCorrect).length });
				onComplete(completedModules);
			};

			if (results) {
				return (
					<div className="fixed inset-0 bg-gray-100 flex items-center justify-center z-40 p-4 animate-fade-in">
						<div className="bg-white rounded-2xl shadow-xl p-8 max-w-2xl w-full text-center">
							<h2 className="text-3xl font-extrabold text-gray-800 mb-4">Diagnostic Complete!</h2>
							<p className="text-lg text-gray-600 mb-6">
								You correctly answered {results.correct} out of {results.total} questions.
							</p>
							{results.completedModules.length > 0 ? (
								<>
									<p className="text-green-600 font-bold text-xl mb-4">You've successfully tested out of:</p>
									<ul className="list-disc list-inside text-left mb-6 bg-green-50 p-4 rounded-xl shadow-inner border border-green-200">
										{results.completedModules.map(id => <li key={id} className="font-semibold">{contentData[id].title}</li>)}
									</ul>
									<p className="text-gray-700 text-sm italic mb-6">Your progress for these modules has been marked as complete.</p>
								</>
							) : (
								<p className="text-yellow-600 font-bold text-xl mb-6 bg-yellow-50 p-4 rounded-xl shadow-inner border border-yellow-200">
									Keep going! Use the learning modules to review the content.
								</p>
							)}
							<button
								onClick={onExit}
								className="px-8 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition-colors transform hover:scale-105"
							>
								Return to Dashboard
							</button>
						</div>
					</div>
				);
			}

			return (
				<div className="fixed inset-0 bg-gray-100 flex items-center justify-center z-40 p-4">
					<div className="bg-white rounded-2xl shadow-xl p-8 max-w-3xl w-full">
						<h2 className="text-3xl font-extrabold text-center text-gray-800 mb-6">Diagnostic Quiz (Pre-Assessment)</h2>
						<Quiz questions={preAssessmentQuizData} onComplete={handleQuizComplete} isPreAssessment={true} />
					</div>
				</div>
			);
		};


		/**
		 * Dashboard component to display the available learning modules.
		 */
		const Dashboard = ({ onSelectModule, progress, onResetProgress, onStartPreAssessment }) => {
			let totalCompletedSteps = 0;
			let totalPossibleSteps = 0;
			let totalQuizCorrect = 0;
			let totalQuizQuestions = 0;

			// Calculate overall progress and gather quiz scores
			Object.entries(contentData).forEach(([moduleId, module]) => {
				totalPossibleSteps += module.steps.length;
				const moduleProgress = progress[moduleId] || {};
				
				Object.values(moduleProgress).forEach(stepProgress => {
					if (stepProgress.completed) {
						totalCompletedSteps++;
					}
					if (stepProgress.score !== undefined) {
						totalQuizCorrect += stepProgress.score;
					}
				});

				module.steps.forEach(step => {
					if (step.type === 'quiz' || step.type === 'case_study') {
						totalQuizQuestions += (step.type === 'quiz' ? step.questions.length : 1);
					}
				});
			});

			const overallPercentage = totalPossibleSteps > 0 ? (totalCompletedSteps / totalPossibleSteps) * 100 : 0;

			return (
				<div className="p-4 sm:p-6 md:p-8 min-h-screen w-full flex flex-col">
					<div className="w-full">
						<header className="mb-8 text-center">
							<div className="flex items-center justify-center gap-3 mb-2">
								<span className="w-12 h-12 bg-red-600 text-white rounded-full flex items-center justify-center font-extrabold text-xl shadow-lg">HO</span>
								<h1 className="text-3xl sm:text-4xl font-extrabold text-gray-800">Peds Heme-Onc Learning Hub</h1>
								<span className="bg-gray-200 text-gray-600 text-xs font-mono px-2.5 py-1 rounded-full">V:2.0</span>
							</div>
							<p className="text-lg text-gray-500 max-w-2xl mx-auto">Master essential concepts in Cellular Regulation, Pediatric Oncology, and Hematologic Disorders (ADHD-friendly structure).</p>
						</header>

						{/* Skip Ahead Button */}
						<div className="mb-8 text-center">
							<button
								onClick={onStartPreAssessment}
								className="w-full max-w-md mx-auto px-6 py-4 bg-teal-500 text-white font-bold rounded-xl shadow-lg hover:bg-teal-600 transition-all duration-300 transform hover:scale-105"
							>
								<div className="text-xl font-extrabold">Skip Ahead: Take Diagnostic Quiz</div>
								<div className="text-sm font-medium">Test your knowledge and potentially skip modules. (21 Questions)</div>
							</button>
						</div>

						{/* Overall Progress Bar & Reset Button */}
						<div className="mb-12 bg-white rounded-2xl shadow-xl p-6 w-full max-w-4xl mx-auto">
						   <div className="flex justify-between items-center mb-3">
							  <h3 className="text-xl font-bold text-gray-800">Overall Progress</h3>
							  <button 
									onClick={onResetProgress}
									className="px-4 py-2 text-sm bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition-colors flex items-center gap-2 transform hover:scale-105"
								>
									<svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V4a1 1 0 112 0v1.001A7.002 7.002 0 0112.292 4.293a1 1 0 111.414 1.414A9.002 9.002 0 004 9.899V11a1 1 0 11-2 0V3a1 1 0 011-1z" clipRule="evenodd" /></svg>
									Reset Progress
							  </button>
						   </div>
						   <div className="w-full bg-gray-200 rounded-full h-4">
							   <div
								  className="bg-indigo-600 h-4 rounded-full transition-all duration-500 ease-out"
								  style={{ width: `${overallPercentage}%` }}
							   ></div>
						   </div>
						   <div className="flex justify-between items-center">
							  <p className="text-left text-sm text-gray-600 mt-2">
								  {totalQuizQuestions > 0 && `Quiz Performance: ${totalQuizCorrect} / ${totalQuizQuestions} correct`}
							  </p>
							  <p className="text-right text-sm text-gray-600 mt-2 font-bold">{Math.round(overallPercentage)}% Completed</p>
						   </div>
						</div>

						<div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 w-full">
							{/* Iterate over all modules defined in contentData */}
							{Object.entries(contentData).map(([id, module]) => {
								const moduleProgress = progress[id] || {};
								// Calculate completion count for steps within the module.
								const completedCount = Object.values(moduleProgress).filter(p => p.completed).length;
								const totalSteps = module.steps.length;
								const percentage = totalSteps > 0 ? (completedCount / totalSteps) * 100 : 0;

								let statusText = "Not Started";
								let statusColor = "text-gray-500";
								if (completedCount === totalSteps) {
									statusText = "COMPLETED";
									statusColor = "text-green-600 font-extrabold";
								} else if (completedCount > 0) {
									statusText = "In Progress";
									statusColor = "text-yellow-600 font-bold";
								}

								return (
									<div
										key={id}
										onClick={() => onSelectModule(id)}
										className="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 cursor-pointer transition-all duration-300 hover:shadow-2xl hover:-translate-y-1 group flex flex-col transform animate-fade-in"
									>
										<div className="flex justify-between items-start mb-4">
											{/* Module Icon/Title Tag */}
											<div className={cn("p-3 rounded-full bg-gradient-to-br", module.color, "w-12 h-12 flex items-center justify-center text-white text-lg font-extrabold shadow-lg flex-shrink-0")}>
												{module.title.split(': ')[0].replace('Module ', 'M')}
											</div>
											{/* Progress Circle */}
											<div className="relative w-12 h-12 flex-shrink-0">
												<svg className="w-full h-full" viewBox="0 0 36 36">
													{/* Background circle for the progress bar. */}
													<path
														className="text-gray-200"
														d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
														fill="none"
														stroke="currentColor"
														strokeWidth="3"
													/>
													{/* Foreground arc representing the completion percentage. */}
													<path
														className="text-indigo-500 transition-all duration-700"
														d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
														fill="none"
														stroke="currentColor"
														strokeWidth="3"
														strokeDasharray={`${percentage}, 100`}
														strokeLinecap="round"
														transform="rotate(-90 18 18)"
													/>
												</svg>
												<span className={cn("absolute inset-0 flex items-center justify-center text-xs font-extrabold", percentage === 100 ? 'text-green-600' : 'text-gray-600')}>
													{Math.round(percentage)}%
												</span>
											</div>
										</div>
										<h3 className="text-xl font-extrabold text-gray-800 mb-2">{module.title.split(': ')[1]}</h3>
										<p className="text-gray-500 text-sm mb-4 h-10">{module.description}</p>
										<div className="mt-auto pt-2 border-t border-gray-100">
											<p className={cn("text-sm", statusColor)}>{statusText}</p>
											<div className="flex items-center justify-between text-sm font-bold text-indigo-600 group-hover:text-indigo-700 mt-2">
												{percentage === 100 ? 'Review Module' : 'Start Learning'} 
												<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 ml-1 transition-transform group-hover:translate-x-1" viewBox="0 0 20 20" fill="currentColor">
													<path fillRule="evenodd" d="M12.97 4.97a.75.75 0 011.06 0l4.5 4.5a.75.75 0 010 1.06l-4.5 4.5a.75.75 0 11-1.06-1.06l3.22-3.22H4a.75.75 0 010-1.5h12.19l-3.22-3.22a.75.75 0 010-1.06z" clipRule="evenodd" />
												</svg>
											</div>
										</div>
									</div>
								);
							})}
						</div>
					</div>
				</div>
			);
		};

		/**
		 * CaseStudy component for a multiple-choice case study challenge.
		 */
		const CaseStudy = ({ caseData, onComplete }) => {
			const [selectedAnswers, setSelectedAnswers] = useState([]);
			const [showFeedback, setShowFeedback] = useState(false);
			
			const isMultiSelect = Array.isArray(caseData.correctAnswer) && caseData.correctAnswer.length > 1;

			const handleSelect = (option) => {
				if (showFeedback) return;

				if (isMultiSelect) {
					setSelectedAnswers(prevSelected => {
						if (prevSelected.includes(option)) {
							return prevSelected.filter(item => item !== option);
						} else {
							return [...prevSelected, option];
						}
					});
				} else {
					// Single select logic
					setSelectedAnswers([option]);
				}
			};

			const checkCorrectness = (options, correctAnswers) => {
				if (Array.isArray(correctAnswers)) {
					const correctCount = correctAnswers.filter(ans => options.includes(ans)).length;
					return correctCount === correctAnswers.length && options.length === correctAnswers.length;
				} else {
					return options[0] === correctAnswers;
				}
			};

			const handleSubmit = () => {
				setShowFeedback(true);
				const isCorrect = checkCorrectness(selectedAnswers, caseData.correctAnswer);
				
				if (isCorrect) {
					onComplete({ score: 1, total: 1 });
				} else {
					onComplete({ score: 0, total: 1 });
				}
			};

			return (
				<div className="p-6 bg-white rounded-xl shadow-lg border border-red-200 animate-fade-in">
					<h4 className="font-extrabold text-2xl text-red-700 mb-4 flex items-center">
						<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mr-2" viewBox="0 0 20 20" fill="currentColor">
							<path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 001 1h3a1 1 0 100-2h-2V6z" clipRule="evenodd" />
						</svg>
						Clinical Case Challenge
					</h4>
					{isMultiSelect && <p className="text-sm font-bold text-red-500 mb-2">**SELECT ALL THAT APPLY (SATA)**</p>}
					<div className="mb-4 p-4 bg-gray-50 rounded-lg border-l-4 border-indigo-400">
						<h5 className="font-bold text-indigo-700 mb-1">Scenario:</h5>
						<p className="text-gray-700 text-sm" dangerouslySetInnerHTML={{ __html: caseData.scenario }}></p>
					</div>
					
					<p className="font-bold text-gray-800 mb-3 text-lg">{caseData.question}</p>
					
					<div className="space-y-3">
						{caseData.options.map(option => {
							const isSelected = selectedAnswers.includes(option);
							const isCorrectOption = Array.isArray(caseData.correctAnswer)
								? caseData.correctAnswer.includes(option)
								: option === caseData.correctAnswer;
							
							let optionClass = 'bg-gray-50 hover:bg-gray-100 border-gray-300';
							if (showFeedback) {
								if (isCorrectOption) {
									optionClass = 'bg-green-100 border-green-500 text-green-800 font-medium shadow-md';
								} else if (isSelected && !isCorrectOption) {
									optionClass = 'bg-red-100 border-red-500 text-red-800 font-medium shadow-md';
								}
							} else if (isSelected) {
								optionClass = 'bg-indigo-100 border-indigo-500 text-indigo-800 font-medium shadow-inner';
							}

							return (
								<div
									key={option}
									onClick={() => handleSelect(option)}
									className={cn('p-3 rounded-xl border-2 cursor-pointer transition-colors flex items-center', optionClass)}
								>
									<span className="flex-1">{option}</span>
									{showFeedback && (
										isCorrectOption ? <span className="text-green-600 ml-2">✓</span> : (isSelected && <span className="text-red-600 ml-2">✗</span>)
									)}
								</div>
							);
						})}
					</div>
					{!showFeedback && (
						<div className="mt-6 text-center">
							<button
								onClick={handleSubmit}
								disabled={selectedAnswers.length === 0}
								className="px-8 py-3 bg-red-600 text-white font-bold rounded-xl shadow-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors transform hover:scale-105"
							>
								Submit Case Answer
							</button>
						</div>
					)}
					{showFeedback && (
						<div className="mt-6 p-4 bg-yellow-50 rounded-xl border-l-4 border-yellow-500 shadow-inner">
							<h5 className="font-bold text-yellow-800 text-lg mb-2">Detailed Rationale:</h5>
							<div className="text-sm text-yellow-900 prose-sm" dangerouslySetInnerHTML={{ __html: caseData.explanation }}></div>
						</div>
					)}
				</div>
			);
		};

		/**
		 * StaticContentStep component for displaying basic text content.
		 */
		const StaticContentStep = ({ step, onComplete }) => {
			// Mark as complete immediately upon rendering to enable progression.
			useEffect(() => {
				onComplete();
			}, [step.id, onComplete]); // Depend on step.id to re-trigger on navigation

			return (
				<div className="prose max-w-none text-gray-700 leading-relaxed p-6 bg-white rounded-xl shadow-lg border border-gray-200 space-y-4 animate-fade-in">
					<div dangerouslySetInnerHTML={{ __html: step.content }}></div>
				</div>
			);
		};

		/**
		 * CompletionModal component displayed when a module is completed.
		 */
		const CompletionModal = ({ isOpen, onClose, onNextModule, hasNextModule }) => {
			if (!isOpen) return null;

			return (
				<div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
					<div className="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full text-center transform animate-fade-in">
						<h3 className="text-3xl font-extrabold text-indigo-700 mb-4">Module Completed! 🎉</h3>
						<p className="text-gray-700 text-lg mb-6">You've successfully completed all steps in this module. Great job!</p>
						<div className="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
							<button
								onClick={onClose}
								className="px-6 py-3 bg-gray-300 text-gray-800 font-bold rounded-xl hover:bg-gray-400 transition-colors shadow-md"
							>
								Back to Dashboard
							</button>
							{hasNextModule && (
								<button
									onClick={onNextModule}
									className="px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition-colors transform hover:scale-105"
								>
									Continue to Next Module
								</button>
							)}
						</div>
					</div>
				</div>
			);
		};

		/**
		 * LearningModule component to manage steps within the selected module.
		 */
		const LearningModule = ({ module, onBack, progress, onProgressUpdate, onNextModule, hasNextModule }) => {
			const [activeStep, setActiveStep] = useState(0);
			const [isSidebarOpen, setIsSidebarOpen] = useState(false);
			const [isCompletionModalOpen, setIsCompletionModalOpen] = useState(false);

			// Reset to step 0 when module changes
			useEffect(() => {
				setActiveStep(0);
			}, [module.id]);

			const handleStepComplete = useCallback((stepId, data = {}) => {
				onProgressUpdate(module.id, stepId, { completed: true, ...data });
			}, [onProgressUpdate, module.id]);

			const moduleProgress = progress[module.id] || {};
			
			// Check if all essential steps (text, quiz, case_study) are completed
			const allStepsCompletedInModule = module.steps.every(step =>
				moduleProgress[step.id] && moduleProgress[step.id].completed
			);

			// Navigates to the next step, if available.
			const handleNextStep = () => {
				if (activeStep === module.steps.length - 1) {
					// If it's the last step and all steps in the module are completed, open the modal
					if (allStepsCompletedInModule) {
						setIsCompletionModalOpen(true);
					}
				} else if (activeStep < module.steps.length - 1) {
					// Otherwise, proceed to the next step
					setActiveStep(activeStep + 1);
				}
			};

			// Navigates to the previous step, if available.
			const handlePrevStep = () => {
				if (activeStep > 0) {
					setActiveStep(activeStep - 1);
				}
			};
			
			if (!module || !module.steps) {
				return <div className="fixed inset-0 flex items-center justify-center bg-gray-100 text-gray-700">Error loading module.</div>;
			}

			const currentStep = module.steps[activeStep];
			
			const renderStepContent = (step) => {
				if (!step) return <p>Please select a step.</p>;

				const onCompleteForStep = (data) => handleStepComplete(step.id, data);

				switch (step.type) {
					case 'text':
						return <StaticContentStep key={step.id} step={step} onComplete={onCompleteForStep} />;
					case 'case_study':
						return <CaseStudy key={step.id} caseData={step.case} onComplete={onCompleteForStep} />;
					case 'quiz':
						return <Quiz key={step.id} questions={step.questions} onComplete={onCompleteForStep} />;
					default:
						return <p key={step.id} className="text-red-600">Error: Content for this step type is not available.</p>;
				}
			};

			const handleModalClose = () => {
				setIsCompletionModalOpen(false);
				onBack(); // Go back to dashboard when modal is closed
			};

			const handleModalNextModule = () => {
				setIsCompletionModalOpen(false);
				onNextModule(); // Proceed to next module
			};


			return (
				<div className="fixed inset-0 bg-gray-100 flex flex-col z-20">
					{/* Header */}
					<header className="bg-white shadow-lg p-4 flex items-center justify-between z-30 flex-shrink-0">
						<button onClick={onBack} className="flex items-center gap-2 text-indigo-600 font-bold hover:text-indigo-800 transition-colors p-2 rounded-lg -ml-2 transform hover:scale-105">
							<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clipRule="evenodd" /></svg>
							<span className="hidden sm:inline">Dashboard</span>
						</button>
						<h2 className="text-xl font-extrabold text-gray-800 text-center flex-1 sm:flex-initial truncate px-2">{module.title}</h2>
						
						{/* Mobile sidebar toggle button */}
						<button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="md:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors">
							<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
						</button>
					</header>
					
					{isSidebarOpen && <div onClick={() => setIsSidebarOpen(false)} className="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden"></div>}
					<div className="flex flex-1 overflow-hidden">
						{/* Sidebar for navigation steps within the module. */}
						<aside className={cn(
							"bg-white border-r border-gray-200 p-4 w-72 lg:w-80 flex-shrink-0 flex flex-col transition-transform duration-300 ease-in-out md:translate-x-0 absolute md:static h-full z-20",
							isSidebarOpen ? 'translate-x-0' : '-translate-x-full'
						)}>
							<h3 className="text-lg font-extrabold mb-4 text-indigo-700 px-3 border-b border-gray-100 pb-2">Module Steps ({activeStep + 1} / {module.steps.length})</h3>
							<nav className="space-y-1 overflow-y-auto flex-1 pr-1">
								{module.steps.map((step, index) => (
									<button
										key={step.id}
										onClick={() => {
											setActiveStep(index);
											setIsSidebarOpen(false); // Close sidebar on mobile after a step is selected.
										}}
										className={cn(
											'w-full text-left p-3 rounded-xl flex items-center gap-3 transition-colors shadow-sm',
											activeStep === index ? 'bg-indigo-100 text-indigo-700 font-bold border-indigo-400 border' : 'hover:bg-gray-100 text-gray-700'
										)}
									>
										{/* Step completion indicator */}
										<div className="w-5 h-5 flex-shrink-0 flex items-center justify-center">
											{moduleProgress[step.id]?.completed ? (
												<svg className="w-5 h-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>
											) : (
												<div className={cn("w-3 h-3 rounded-full border-2", activeStep === index ? "border-indigo-500 bg-indigo-500" : "border-gray-400 bg-white")}></div>
											)}
										</div>
										<span className="flex-1 text-sm">{step.title}</span>
									</button>
								))}
							</nav>
						</aside>

						{/* Main content area for the current step. */}
						<main className="flex-1 overflow-y-auto p-4 sm:p-6 md:p-8">
							<div className="max-w-5xl mx-auto">
								<h3 className="text-2xl font-extrabold text-gray-800 mb-4">{currentStep.title}</h3>
								{renderStepContent(currentStep)}

								{/* Navigation buttons for moving between steps. */}
								<div className="flex justify-between mt-8">
									<button
										onClick={handlePrevStep}
										disabled={activeStep === 0}
										className="px-6 py-3 bg-gray-300 text-gray-800 font-bold rounded-xl hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-md transform hover:scale-105 disabled:hover:scale-100"
									>
										<span className="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10.707 3.293a1 1 0 010 1.414L7.414 8l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clipRule="evenodd" /></svg>Previous</span>
									</button>

									<button
										onClick={handleNextStep}
										disabled={activeStep === module.steps.length - 1 && !allStepsCompletedInModule}
										className="px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors transform hover:scale-105 disabled:hover:scale-100"
									>
										{activeStep === module.steps.length - 1 ? (allStepsCompletedInModule ? 'Finish Module' : 'Complete All Steps') : <span className="flex items-center">Next <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9.293 3.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 8 9.293 4.707a1 1 0 010-1.414z" clipRule="evenodd" /></svg></span>}
									</button>
								</div>
							</div>
						</main>
					</div>
					<CompletionModal
						isOpen={isCompletionModalOpen}
						onClose={handleModalClose}
						onNextModule={handleModalNextModule}
						hasNextModule={hasNextModule}
					/>
				</div>
			);
		};

		// --- Main App Component ---
		function App() {
			const [currentModuleId, setCurrentModuleId] = useState(null);
			const [isPreAssessmentActive, setIsPreAssessmentActive] = useState(false);
			const [userId, setUserId] = useState(null);
			const [progress, setProgress] = useState({});
			const [isAuthReady, setIsAuthReady] = useState(false);

			// 1. Auth Setup (Local Storage)
			useEffect(() => {
				const unsubscribe = mockAuth.onAuthStateChanged((user) => {
					if (user) setUserId(user.uid);
					setIsAuthReady(true);
				});
				return () => unsubscribe();
			}, []);

			// 2. Load Progress from Local Storage
			useEffect(() => {
				if (!isAuthReady || !userId) return;
				const storedProgress = localStorage.getItem(`hemeonc-module-progress-${userId}`);
				if (storedProgress) {
					try {
						setProgress(JSON.parse(storedProgress));
					} catch (e) {
						console.error("Failed to parse stored progress, resetting.", e);
						setProgress({});
					}
				}
			}, [isAuthReady, userId]);

			// 3. Progress Update Handler (Persist to Local Storage)
			const handleProgressUpdate = useCallback((moduleId, stepId, data = {}) => {
				if (!isAuthReady || !userId) return;

				setProgress(currentProgress => {
					const currentStepProgress = currentProgress[moduleId]?.[stepId] || {};
					const newStepProgress = { ...currentStepProgress, ...data };

					// Avoid unnecessary updates if data hasn't changed.
					if (JSON.stringify(currentStepProgress) === JSON.stringify(newStepProgress)) {
						return currentProgress;
					}

					const newProgress = {
						...currentProgress,
						[moduleId]: {
							...(currentProgress[moduleId] || {}),
							[stepId]: newStepProgress
						}
					};

					localStorage.setItem(`hemeonc-module-progress-${userId}`, JSON.stringify(newProgress));
					return newProgress;
				});
			}, [isAuthReady, userId]);

			const handlePreAssessmentComplete = (completedModuleIds) => {
				const newProgress = { ...progress };
				completedModuleIds.forEach(moduleId => {
					const module = contentData[moduleId];
					if (module) {
						newProgress[moduleId] = {};
						module.steps.forEach(step => {
							// Mark all steps in the module as complete
							newProgress[moduleId][step.id] = { completed: true };
						});
					}
				});
				setProgress(newProgress);
				localStorage.setItem(`hemeonc-module-progress-${userId}`, JSON.stringify(newProgress));
			};
			
			const handleResetProgress = useCallback(() => {
				if (!isAuthReady || !userId) return;
				setProgress({});
				localStorage.removeItem(`hemeonc-module-progress-${userId}`);
				setCurrentModuleId(null);
			}, [isAuthReady, userId]);

			const handleNextModule = useCallback(() => {
				const moduleIds = Object.keys(contentData);
				const currentIndex = moduleIds.indexOf(currentModuleId);
				if (currentIndex !== -1 && currentIndex < moduleIds.length - 1) {
					setCurrentModuleId(moduleIds[currentIndex + 1]);
				} else {
					setCurrentModuleId(null);
				}
			}, [currentModuleId]);

			const selectedModule = currentModuleId && contentData[currentModuleId]
														? { ...contentData[currentModuleId], id: currentModuleId }
														: null;

			const moduleIds = Object.keys(contentData);
			const currentIndex = selectedModule ? moduleIds.indexOf(selectedModule.id) : -1;
			const hasNextModule = currentIndex !== -1 && currentIndex < moduleIds.length - 1;


			if (!isAuthReady) {
				return (
					<div className="min-h-screen flex items-center justify-center bg-gray-100">
						<div className="loader"></div>
						<p className="text-gray-500 ml-4">Authenticating user...</p>
					</div>
				);
			}

			return (
				<div className="bg-gray-100 min-h-screen font-sans text-gray-900">
					{isPreAssessmentActive ? (
						<PreAssessmentQuiz 
							onComplete={handlePreAssessmentComplete} 
							onExit={() => setIsPreAssessmentActive(false)}
						/>
					) : selectedModule ? (
						<LearningModule
							key={selectedModule.id}
							module={selectedModule}
							onBack={() => setCurrentModuleId(null)}
							progress={progress}
							onProgressUpdate={handleProgressUpdate}
							onNextModule={handleNextModule}
							hasNextModule={hasNextModule}
						/>
					) : (
						<Dashboard 
							onSelectModule={setCurrentModuleId} 
							progress={progress} 
							onResetProgress={handleResetProgress}
							onStartPreAssessment={() => setIsPreAssessmentActive(true)}
						/>
					)}
				</div>
			);
		}

		// --- Render the App into the DOM ---
		const container = document.getElementById('root');
		const root = ReactDOM.createRoot(container);
		root.render(<App />);
	</script>
</body>
</html>
