<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Care Quality & Safety in Nursing</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind CSS configuration
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    keyframes: {
                        'fade-in': {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                    },
                    animation: {
                        'fade-in': 'fade-in 0.3s ease-out forwards',
                    },
                    colors: {
                        brand: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            500: '#14b8a6', // Teal focus for safety
                            600: '#0d9488',
                            700: '#0f766e',
                            900: '#134e4a',
                        }
                    }
                },
            },
        };
    </script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="font-sans antialiased text-gray-900 bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        // --- Mock Authentication Setup ---
        const mockAuth = {
            onAuthStateChanged: (callback) => {
                setTimeout(() => callback({ uid: 'nursing-student-202' }), 100);
                return () => {}; 
            },
            signInAnonymously: () => Promise.resolve({ user: { uid: 'nursing-student-202' } }),
        };

        // --- Content & Data Structure ---
        const contentData = {
            'qs-foundations': {
                title: 'Foundations of Quality & Safety',
                color: 'from-brand-500 to-cyan-500',
                description: 'Define health care quality, explore the STEEEP principles, and identify key regulatory agencies.',
                steps: [
                    { id: 'def-quality', title: 'Defining Quality & Safety', type: 'text', content: `<strong>Health Care Quality:</strong><br>Quality is the degree to which health services for individuals and populations increase the likelihood of desired health outcomes and are consistent with current professional knowledge. It must account for patient preferences, access to service, and cost.<br><br><strong>Safety:</strong><br>Safety is freedom from accidental injuries. Ensuring patient safety involves establishing operational systems and processes that minimize the likelihood of errors and maximizes the likelihood of intercepting them when they occur. Safe care involves making evidence-based clinical decisions to minimize the potential for harm.` },
                    { id: 'steeep', title: 'The STEEEP Principles', type: 'text', content: `High-quality care is defined by six core components (often remembered by the acronym STEEEP):<br><br><strong>1. Safe:</strong> Avoidance of injuries; practicing strictly within standards of care.<br><strong>2. Timely:</strong> Reduction of harmful or frustrating wait times for both those who receive and those who give care.<br><strong>3. Effective:</strong> Offering services most important and addressing the specific needs of the populations served.<br><strong>4. Efficient:</strong> Transitions are coordinated; costs are monitored; length of stay is minimized. Work is done well using fewer resources.<br><strong>5. Equitable:</strong> Providing care that does not vary in quality because of personal characteristics such as gender, ethnicity, geographic location, or socioeconomic status.<br><strong>6. Patient-Centered:</strong> Consideration of individual patient preferences, needs, and values.` },
                    { id: 'agencies', title: 'Regulatory & Advisory Bodies', type: 'text', content: `Nurses must understand the roles of various agencies that dictate and monitor quality and safety standards:<br><br><strong>Regulatory Agencies (Have authority to enforce rules):</strong><br>- CMS (Centers for Medicare and Medicaid Services)<br>- TJC (The Joint Commission)<br>- OSHA (Occupational Safety and Health Administration)<br>- CDC (Centers for Disease Control and Prevention)<br>- FDA, DOJ, and DEA.<br><br><strong>Advisory Bodies (Provide guidelines and research):</strong><br>- National Academy of Medicine (formerly IOM)<br>- ANA (American Nurses Association)<br>- IHI (Institute for Healthcare Improvement)<br>- QSEN (Quality and Safety Education for Nurses)` },
                    { id: 'foundations-quiz', title: 'Foundations Quiz', type: 'quiz',
                        questions: [
                            { question: "Which STEEEP component focuses on providing care that does not vary in quality due to personal characteristics like ethnicity or socioeconomic status?", options: ["Safe", "Effective", "Equitable", "Efficient"], correctAnswer: "Equitable" },
                            { question: "Which of the following is considered a Regulatory Agency with the authority to enforce health care rules?", options: ["The Joint Commission (TJC)", "Institute for Healthcare Improvement (IHI)", "American Nurses Association (ANA)", "Quality and Safety Education for Nurses (QSEN)"], correctAnswer: "The Joint Commission (TJC)" },
                        ]
                    }
                ]
            },
            'qs-errors': {
                title: 'Understanding Errors & Sentinel Events',
                color: 'from-blue-500 to-indigo-600',
                description: 'Differentiate between types of errors, active vs. latent failures, and TJC Sentinel Event Policy.',
                steps: [
                    { id: 'types-of-errors', title: 'Levels and Types of Errors', type: 'text', content: `Errors are a reality in complex healthcare environments. We categorize them to better understand and prevent them:<br><br><strong>Levels of Error:</strong><br>- <strong>Adverse Event:</strong> Unintended harm by an act of commission (doing something wrong) or omission (failing to do the right thing) rather than as a result of the disease process.<br>- <strong>Near Miss:</strong> An error that could have harmed a patient, but harm did not occur as a result of chance (e.g., you notice a wrong dose right before giving it).<br>- <strong>Sentinel Event:</strong> An unexpected occurrence involving death or serious permanent/severe physical or psychological injury.<br><br><strong>Categories of Errors:</strong><br>Diagnostic (delay/failure to test), Treatment (error in administration), Preventive (inadequate monitoring), and <strong>Communication</strong> (the primary cause of most errors).` },
                    { id: 'active-latent', title: 'Active vs. Latent Errors', type: 'text', content: `To fix systems, we must understand where the error originates (Scope of Error):<br><br><strong>Active Errors:</strong><br>These occur at the "Point of Care" by healthcare providers (the "sharp end"). Example: A nurse accidentally programs the IV pump with the wrong rate.<br><br><strong>Latent Errors:</strong><br>These are system or organizational flaws (the "blunt end"). They establish the situation causing the error. Example: Two medications with similar sounding names are packaged in identical vials and stocked next to each other in the medication room. The latent error (poor system design) directly led to the active error.` },
                    { id: 'sentinel-events', title: 'The Sentinel Event Policy', type: 'text', content: `<strong>The Joint Commission (TJC) Sentinel Event Policy:</strong><br>A sentinel event is a patient safety event that reaches a patient and results in death, severe harm, or permanent harm. Examples include wrong-site surgery, infant abduction, inpatient suicide, or severe maternal morbidity.<br><br>When a sentinel event occurs, organizations are expected to:<br>1. Secure the situation and support the patient/family.<br>2. Complete a <strong>Comprehensive Systematic Analysis</strong> (most commonly a Root Cause Analysis or RCA) within 45 days.<br>3. Develop a <strong>Corrective Action Plan</strong> with strong interventions to eliminate system hazards and prevent recurrence.<br><br>The goal is to analyze *systems* (asking "Why?"), not solely focus on individual blame.` },
                    { id: 'errors-quiz', title: 'Errors Quiz', type: 'quiz',
                        questions: [
                            { question: "A nurse draws up a medication but notices it is the wrong dosage right before entering the patient's room and corrects it. What level of error is this?", options: ["Adverse Event", "Sentinel Event", "Near Miss", "Latent Error"], correctAnswer: "Near Miss" },
                            { question: "A hospital policy requires nurses to work 16-hour shifts, leading to extreme fatigue and a subsequent medication error. The 16-hour shift policy represents what scope of error?", options: ["Active Error", "Latent Error", "Diagnostic Error", "Preventive Error"], correctAnswer: "Latent Error" },
                        ]
                    }
                ]
            },
            'qs-culture-improvement': {
                title: 'Culture of Safety & QI',
                color: 'from-emerald-500 to-teal-600',
                description: 'Explore Just Culture, Safety Theories (HROs), and Quality Improvement models.',
                steps: [
                    { id: 'just-culture', title: 'Just Culture & Transparency', type: 'text', content: `<strong>Just Culture (Culture of Safety):</strong><br>A healthcare systemâ€™s greatest value is its ability to report errors without fear of punishment. A "Just Culture" seeks to find a balance between the need to learn from mistakes (system improvements) and the need for disciplinary action against employees (accountability).<br><br>The Marx model addresses consequences by differentiating between:<br>- <em>Human Error:</em> Unintentional slip. (Console the employee)<br>- <em>At-Risk Behavior:</em> Cutting corners or taking unsafe shortcuts. (Coach the employee)<br>- <em>Reckless Behavior:</em> Conscious disregard for a substantial risk. (Discipline the employee)<br><br><strong>Transparency:</strong> Open communication with patients and families is crucial. Disclosure of errors is a key part of transparency and ethical practice.` },
                    { id: 'safety-theories', title: 'Theories of Safety', type: 'text', content: `Three major theories guide safety protocols in healthcare:<br><br><strong>1. Human Factors:</strong> The study of interrelationships among people, technology, and the work environment. It focuses on supporting health professionals and eliminating system hazards (e.g., designing monitors that are easier to read).<br><br><strong>2. Crew Resource Management (CRM):</strong> Originally from aviation. Emphasizes human factors in high-stress environments. Used to improve team functioning and communication in ORs, EDs, and Labor & Delivery.<br><br><strong>3. High Reliability Organizations (HRO):</strong> Organizations that manage hazardous environments with extraordinary safety records. HROs are focused on predicting and preventing errors rather than reacting to them, and they show a high "deference to expertise" (listening to the frontline staff who know the processes best).` },
                    { id: 'qi-models', title: 'Quality Improvement (QI)', type: 'text', content: `Quality Improvement utilizes data to monitor the outcomes of care processes and use improvement methods to design and test changes. <br><br><strong>Four Key Principles of QI:</strong><br>1. Understand the systems and processes.<br>2. Focus on the patients/customers.<br>3. Build the teams.<br>4. Use data to drive decision making.<br><br><strong>Common QI Methods:</strong><br>- <strong>PDSA Cycle:</strong> Plan-Do-Study-Act.<br>- <strong>Six Sigma (DMAIC):</strong> Define, Measure, Analyze, Improve, Control. Focuses on reducing variation and defects.<br>- <strong>Lean:</strong> Focuses on eliminating waste and maximizing value.` },
                    { id: 'culture-quiz', title: 'Culture & QI Quiz', type: 'quiz',
                        questions: [
                            { question: "An organization empowers bedside nurses to speak up about safety concerns and heavily weighs their input when designing new protocols. Which principle of High Reliability Organizations (HROs) does this demonstrate?", options: ["Deference to expertise", "Plan-Do-Study-Act", "At-Risk Behavior", "Focusing on human error"], correctAnswer: "Deference to expertise" },
                            { question: "Under the 'Just Culture' model, how should management respond to an employee who makes an unintentional 'Human Error'?", options: ["Discipline them immediately", "Coach them to avoid cutting corners", "Console them and look for system improvements", "Fire them to maintain high reliability"], correctAnswer: "Console them and look for system improvements" },
                        ]
                    }
                ]
            },
            'qs-communication': {
                title: 'ISBAR & Care Coordination',
                color: 'from-amber-500 to-orange-500',
                description: 'Master ISBAR communication to prevent "Failure to Rescue" (PLO 3.1).',
                steps: [
                    { id: 'ftr-communication', title: 'Communication & Failure to Rescue', type: 'text', content: `Communication is one of the most critical tools in the medical profession. The Joint Commission explicitly identifies communication failures as a primary cause of sentinel events.<br><br><strong>Failure to Rescue (FTR):</strong><br>FTR is an indicator of a hospital's quality of care. It occurs when a patient deteriorates and the healthcare team fails to prevent death or severe harm. FTR includes:<br>- Failure to recognize patient deterioration.<br>- <strong>Failure to communicate concerns.</strong><br>- Failure to diagnose and treat appropriately.<br><br>Standardizing how we talk to each other (e.g., Nurse-to-Physician) prevents vital information from falling through the cracks, satisfying <strong>CLO 3.1</strong> (coordinating safe care with multidisciplinary teams).` },
                    { id: 'isbar-breakdown', title: 'The ISBAR Framework', type: 'text', content: `<strong>ISBAR</strong> is considered a best practice by the Joint Commission for framing critical conversations.<br><br><strong>I - Introduction:</strong> State your name, title, facility, and the unit you are working on.<br><strong>S - Situation:</strong> Clearly and briefly describe the current situation/problem (e.g., "Mrs. Smith is having increasing dyspnea and chest pain").<br><strong>B - Background:</strong> Provide clear, relevant background information (e.g., "She had a total knee replacement two days ago. Current vitals are...").<br><strong>A - Assessment:</strong> State your professional conclusion based on the situation (e.g., "I believe she may be having a pulmonary embolism").<br><strong>R - Recommendation:</strong> Tell the person what you need from them clearly (e.g., "I recommend you see her immediately; should we start O2 stat?").` },
                    { id: 'handoffs', title: '8 Tips for High-Quality Hand-offs', type: 'text', content: `Patient hand-offs (shift change, unit transfer) are high-risk moments. Follow these tips to ensure safety:<br><br>1. Determine critical info to be communicated face-to-face and in writing.<br>2. Standardize tools (like ISBAR or I-PASS).<br>3. Do not rely solely on electronic/paper records; allow time for questions.<br>4. Conduct hand-offs face-to-face in a designated "zone of silence" free from non-emergency interruptions.<br>5. Include all team members, and if appropriate, the patient/family.<br>6. Use Electronic Health Records (EHRs) to *enhance*, not replace, the hand-off (aligns with <strong>CLO 2.1</strong>: Technology to prevent errors).<br>7. Combine information if coming from many sources.<br>8. Ensure minimum info is passed: Allergies, code status, meds, recent vitals, ongoing assessment.` },
                    { id: 'comm-quiz', title: 'Communication Quiz', type: 'quiz',
                        questions: [
                            { question: "During an ISBAR report, the nurse states, 'My assessment is that the patient may be having a cardiac event.' Which letter of ISBAR does this represent?", options: ["S (Situation)", "B (Background)", "A (Assessment)", "R (Recommendation)"], correctAnswer: "A (Assessment)" },
                            { question: "Which of the following is recommended for a high-quality shift hand-off?", options: ["Relying exclusively on the Electronic Health Record so you don't have to talk.", "Conducting the hand-off in a busy hallway to save time.", "Conducting the hand-off face-to-face in an interruption-free zone.", "Letting the patient's family give the clinical report to the receiving nurse."], correctAnswer: "Conducting the hand-off face-to-face in an interruption-free zone." },
                        ]
                    }
                ]
            },
            'qs-case-studies': {
                title: 'Clinical Application & Cases',
                color: 'from-rose-500 to-red-600',
                description: 'Apply Root Cause Analysis and ISBAR to clinical scenarios.',
                steps: [
                    { id: 'case-1-rca', title: 'Case Study: The Insulin Error', type: 'case_study', case: {
                        scenario: `Nurse David is working a chaotic night shift on a busy med-surg unit. He has been mandated to work a double shift. While quickly grabbing medications for a diabetic patient, he opens the medication drawer and pulls a vial of insulin. He draws up 10 units and administers it. <br><br>Twenty minutes later, the patient becomes unresponsive. David realizes he accidentally grabbed a vial of Heparin (a potent blood thinner) which was identical in size, shape, and label color to the insulin, and was placed in the exact adjacent bin in the Pyxis machine by the pharmacy. A Code Blue is called, and the patient is transferred to the ICU with severe hemorrhage (a Sentinel Event).`,
                        question: "During the subsequent Root Cause Analysis (RCA), which of the following is identified as the primary LATENT error that established the situation for this adverse event?",
                        options: [
                            "David drawing up the medication too quickly (Human Error).",
                            "The patient failing to ask what medication they were receiving.",
                            "The pharmacy stocking two look-alike, sound-alike (LASA) medications with identical packaging directly next to each other in the dispensing machine.",
                            "The code blue team arriving too late."
                        ],
                        correctAnswer: "The pharmacy stocking two look-alike, sound-alike (LASA) medications with identical packaging directly next to each other in the dispensing machine.",
                        explanation: "While David made the 'active error' at the point of care, a Root Cause Analysis looks for the blunt-end system failures. The identical packaging and adjacent stocking of two high-alert medications is a classic <strong>latent error</strong>. A strong corrective action plan would involve changing the packaging or separating the bins to prevent this human error from happening again."
                    }},
                    { id: 'case-2-isbar', title: 'Case Study: Midnight ISBAR', type: 'case_study', case: {
                        scenario: `You are caring for Mr. Jones, a 72-year-old admitted for pneumonia. At 0200, his respiratory rate increases to 32, his O2 saturation drops to 84% on room air, and he appears confused. You apply oxygen, but he is still struggling. You know you need to call the on-call physician to prevent a Failure to Rescue.`,
                        question: "Which of the following represents the 'Recommendation' (R) portion of your ISBAR call to the physician?",
                        options: [
                            "Hello Dr. Smith, this is Nurse Alex calling from the Med-Surg unit regarding Mr. Jones in room 412.",
                            "Mr. Jones is highly tachypneic at 32 breaths per minute and his saturation has dropped to 84%.",
                            "He was admitted two days ago for right lower lobe pneumonia and has been stable until now.",
                            "I need you to come to the bedside to evaluate him immediately, and I would like an order for a STAT portable chest X-ray and ABGs."
                        ],
                        correctAnswer: "I need you to come to the bedside to evaluate him immediately, and I would like an order for a STAT portable chest X-ray and ABGs.",
                        explanation: "The Recommendation phase is where you explicitly state what action you need the provider to take. Asking for an immediate bedside evaluation and specific orders (Chest X-ray, ABGs) is a clear, actionable recommendation to stabilize the deteriorating patient."
                    }}
                ]
            }
        };

        const preAssessmentQuizData = [
            { moduleId: 'qs-foundations', question: "What is the primary goal of health care quality as defined in this module?", options: ["To ensure nurses are paid fairly.", "To increase the likelihood of desired health outcomes consistent with current professional knowledge.", "To completely eliminate the need for regulatory agencies.", "To maximize hospital profits."], correctAnswer: "To increase the likelihood of desired health outcomes consistent with current professional knowledge." },
            { moduleId: 'qs-errors', question: "An unexpected occurrence involving death or serious physical/psychological injury (such as wrong-site surgery) is officially defined by The Joint Commission as a:", options: ["Near Miss", "Latent Defect", "Sentinel Event", "At-Risk Behavior"], correctAnswer: "Sentinel Event" },
            { moduleId: 'qs-culture-improvement', question: "According to Just Culture principles, how should an organization handle an employee who engages in 'reckless behavior' (conscious disregard for a substantial risk)?", options: ["Console them", "Promote them", "Coach them", "Discipline them"], correctAnswer: "Discipline them" },
            { moduleId: 'qs-communication', question: "In the ISBAR communication framework, what does the 'B' stand for?", options: ["Behavior", "Background", "Bedside", "Basic Needs"], correctAnswer: "Background" },
            { moduleId: 'qs-errors', question: "Which type of error occurs at the blunt end of care (organizational or system level) and establishes the situation that causes an accident?", options: ["Latent Error", "Active Error", "Diagnostic Error", "Point-of-Care Error"], correctAnswer: "Latent Error" }
        ];

        // --- Helper Functions ---
        const cn = (...classes) => classes.filter(Boolean).join(' ');

        // --- Components ---

        const Quiz = ({ questions, onComplete, isPreAssessment = false }) => {
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [selectedOption, setSelectedOption] = useState(null);
            const [feedback, setFeedback] = useState(null);
            const [answers, setAnswers] = useState([]);

            const currentQuestion = questions[currentQuestionIndex];

            const handleOptionSelect = (option) => {
                if (feedback && !isPreAssessment) return;
                setSelectedOption(option);
            };

            const handlePreAssessmentNext = () => {
                if (selectedOption === null) return;
                const isCorrect = selectedOption.toLowerCase() === currentQuestion.correctAnswer.toLowerCase();
                const updatedAnswers = [...answers, { question: currentQuestion, isCorrect }];
                setAnswers(updatedAnswers);

                if (currentQuestionIndex < questions.length - 1) {
                    setCurrentQuestionIndex(currentQuestionIndex + 1);
                    setSelectedOption(null);
                } else {
                    onComplete(updatedAnswers);
                }
            };
            
            const handleRegularQuizSubmit = () => {
                if (selectedOption === null) return;
                const isCorrect = selectedOption.toLowerCase() === currentQuestion.correctAnswer.toLowerCase();
                setFeedback(isCorrect ? 'correct' : 'incorrect');
            };

            const handleRegularQuizNext = () => {
                const isCorrect = selectedOption.toLowerCase() === currentQuestion.correctAnswer.toLowerCase();
                const finalAnswers = [...answers, { question: currentQuestion, isCorrect }];
                
                if (currentQuestionIndex < questions.length - 1) {
                    setAnswers(finalAnswers);
                    setCurrentQuestionIndex(currentQuestionIndex + 1);
                    setSelectedOption(null);
                    setFeedback(null);
                } else {
                    const finalScore = finalAnswers.reduce((acc, ans) => acc + (ans.isCorrect ? 1 : 0), 0);
                    onComplete({ score: finalScore, total: questions.length });
                }
            };

            return (
                <div className="p-5 md:p-8 bg-white border border-gray-100 rounded-2xl shadow-sm">
                    <div className="flex justify-between items-center mb-6">
                        <h4 className="font-bold text-lg text-brand-700">Knowledge Check</h4>
                        <span className="text-sm font-medium text-gray-500">Question {currentQuestionIndex + 1} of {questions.length}</span>
                    </div>
                    <p className="font-semibold text-xl text-gray-800 mb-6 leading-snug">{currentQuestion.question}</p>
                    <div className="space-y-3">
                        {currentQuestion.options.map((option, index) => {
                            const isSelected = selectedOption === option;
                            const isCorrectOption = option.toLowerCase() === currentQuestion.correctAnswer.toLowerCase();
                            let optionClass = 'bg-gray-50 hover:bg-gray-100 border-gray-200 text-gray-700';

                            if (feedback && !isPreAssessment) {
                                if (isCorrectOption) {
                                    optionClass = 'bg-emerald-50 border-emerald-500 text-emerald-800 shadow-sm';
                                } else if (isSelected && !isCorrectOption) {
                                    optionClass = 'bg-rose-50 border-rose-500 text-rose-800';
                                }
                            } else if (isSelected) {
                                optionClass = 'bg-brand-50 border-brand-500 text-brand-800 shadow-sm';
                            }

                            return (
                                <div
                                    key={index}
                                    onClick={() => handleOptionSelect(option)}
                                    className={cn('p-4 rounded-xl border-2 cursor-pointer transition-all duration-200', optionClass)}
                                >
                                    <div className="flex items-center">
                                        {feedback && !isPreAssessment && (isCorrectOption || (isSelected && !isCorrectOption)) && (
                                            isCorrectOption ? 
                                            <svg className="w-6 h-6 text-emerald-500 mr-3 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" /></svg> : 
                                            <svg className="w-6 h-6 text-rose-500 mr-3 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                        )}
                                        <span className="flex-1 text-base">{option}</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    <div className="mt-8 flex justify-end">
                        {isPreAssessment ? (
                             <button
                                onClick={handlePreAssessmentNext}
                                disabled={selectedOption === null}
                                className="px-8 py-3 bg-brand-600 text-white font-semibold rounded-xl shadow-md hover:bg-brand-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                            >
                                {currentQuestionIndex < questions.length - 1 ? 'Next Question' : 'Finish Assessment'}
                            </button>
                        ) : (
                            <>
                            {!feedback ? (
                                <button
                                    onClick={handleRegularQuizSubmit}
                                    disabled={selectedOption === null}
                                    className="px-8 py-3 bg-brand-600 text-white font-semibold rounded-xl shadow-md hover:bg-brand-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                >
                                    Submit Answer
                                </button>
                            ) : (
                                <button
                                    onClick={handleRegularQuizNext}
                                    className="px-8 py-3 bg-brand-600 text-white font-semibold rounded-xl shadow-md hover:bg-brand-700 transition-colors flex items-center gap-2"
                                >
                                    {currentQuestionIndex < questions.length - 1 ? 'Next Question' : 'Finish Quiz'}
                                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7" /></svg>
                                </button>
                            )}
                            </>
                        )}
                    </div>
                </div>
            );
        };
        
        const PreAssessmentQuiz = ({ onComplete, onExit }) => {
            const [results, setResults] = useState(null);

            const handleQuizComplete = (finalAnswers) => {
                const moduleResults = {};
                finalAnswers.forEach(answer => {
                    const { moduleId } = answer.question;
                    if (!moduleResults[moduleId]) {
                        moduleResults[moduleId] = { correct: 0, total: 0 };
                    }
                    if (answer.isCorrect) {
                        moduleResults[moduleId].correct++;
                    }
                    moduleResults[moduleId].total++;
                });

                const completedModules = [];
                for (const moduleId in moduleResults) {
                    if (moduleResults[moduleId].correct === moduleResults[moduleId].total) {
                        completedModules.push(moduleId);
                    }
                }
                setResults({ completedModules, total: finalAnswers.length, correct: finalAnswers.filter(a => a.isCorrect).length });
                onComplete(completedModules);
            };

            if (results) {
                return (
                    <div className="fixed inset-0 bg-gray-50 flex items-center justify-center z-40 p-4 animate-fade-in">
                        <div className="bg-white rounded-3xl shadow-xl p-8 max-w-2xl w-full text-center border border-gray-100">
                            <div className="w-20 h-20 bg-brand-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                <svg className="w-10 h-10 text-brand-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            </div>
                            <h2 className="text-3xl font-bold text-gray-800 mb-4">Assessment Complete!</h2>
                            <p className="text-lg text-gray-600 mb-8">
                                You correctly answered <span className="font-bold text-brand-600">{results.correct}</span> out of {results.total} questions.
                            </p>
                            
                            {results.completedModules.length > 0 ? (
                                <div className="mb-8">
                                    <p className="text-emerald-700 font-semibold mb-4 text-left">You've demonstrated mastery in these areas and they have been marked complete:</p>
                                    <ul className="list-disc list-inside text-left bg-emerald-50 border border-emerald-100 p-5 rounded-xl text-emerald-800">
                                        {results.completedModules.map(id => <li key={id} className="mb-1">{contentData[id].title}</li>)}
                                    </ul>
                                </div>
                            ) : (
                                <div className="mb-8 bg-amber-50 border border-amber-100 p-5 rounded-xl">
                                    <p className="text-amber-800 font-semibold">Great effort! We recommend reviewing all modules to build a strong foundation in Quality and Safety.</p>
                                </div>
                            )}
                            <button
                                onClick={onExit}
                                className="px-8 py-3 bg-brand-600 text-white font-bold rounded-xl shadow-md hover:bg-brand-700 transition-colors w-full sm:w-auto"
                            >
                                Enter Learning Dashboard
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="fixed inset-0 bg-gray-50 flex items-center justify-center z-40 p-4 overflow-y-auto">
                    <div className="max-w-3xl w-full py-8">
                        <div className="text-center mb-8">
                            <h2 className="text-3xl font-bold text-gray-800">Diagnostic Assessment</h2>
                            <p className="text-gray-500 mt-2">Let's see what you already know about Quality and Safety in Healthcare.</p>
                        </div>
                        <Quiz questions={preAssessmentQuizData} onComplete={handleQuizComplete} isPreAssessment={true} />
                    </div>
                </div>
            );
        };

        const Dashboard = ({ onSelectModule, progress, onResetProgress, onStartPreAssessment }) => {
            let totalCompletedSteps = 0;
            let totalPossibleSteps = 0;

            Object.entries(contentData).forEach(([moduleId, module]) => {
                totalPossibleSteps += module.steps.length;
                const moduleProgress = progress[moduleId] || {};
                Object.values(moduleProgress).forEach(stepProgress => {
                    if (stepProgress.completed) totalCompletedSteps++;
                });
            });

            const overallPercentage = totalPossibleSteps > 0 ? (totalCompletedSteps / totalPossibleSteps) * 100 : 0;

            return (
                <div className="max-w-7xl mx-auto p-4 sm:p-6 md:p-8 min-h-screen w-full flex flex-col">
                    <header className="mb-10 text-center mt-4">
                        <div className="inline-flex items-center justify-center gap-3 mb-4 bg-white px-6 py-2 rounded-full shadow-sm border border-gray-100">
                            <svg className="w-6 h-6 text-brand-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <span className="text-sm font-bold tracking-widest text-brand-800 uppercase">NURS 400 Core Module 5</span>
                        </div>
                        <h1 className="text-4xl sm:text-5xl font-extrabold text-gray-900 tracking-tight mb-4">Health Care Quality & Safety</h1>
                        <p className="text-lg text-gray-600 max-w-2xl mx-auto leading-relaxed">Master the core principles of the safe patient care movement, understand system errors, and practice effective interprofessional communication.</p>
                    </header>

                    {overallPercentage === 0 && (
                        <div className="mb-10 flex justify-center">
                            <button
                                onClick={onStartPreAssessment}
                                className="group relative px-8 py-4 bg-gray-900 text-white font-bold rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 overflow-hidden"
                            >
                                <div className="absolute inset-0 bg-gradient-to-r from-brand-500 to-blue-500 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                                <div className="relative flex items-center gap-3">
                                    <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                                    <span className="text-lg">Take Diagnostic Quiz to Skip Ahead</span>
                                </div>
                            </button>
                        </div>
                    )}

                    <div className="mb-10 bg-white rounded-3xl shadow-sm border border-gray-100 p-6 sm:p-8">
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <div>
                                <h3 className="text-xl font-bold text-gray-900">Course Progress</h3>
                                <p className="text-sm text-gray-500">{totalCompletedSteps} of {totalPossibleSteps} activities completed</p>
                            </div>
                            {overallPercentage > 0 && (
                                <button onClick={onResetProgress} className="text-sm text-rose-500 hover:text-rose-700 font-medium transition-colors flex items-center gap-1 bg-rose-50 px-3 py-1.5 rounded-lg">
                                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                    Reset Progress
                                </button>
                            )}
                        </div>
                        <div className="w-full bg-gray-100 rounded-full h-3 overflow-hidden">
                            <div
                                className="bg-gradient-to-r from-brand-500 to-indigo-500 h-full rounded-full transition-all duration-700 ease-out"
                                style={{ width: `${overallPercentage}%` }}
                            ></div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-6 sm:gap-8">
                        {Object.entries(contentData).map(([id, module]) => {
                            const moduleProgress = progress[id] || {};
                            const completedCount = Object.values(moduleProgress).filter(p => p.completed).length;
                            const totalSteps = module.steps.length;
                            const percentage = totalSteps > 0 ? (completedCount / totalSteps) * 100 : 0;
                            const isCompleted = completedCount === totalSteps;

                            return (
                                <div
                                    key={id}
                                    onClick={() => onSelectModule(id)}
                                    className={cn(
                                        "bg-white rounded-3xl border transition-all duration-300 cursor-pointer group flex flex-col overflow-hidden relative",
                                        isCompleted ? "border-emerald-200 shadow-md hover:shadow-lg" : "border-gray-200 shadow-sm hover:shadow-xl hover:-translate-y-1 hover:border-brand-300"
                                    )}
                                >
                                    <div className={cn("h-2 w-full bg-gradient-to-r", module.color)}></div>
                                    <div className="p-6 sm:p-8 flex flex-col h-full relative z-10">
                                        <div className="flex justify-between items-start mb-6">
                                            <div className={cn("p-4 rounded-2xl bg-gradient-to-br text-white shadow-md", module.color)}>
                                                <svg className="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    {id === 'qs-foundations' && <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />}
                                                    {id === 'qs-errors' && <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />}
                                                    {id === 'qs-culture-improvement' && <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />}
                                                    {id === 'qs-communication' && <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" />}
                                                    {id === 'qs-case-studies' && <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />}
                                                </svg>
                                            </div>
                                            {isCompleted ? (
                                                <div className="flex items-center gap-1 text-emerald-600 bg-emerald-50 px-3 py-1 rounded-full text-sm font-bold">
                                                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" /></svg>
                                                    Done
                                                </div>
                                            ) : (
                                                <div className="relative w-12 h-12">
                                                    <svg className="w-full h-full transform -rotate-90" viewBox="0 0 36 36">
                                                        <path className="text-gray-100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="3" />
                                                        <path className="text-brand-500" strokeDasharray={`${percentage}, 100`} d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="3" />
                                                    </svg>
                                                    <span className="absolute inset-0 flex items-center justify-center text-xs font-bold text-gray-700">{Math.round(percentage)}%</span>
                                                </div>
                                            )}
                                        </div>
                                        <h3 className="text-2xl font-bold text-gray-900 mb-3">{module.title}</h3>
                                        <p className="text-gray-600 text-sm mb-6 flex-grow leading-relaxed">{module.description}</p>
                                        
                                        <div className="mt-auto flex items-center justify-between text-brand-600 font-semibold group-hover:text-brand-800">
                                            <span>{isCompleted ? 'Review Module' : 'Start Learning'}</span>
                                            <svg className="w-5 h-5 transition-transform group-hover:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                                        </div>
                                    </div>
                                    {isCompleted && <div className="absolute inset-0 bg-emerald-50 opacity-10 pointer-events-none"></div>}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const CaseStudy = ({ caseData, onComplete }) => {
            const [selectedAnswer, setSelectedAnswer] = useState(null);

            const handleSelect = (option) => {
                if (selectedAnswer) return;
                setSelectedAnswer(option);
                if (option.toLowerCase() === caseData.correctAnswer.toLowerCase()) {
                    onComplete();
                }
            };

            return (
                <div className="bg-white border border-gray-100 rounded-2xl shadow-sm overflow-hidden">
                    <div className="bg-amber-50 border-b border-amber-100 p-6 md:p-8">
                        <div className="flex items-center gap-3 mb-4">
                            <svg className="w-6 h-6 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            <h4 className="font-bold text-xl text-amber-900">Clinical Scenario</h4>
                        </div>
                        <p className="text-amber-900 leading-relaxed text-lg" dangerouslySetInnerHTML={{ __html: caseData.scenario }}></p>
                    </div>
                    <div className="p-6 md:p-8">
                        <p className="font-bold text-xl text-gray-800 mb-6">{caseData.question}</p>
                        <div className="space-y-3">
                            {caseData.options.map((option, idx) => {
                                const isSelected = selectedAnswer === option;
                                const isCorrect = option.toLowerCase() === caseData.correctAnswer.toLowerCase();
                                const showFeedback = selectedAnswer !== null;

                                let optionClass = 'bg-gray-50 hover:bg-gray-100 border-gray-200 text-gray-700';
                                if (showFeedback) {
                                    if (isCorrect) optionClass = 'bg-emerald-50 border-emerald-500 text-emerald-800';
                                    else if (isSelected && !isCorrect) optionClass = 'bg-rose-50 border-rose-500 text-rose-800';
                                } else if (isSelected) {
                                    optionClass = 'bg-brand-50 border-brand-500 text-brand-800';
                                }

                                return (
                                    <div
                                        key={idx}
                                        onClick={() => handleSelect(option)}
                                        className={cn('p-4 rounded-xl border-2 cursor-pointer transition-all duration-200', optionClass)}
                                    >
                                        <div className="flex items-center">
                                            {showFeedback && (
                                                isCorrect ? <svg className="w-6 h-6 text-emerald-500 mr-3 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" /></svg> : 
                                                (isSelected && <svg className="w-6 h-6 text-rose-500 mr-3 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>)
                                            )}
                                            <span className="flex-1 text-base font-medium">{option}</span>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        {selectedAnswer && (
                            <div className="mt-8 p-6 bg-brand-50 rounded-xl border border-brand-100 animate-fade-in">
                                <div className="flex items-center gap-2 mb-3">
                                    <svg className="w-5 h-5 text-brand-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                    <h5 className="font-bold text-brand-900 text-lg">Instructor Rationale</h5>
                                </div>
                                <p className="text-base text-brand-800 leading-relaxed" dangerouslySetInnerHTML={{ __html: caseData.explanation }}></p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const StaticContentStep = ({ step, onComplete }) => {
            useEffect(() => {
                onComplete();
            }, []);

            return (
                <div className="prose prose-lg max-w-none prose-headings:text-gray-800 prose-p:text-gray-600 prose-strong:text-gray-900 prose-li:text-gray-600 bg-white p-6 md:p-10 rounded-2xl shadow-sm border border-gray-100">
                    <div dangerouslySetInnerHTML={{ __html: step.content }} />
                </div>
            );
        };

        const CompletionModal = ({ isOpen, onClose, onNextModule, hasNextModule }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center transform animate-fade-in border border-gray-100">
                        <div className="w-24 h-24 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <svg className="w-12 h-12 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </div>
                        <h3 className="text-3xl font-bold text-gray-900 mb-4">Module Mastered!</h3>
                        <p className="text-lg text-gray-600 mb-8">Excellent work. You've successfully completed all activities in this section.</p>
                        <div className="flex flex-col gap-3">
                            {hasNextModule ? (
                                <>
                                <button
                                    onClick={onNextModule}
                                    className="px-6 py-4 bg-brand-600 text-white text-lg font-bold rounded-xl shadow-md hover:bg-brand-700 transition-colors w-full"
                                >
                                    Continue to Next Module
                                </button>
                                <button
                                    onClick={onClose}
                                    className="px-6 py-4 bg-gray-50 text-gray-700 text-lg font-bold rounded-xl hover:bg-gray-100 transition-colors w-full"
                                >
                                    Back to Dashboard
                                </button>
                                </>
                            ) : (
                                <button
                                    onClick={onClose}
                                    className="px-6 py-4 bg-brand-600 text-white text-lg font-bold rounded-xl shadow-md hover:bg-brand-700 transition-colors w-full"
                                >
                                    Return to Dashboard
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const LearningModule = ({ module, onBack, progress, onProgressUpdate, onNextModule, hasNextModule }) => {
            const [activeStep, setActiveStep] = useState(0);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [isCompletionModalOpen, setIsCompletionModalOpen] = useState(false);

            const handleStepComplete = useCallback((stepId, data = {}) => {
                onProgressUpdate(module.id, stepId, { completed: true, ...data });
            }, [onProgressUpdate, module.id]);

            const moduleProgress = progress[module.id] || {};
            const allStepsCompletedInModule = module.steps.every(step => moduleProgress[step.id]?.completed);

            const handleNextStep = () => {
                if (activeStep === module.steps.length - 1 && allStepsCompletedInModule) {
                    setIsCompletionModalOpen(true);
                } else if (activeStep < module.steps.length - 1) {
                    setActiveStep(activeStep + 1);
                }
            };

            const handlePrevStep = () => {
                if (activeStep > 0) setActiveStep(activeStep - 1);
            };

            const currentStep = module.steps[activeStep];

            const renderStepContent = (step) => {
                if (!step) return null;
                const onCompleteForStep = (data) => handleStepComplete(step.id, data);
                switch (step.type) {
                    case 'text': return <StaticContentStep key={step.id} step={step} onComplete={onCompleteForStep} />;
                    case 'case_study': return <CaseStudy key={step.id} caseData={step.case} onComplete={onCompleteForStep} />;
                    case 'quiz': return <Quiz key={step.id} questions={step.questions} onComplete={onCompleteForStep} />;
                    default: return <p>Unknown step type.</p>;
                }
            };

            return (
                <div className="fixed inset-0 bg-gray-50 flex flex-col z-20">
                    <header className="bg-white border-b border-gray-200 px-4 h-16 flex items-center justify-between z-30 flex-shrink-0">
                        <div className="flex items-center w-1/3">
                            <button onClick={onBack} className="flex items-center gap-2 text-gray-500 hover:text-gray-900 transition-colors py-2 px-3 rounded-lg hover:bg-gray-100 -ml-2">
                                <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                                <span className="hidden sm:inline font-medium text-sm">Dashboard</span>
                            </button>
                        </div>
                        <div className="flex-1 text-center truncate px-4">
                            <h2 className="text-lg font-bold text-gray-900 truncate">{module.title}</h2>
                        </div>
                        <div className="flex items-center justify-end w-1/3">
                            <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="lg:hidden p-2 rounded-lg text-gray-500 hover:bg-gray-100 transition-colors">
                                <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                            </button>
                        </div>
                    </header>

                    {isSidebarOpen && <div onClick={() => setIsSidebarOpen(false)} className="fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-40 lg:hidden"></div>}
                    
                    <div className="flex flex-1 overflow-hidden relative">
                        {/* Sidebar Navigation */}
                        <aside className={cn(
                            "bg-white border-r border-gray-200 w-80 flex-shrink-0 flex flex-col transition-transform duration-300 ease-in-out absolute lg:static h-full z-50 lg:translate-x-0 shadow-2xl lg:shadow-none",
                            isSidebarOpen ? 'translate-x-0' : '-translate-x-full'
                        )}>
                            <div className="p-6 border-b border-gray-100">
                                <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Learning Path</h3>
                                <p className="text-gray-900 font-semibold">{module.title}</p>
                            </div>
                            <nav className="p-4 space-y-2 overflow-y-auto flex-1">
                                {module.steps.map((step, index) => {
                                    const isCompleted = moduleProgress[step.id]?.completed;
                                    const isActive = activeStep === index;
                                    
                                    return (
                                        <button
                                            key={step.id}
                                            onClick={() => { setActiveStep(index); setIsSidebarOpen(false); }}
                                            className={cn(
                                                'w-full text-left p-4 rounded-xl flex items-start gap-4 transition-all duration-200',
                                                isActive ? 'bg-brand-50 border border-brand-200 shadow-sm' : 'hover:bg-gray-50 border border-transparent'
                                            )}
                                        >
                                            <div className="mt-0.5 w-6 h-6 flex-shrink-0 flex items-center justify-center">
                                                {isCompleted ? (
                                                    <div className="w-6 h-6 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center">
                                                        <svg className="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" /></svg>
                                                    </div>
                                                ) : (
                                                    <div className={cn("w-6 h-6 rounded-full border-2 flex items-center justify-center text-xs font-bold", isActive ? "border-brand-600 text-brand-600" : "border-gray-300 text-gray-400")}>
                                                        {index + 1}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex-1">
                                                <span className={cn("block text-sm font-medium", isActive ? "text-brand-900" : "text-gray-700")}>{step.title}</span>
                                                <span className="text-xs text-gray-400 mt-1 uppercase tracking-wider font-semibold">{step.type.replace('_', ' ')}</span>
                                            </div>
                                        </button>
                                    );
                                })}
                            </nav>
                        </aside>

                        {/* Main Content Area */}
                        <main className="flex-1 overflow-y-auto scroll-smooth">
                            <div className="max-w-4xl mx-auto p-4 sm:p-8 pb-32">
                                <div className="mb-8">
                                    <span className="inline-block px-3 py-1 bg-gray-100 text-gray-600 text-xs font-bold uppercase tracking-wider rounded-full mb-3">
                                        Step {activeStep + 1} of {module.steps.length}
                                    </span>
                                    <h3 className="text-3xl md:text-4xl font-extrabold text-gray-900 tracking-tight">{currentStep.title}</h3>
                                </div>
                                
                                {renderStepContent(currentStep)}

                                <div className="flex flex-col sm:flex-row justify-between items-center gap-4 mt-12 pt-8 border-t border-gray-200">
                                    <button
                                        onClick={handlePrevStep}
                                        disabled={activeStep === 0}
                                        className="w-full sm:w-auto px-6 py-3 bg-white border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed transition-colors"
                                    >
                                        Previous Step
                                    </button>

                                    <button
                                        onClick={handleNextStep}
                                        disabled={activeStep === module.steps.length - 1 && !allStepsCompletedInModule}
                                        className="w-full sm:w-auto px-8 py-3 bg-brand-600 text-white font-bold rounded-xl shadow-md hover:bg-brand-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2"
                                    >
                                        {activeStep === module.steps.length - 1 ? 'Complete Module' : 'Continue to Next Step'}
                                        {activeStep !== module.steps.length - 1 && <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>}
                                    </button>
                                </div>
                            </div>
                        </main>
                    </div>
                    
                    <CompletionModal
                        isOpen={isCompletionModalOpen}
                        onClose={() => { setIsCompletionModalOpen(false); onBack(); }}
                        onNextModule={() => { setIsCompletionModalOpen(false); onNextModule(); }}
                        hasNextModule={hasNextModule}
                    />
                </div>
            );
        };

        function App() {
            const [currentModuleId, setCurrentModuleId] = useState(null);
            const [isPreAssessmentActive, setIsPreAssessmentActive] = useState(false);
            const [userId, setUserId] = useState(null);
            const [progress, setProgress] = useState({});
            const [isAuthReady, setIsAuthReady] = useState(false);

            useEffect(() => {
                const unsubscribe = mockAuth.onAuthStateChanged((user) => {
                    if (user) setUserId(user.uid);
                    setIsAuthReady(true);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!isAuthReady || !userId) return;
                const storedProgress = localStorage.getItem(`nursing-quality-safety-${userId}`);
                if (storedProgress) {
                    try { setProgress(JSON.parse(storedProgress)); } 
                    catch (e) { setProgress({}); }
                }
            }, [isAuthReady, userId]);

            const handleProgressUpdate = useCallback((moduleId, stepId, data = {}) => {
                if (!isAuthReady || !userId) return;
                setProgress(currentProgress => {
                    const currentStepProgress = currentProgress[moduleId]?.[stepId] || {};
                    const newStepProgress = { ...currentStepProgress, ...data };
                    if (JSON.stringify(currentStepProgress) === JSON.stringify(newStepProgress)) return currentProgress;
                    const newProgress = { ...currentProgress, [moduleId]: { ...(currentProgress[moduleId] || {}), [stepId]: newStepProgress } };
                    localStorage.setItem(`nursing-quality-safety-${userId}`, JSON.stringify(newProgress));
                    return newProgress;
                });
            }, [isAuthReady, userId]);

            const handlePreAssessmentComplete = (completedModuleIds) => {
                const newProgress = { ...progress };
                completedModuleIds.forEach(moduleId => {
                    const module = contentData[moduleId];
                    if (module) {
                        newProgress[moduleId] = {};
                        module.steps.forEach(step => { newProgress[moduleId][step.id] = { completed: true }; });
                    }
                });
                setProgress(newProgress);
                localStorage.setItem(`nursing-quality-safety-${userId}`, JSON.stringify(newProgress));
            };

            const handleResetProgress = useCallback(() => {
                if (!isAuthReady || !userId) return;
                setProgress({});
                localStorage.removeItem(`nursing-quality-safety-${userId}`);
            }, [isAuthReady, userId]);

            const handleNextModule = useCallback(() => {
                const moduleIds = Object.keys(contentData);
                const currentIndex = moduleIds.indexOf(currentModuleId);
                if (currentIndex !== -1 && currentIndex < moduleIds.length - 1) {
                    setCurrentModuleId(moduleIds[currentIndex + 1]);
                } else {
                    setCurrentModuleId(null);
                }
            }, [currentModuleId]);

            const selectedModule = currentModuleId && contentData[currentModuleId] ? { ...contentData[currentModuleId], id: currentModuleId } : null;
            const moduleIds = Object.keys(contentData);
            const currentIndex = selectedModule ? moduleIds.indexOf(selectedModule.id) : -1;
            const hasNextModule = currentIndex !== -1 && currentIndex < moduleIds.length - 1;

            if (!isAuthReady) return <div className="min-h-screen flex items-center justify-center bg-gray-50"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-brand-600"></div></div>;

            return (
                <div className="bg-gray-50 min-h-screen font-sans text-gray-900 selection:bg-brand-200 selection:text-brand-900">
                    {isPreAssessmentActive ? (
                        <PreAssessmentQuiz onComplete={handlePreAssessmentComplete} onExit={() => setIsPreAssessmentActive(false)} />
                    ) : selectedModule ? (
                        <LearningModule
                            key={selectedModule.id}
                            module={selectedModule}
                            onBack={() => setCurrentModuleId(null)}
                            progress={progress}
                            onProgressUpdate={handleProgressUpdate}
                            onNextModule={handleNextModule}
                            hasNextModule={hasNextModule}
                        />
                    ) : (
                        <Dashboard 
                            onSelectModule={setCurrentModuleId} 
                            progress={progress} 
                            onResetProgress={handleResetProgress}
                            onStartPreAssessment={() => setIsPreAssessmentActive(true)}
                        />
                    )}
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
