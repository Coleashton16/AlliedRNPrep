<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urinary Elimination and Renal Function Module</title>

    <!-- Tailwind CSS with Inter font -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    keyframes: {
                        'fade-in': { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        'scale-in': { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        'spin': { 'to': { transform: 'rotate(360deg)' } }
                    },
                    animation: {
                        'fade-in': 'fade-in 0.5s ease-out forwards',
                        'scale-in': 'scale-in 0.3s ease-out forwards',
                        'spin': 'spin 1s linear infinite'
                    },
                },
            },
        };
    </script>
    <!-- React and Babel for JSX -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Make Firebase instances globally available for the main React app
        window.firebase = {
            app: null,
            db: null,
            auth: null,
            firestore: {
                doc, setDoc, getDoc, onSnapshot, collection, query, writeBatch, deleteDoc
            }
        };

        // Initialize Firebase
        if (Object.keys(firebaseConfig).length) {
            setLogLevel('debug'); // For debugging in the console
            window.firebase.app = initializeApp(firebaseConfig);
            window.firebase.auth = getAuth(window.firebase.app);
            window.firebase.db = getFirestore(window.firebase.app);
        }

        // Handle authentication
        window.firebaseAuthReady = new Promise((resolve, reject) => {
            const auth = window.firebase.auth;
            if (auth) {
                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken)
                        .then(() => resolve(auth.currentUser.uid))
                        .catch(error => {
                            console.error("Firebase custom token sign-in failed:", error);
                            signInAnonymously(auth).then(userCredential => resolve(userCredential.user.uid)).catch(reject);
                        });
                } else {
                    signInAnonymously(auth)
                        .then(userCredential => resolve(userCredential.user.uid))
                        .catch(reject);
                }
            } else {
                reject("Firebase Auth not initialized.");
            }
        });
    </script>
</head>
<body class="font-sans antialiased text-gray-900 bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        const contentData = {
            'elimination-concepts': {
                title: 'Elimination Concepts: The Foundation',
                // Icon representing the kidney with a liquid droplet, a more accurate visual
                icon: (
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-kidneys"><path d="M2 13h20M7 21a5 5 0 0 1-5-5M17 21a5 5 0 0 0 5-5M12 21a5 5 0 0 0-5-5"/><path d="M12 3v13"/></svg>
                ),
                color: 'from-blue-500 to-indigo-600',
                description: 'Understand the fundamental concepts of urinary elimination, from basic anatomy to patient assessment.',
                steps: [
                    { id: 'module-goals', title: 'Introduction & Module Goals', type: 'text', content: `As nurses, we know that elimination is a fundamental process for life. It's the body's way of ridding itself of waste products and excess fluid. Without proper elimination, these waste products build up, creating a toxic environment that can harm every organ system in the body. This module focuses on the <strong>urinary system</strong>, the body's primary filter. <br><br>Our learning objectives for this module are to:<br><ul><li><strong>Define</strong> and describe the concept of urinary elimination.</li><li><strong>Identify</strong> risk factors for elimination problems.</li><li><strong>Recognize</strong> clinical cues and symptoms of impaired elimination.</li><li><strong>Plan, implement, and evaluate</strong> appropriate nursing and collaborative interventions.</li></ul>` },
                    { id: 'anatomy-physiology', title: 'Anatomy & Physiology of Elimination', type: 'text', content: `To understand problems, we must first understand the normal process. The urinary system is a beautifully designed filtration and elimination pathway.<br><br>
                    <ul>
                        <li><strong>Urinary Elimination</strong> is the process of passing urine out of the urinary tract through the urinary sphincter and urethra.</li>
                        <li><strong>The Kidneys</strong> are the main organs of filtration. They filter wastes and excess fluids from the blood. The core functional unit of the kidney is the <strong>nephron</strong>, a microscopic structure responsible for this filtration. The <strong>glomerulus</strong> within the nephron is a network of capillaries where blood is initially filtered. 



[Image of kidney anatomy and nephron]

</li>
                        <li><strong>The Bladder</strong> stores the urine produced by the kidneys.</li>
                        <li><strong>The Urethra</strong> is the tube through which urine exits the body.</li>
                        <li><strong>Sphincters</strong> (internal and external) are muscles that control the flow of urine.</li>
                    </ul><br>
                    <strong>Pathophysiology: When Things Go Wrong</strong><br>
                    Urinary elimination problems can manifest in two primary ways:
                    <ul>
                        <li><strong>Urinary Incontinence:</strong> The involuntary release of urine.</li>
                        <li><strong>Urinary Retention:</strong> The inability to fully empty the bladder, which can lead to overflow incontinence and kidney damage.</li>
                    </ul>` },
                    { id: 'risk-factors-assessment', title: 'Risk Factors & Nursing Assessment', type: 'text', content: `Noticing a problem is the first step in the nursing process. This requires a sharp eye for both subjective and objective cues.<br><br>
                    <strong>Risk Factors:</strong><br>
                    While all individuals are at risk, certain populations are more vulnerable.
                    <ul>
                        <li><strong>Children:</strong> Still developing bladder control.</li>
                        <li><strong>Pregnant Women:</strong> Increased pressure on the bladder from the growing fetus.</li>
                        <li><strong>Older Adults:</strong> Normal aging leads to decreased kidney function, reduced bladder capacity, and weakened sphincter muscles. Men are particularly at risk due to a common age-related condition called <strong>Benign Prostatic Hyperplasia (BPH)</strong>, which can obstruct urine flow.</li>
                    </ul><br>
                    <strong>Assessment: Subjective & Objective Cues:</strong><br>
                    A comprehensive nursing assessment is key.<br>
                    <strong>Subjective Assessment (What the patient tells you):</strong>
                    <ul>
                        <li><strong>Intake & Output (I&O):</strong> Ask about their fluid intake and how often they urinate.</li>
                        <li><strong>Nutritional Habits:</strong> Diet impacts fluid balance and waste production.</li>
                        <li><strong>Symptoms:</strong> Are they experiencing pain or burning with urination (dysuria)? Is there an urgency or frequency? Do they feel like they can't empty their bladder completely?</li>
                        <li><strong>Knowledge & Coping:</strong> How does this problem affect their daily life and emotional well-being?</li>
                    </ul>
                    <strong>Objective Assessment (What you observe):</strong>
                    <ul>
                        <li><strong>Fluid Status:</strong> Assess for signs of fluid overload or dehydration, such as weight changes, skin turgor, edema, and vital signs.</li>
                        <li><strong>Urinary Output:</strong> Measure and document hourly urine output. Normal urine output is generally 30 mL/hr or more.</li>
                        <li><strong>Physical Exam:</strong> Check for flank pain, costovertebral angle tenderness (CVA tenderness), and bladder distention. </li>
                    </ul>`},
                    { id: 'diagnostic-tests', title: 'Diagnostic Tests and Their Meaning', type: 'text', content: `When a urinary or renal problem is suspected, a variety of diagnostic tools are used to pinpoint the cause.<br><br>
                    <ul>
                        <li><strong>Lab Tests:</strong> The most important lab values for kidney function are <strong>creatinine</strong> and <strong>blood urea nitrogen (BUN)</strong>. Both are waste products that build up when kidneys aren't filtering properly. <strong>Glomerular Filtration Rate (GFR)</strong> is a key measure of kidney function. A normal GFR is typically 60 or higher. Other tests include urinalysis, urine culture, and a 24-hour urine collection.</li>
                        <li><strong>Imaging:</strong> X-rays, CT scans, MRIs, and ultrasounds can visualize the urinary tract and kidneys. They are crucial for identifying blockages or structural abnormalities.</li>
                        <li><strong>Direct Observation:</strong> Procedures like **cystoscopy** allow direct visualization of the bladder and urethra. </li>
                    </ul>` },
                    { id: 'elimination-concepts-quiz', title: 'Elimination Concepts Check-up', type: 'quiz',
                        questions: [
                            { question: "Which of the following is the primary functional unit of the kidney responsible for filtration?", options: ["Bladder", "Glomerulus", "Nephron", "Ureter"], correctAnswer: "Nephron" },
                            { question: "A GFR of 50 would indicate which of the following?", options: ["Normal kidney function", "Kidney failure", "Mild loss of kidney function", "Severe loss of kidney function"], correctAnswer: "Mild loss of kidney function" },
                            { question: "Which of these populations is at the highest risk for elimination problems related to Benign Prostatic Hyperplasia (BPH)?", options: ["Children", "Pregnant women", "Older adults", "Athletes"], correctAnswer: "Older adults" },
                        ]
                    },
                ]
            },
            'acute-kidney-injury': {
                title: 'Acute Kidney Injury (AKI)',
                // Updated to use a syringe icon to represent a medical intervention or sudden event
                icon: (
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-syringe"><path d="m18 12 4 4"/><path d="m17 21-3.5-3.5"/><path d="m20 15 3-3"/><path d="M19 14a.5.5 0 0 0-.5-.5h-4A.5.5 0 0 0 14 14V6a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v15c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2v-1.5a.5.5 0 0 0 .5-.5z"/></svg>
                ),
                color: 'from-orange-500 to-red-400',
                description: 'Learn about the sudden onset of kidney failure, its causes, phases, and key nursing priorities.',
                steps: [
                    { id: 'aki-etiology', title: 'AKI: Etiology & Pathophysiology', type: 'text', content: `Acute Kidney Injury (AKI) is a sudden episode of kidney failure or kidney damage that happens within a few hours or a few days. It causes a rapid buildup of waste products and fluid. It is a life-threatening emergency that can affect other organs.<br><br>
                    AKI is categorized by where the problem originates. 
                    <ol class="list-decimal list-inside">
                        <li><strong>Prerenal (Before the Kidneys):</strong> Caused by reduced blood flow to the kidneys (hypoperfusion). The kidney itself is not damaged. The most common causes are severe dehydration, shock, or a sudden drop in blood pressure.</li>
                        <li><strong>Intrarenal (Within the Kidneys):</strong> Caused by direct damage to the kidney tissue. This can be due to **nephrotoxic** substances (e.g., certain antibiotics, contrast dye) or a condition like glomerulonephritis.</li>
                        <li><strong>Postrenal (After the Kidneys):</strong> Caused by an obstruction of urine outflow from the kidneys. The most common causes are kidney stones, bladder cancer, or an enlarged prostate (BPH).</li>
                    </ol>` },
                    { id: 'phases-of-aki', title: 'Phases of Acute Kidney Injury', type: 'text', content: `AKI progresses through distinct phases that have different nursing priorities.<br><br>
                    <ul class="list-disc list-inside">
                        <li><strong>Initiation Phase:</strong> The period from the initial kidney injury until the first signs of renal impairment appear.</li>
                        <li><strong>Oliguric Phase:</strong> Urine output drops significantly to less than 400 mL/day. Waste products like BUN and creatinine, and electrolytes like potassium, phosphorus, and magnesium, build up in the blood. This phase can last for weeks and may require dialysis.</li>
                        <li><strong>Diuretic Phase:</strong> The kidneys start to recover, and urine output increases, sometimes to 3-5 L/day. The patient is at high risk for dehydration and electrolyte imbalances.</li>
                        <li><strong>Recovery Phase:</strong> Kidney function gradually returns to normal over several weeks to months. Increasing urine output, decreasing BUN/Cr, Potassium, Phosphorus, and Magnesium, increased GFR.</li>
                    </ul>` },
                    { id: 'aki-nursing-care', title: 'AKI: Nursing Assessment & Management', type: 'text', content: `Nursing care for AKI is focused on early recognition and supportive measures.<br><br>
                    <strong>Health Promotion:</strong>
                    <ul class="list-disc list-inside">
                        <li>Teach healthy adults to drink 2 to 3 L of water daily.</li>
                        <li>Avoid exposure to nephrotoxic drugs when possible.</li>
                    </ul><br>
                    <strong>Assessment Cues (RECOGNIZE):</strong>
                    <ul class="list-disc list-inside">
                        <li><strong>History:</strong> Recent surgery, trauma, or a drug history that includes potentially nephrotoxic substances.</li>
                        <li><strong>Physical Assessment:</strong> Monitor hourly urine output. Assess for signs of fluid volume deficit (hypoperfusion) or excess. Evaluate vital signs for hypotension or hypoxemia.</li>
                        <li><strong>Lab Cues:</strong> Anticipate elevated creatinine, BUN, and abnormal electrolyte values.</li>
                    </ul><br>
                    <strong>Interventions (PLAN):</strong>
                    <ul class="list-disc list-inside">
                        <li><strong>Diuretics:</strong> May be used to increase urine output and manage fluid balance in the early stages, but they do not preserve kidney function.</li>
                        <li><strong>Remove the Cause:</strong> For intrarenal injury caused by nephrotoxic agents, discontinuing the medication is the first step. For postrenal obstruction, surgical or procedural interventions are often necessary.</li>
                    </ul>`},
                    { id: 'aki-quiz', title: 'Acute Kidney Injury Quiz', type: 'quiz',
                        questions: [
                            { question: "A patient with severe dehydration and hypovolemic shock is at high risk for which type of AKI?", options: ["Prerenal", "Intrarenal", "Postrenal", "Intrinsic"], correctAnswer: "Prerenal" },
                            { question: "The oliguric phase of AKI is characterized by a urine output of less than:", options: ["1000 mL/day", "400 mL/day", "2 L/day", "30 mL/hr"], correctAnswer: "400 mL/day" },
                            { question: "Which is a priority nursing intervention for a patient with a postrenal AKI caused by a prostate obstruction?", options: ["Administering diuretics to increase urine output.", "Preparing for surgical intervention to remove the obstruction.", "Administering IV fluids to increase GFR.", "Restricting fluid intake to prevent overload."], correctAnswer: "Preparing for surgical intervention to remove the obstruction." },
                        ]
                    },
                ]
            },
            'chronic-kidney-disease': {
                title: 'Chronic Kidney Disease (CKD)',
                // Kept the infinity symbol, but used a fixed, correct SVG path.
                icon: (
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-infinity"><path d="M12 21a9 9 0 0 0-9-9 9 9 0 0 0 9-9c2.5 0 4.9 1 6.7 2.8A8.49 8.49 0 0 1 21 12a9 9 0 0 1-3 6.3m-2.2 2.2c-.1.2-.3.2-.5.1L12 18l-3-2-2.5-2.5"/></svg>
                ),
                color: 'from-purple-600 to-pink-500',
                description: 'Explore the progressive decline of kidney function, its causes, and effects on the body.',
                steps: [
                    { id: 'ckd-pathophysiology', title: 'CKD: Pathophysiology and Risk Factors', type: 'text', content: `Chronic kidney disease (CKD), also called chronic kidney failure, involves a gradual and irreversible loss of kidney function. Kidneys filter wastes and excess fluids from the blood, which are then removed in urine. Advanced CKD can cause dangerous levels of fluid, electrolytes, and wastes to build up in the body.<br><br>
                    The two leading causes of CKD are <strong>diabetes</strong> and <strong>hypertension</strong>. Other risk factors include obesity, heart problems, family history, and tobacco use. `},
                    { id: 'stages-of-ckd', title: 'Stages of CKD & Multisystem Effects', type: 'text', content: `CKD is categorized into five stages based on the patient's GFR. As kidney function declines, waste products build up, affecting every body system. 
<br><br>
                    <strong>Multisystem Effects of End-Stage Renal Disease (ESRD):</strong>
                    <ul class="list-disc list-inside">
                        <li><strong>Cardiovascular:</strong> Hypertension, fluid overload, heart failure, and arrhythmias due to electrolyte imbalances.</li>
                        <li><strong>Respiratory:</strong> Pleural effusions from fluid overload.</li>
                        <li><strong>Neurologic:</strong> Confusion, lethargy, and seizures from toxic buildup (uremia).</li>
                        <li><strong>Skeletal:</strong> Weak, brittle bones due to mineral and vitamin D imbalances.</li>
                        <li><strong>Hematologic:</strong> Anemia, bleeding tendencies, and immunosuppression.</li>
                        <li><strong>Dermatologic:</strong> Dry skin and severe itching (**pruritus**).</li>
                    </ul>`},
                    { id: 'ckd-quiz', title: 'Chronic Kidney Disease Quiz', type: 'quiz',
                        questions: [
                            { question: "Which of the following is considered the two leading causes of chronic kidney disease?", options: ["Diabetes and obesity", "Hypertension and smoking", "Diabetes and hypertension", "High cholesterol and family history"], correctAnswer: "Diabetes and hypertension" },
                            { question: "A patient with a GFR of 20 would be in which stage of Chronic Kidney Disease?", options: ["Stage 2", "Stage 3a", "Stage 4", "Stage 5"], correctAnswer: "Stage 4" },
                            { question: "Multisystem effects of ESRD include which of the following?", options: ["Decreased blood pressure", "Bradycardia", "Polyuria", "Pruritus"], correctAnswer: "Pruritus" },
                        ]
                    },
                ]
            },
            'renal-therapies': {
                title: 'Renal Therapies & Dialysis',
                // Replaced with a proper SVG for the rotate-ccw icon
                icon: (
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-rotate-ccw"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.75 2.88M3 12v-2h-2"/></svg>
                ),
                color: 'from-teal-500 to-cyan-600',
                description: 'Explore the different treatment options for end-stage renal disease, from dialysis to transplantation.',
                steps: [
                    { id: 'renal-replacement-intro', title: 'Renal Replacement Therapy (RRT)', type: 'text', content: `When kidney function is no longer adequate to sustain life, the patient requires Renal Replacement Therapy (RRT). The primary goal of RRT is to remove waste products and excess fluid from the blood.<br><br>
                    There are three main types of RRT:<br>
                    <ol class="list-decimal list-inside">
                        <li><strong>Hemodialysis (HD):</strong> Blood is filtered by a machine. </li>
                        <li><strong>Peritoneal Dialysis (PD):</strong> The patient's own peritoneal membrane is used as a filter.</li>
                        <li><strong>Kidney Transplant:</strong> A surgical procedure to replace the failed kidney with a healthy one.</li>
                    </ol>`},
                    { id: 'hemodialysis-basics', title: 'Hemodialysis (HD): The Machine Filter', type: 'text', content: `Hemodialysis is the most common form of dialysis. Blood is pumped into a machine called a **dialyzer** and filtered. The process relies on principles of osmosis, diffusion, and ultrafiltration.<br><br>
                    <strong>Access:</strong> Hemodialysis requires a high-flow access point to the patient's bloodstream.<br>
                    <ul class="list-disc list-inside">
                        <li><strong>Arteriovenous (AV) Fistula:</strong> A surgically created connection between an artery and a vein, which takes several weeks to mature. It is the preferred long-term access. </li>
                        <li><strong>AV Graft:</strong> A synthetic tube used to connect an artery and a vein.</li>
                        <li><strong>HD Catheter:</strong> A temporary catheter placed in a large vein for short-term use. </li>
                    </ul><br>
                    <strong>Nursing Assessment for AV Fistula/Graft:</strong>
                    <p>As a nurse, it is critical to assess the access site. You must:</p>
                    <ul class="list-disc list-inside">
                        <li><strong>Feel the thrill:</strong> Palpate for a buzzing vibration, which indicates blood flow.</li>
                        <li><strong>Hear the bruit:</strong> Auscultate for a swishing sound, which also indicates blood flow.</li>
                        <li><strong>Critical Safety Alert:</strong> Never take blood pressure or draw blood from the arm with a fistula or graft! This can damage the access and lead to its failure.</li>
                    </ul>`},
                    { id: 'peritoneal-dialysis-basics', title: 'Peritoneal Dialysis (PD): The Internal Filter', type: 'text', content: `Peritoneal dialysis uses the patient's own peritoneal membrane as the filter. A dialysate solution is instilled into the peritoneal cavity through an implanted catheter. <br><br>
                    <strong>Pros and Cons of PD:</strong>
                    <ul class="list-disc list-inside">
                        <li><strong>Pros:</strong> Can be done at home, offers more patient mobility, less stressful on the cardiovascular system.</li>
                        <li><strong>Cons:</strong> Requires meticulous sterile technique due to a high risk of **peritonitis**, a severe infection of the abdominal cavity. It is contraindicated in patients with recent abdominal surgery or clotting problems.</li>
                    </ul>`},
                    { id: 'kidney-transplant-care', title: 'Kidney Transplant: Perioperative Care', type: 'text', content: `Kidney transplantation is the treatment of choice for end-stage renal disease (ESRD).<br><br>
                    <strong>Preoperative Care:</strong>
                    <ul class="list-disc list-inside">
                        <li>Reduce anxiety and provide psychological support.</li>
                        <li>Initiate immunosuppression drugs before transplantation to prevent immediate graft rejection.</li>
                        <li>Address patient education regarding the procedure and post-operative care.</li>
                    </ul><br>
                    <strong>Postoperative Care:</strong>
                    <ul class="list-disc list-inside">
                        <li><strong>Monitor for Perfusion:</strong> Closely monitor the new kidney's function by tracking urine output and lab values.</li>
                        <li><strong>Prevent Infection:</strong> Use strict asepsis due to the immunosuppressant regimen.</li>
                        <li><strong>Identify Rejection:</strong> Be alert for signs of acute rejection, such as a rising serum creatinine, oliguria, and pain at the graft site.</li>
                        <li><strong>Patient Education:</strong> Instruct the patient on signs of rejection, strict medication adherence, and daily vital sign and weight monitoring.</li>
                    </ul>`},
                    { id: 'renal-therapies-quiz', title: 'Renal Therapies Quiz', type: 'quiz',
                        questions: [
                            { question: "What is the primary safety measure a nurse must remember when caring for a patient with an AV fistula for hemodialysis?", options: ["Administering heparin before dialysis.", "Palpating for a thrill and auscultating for a bruit.", "Checking blood pressure and drawing blood from the access arm.", "Restricting all fluid intake to prevent overload."], correctAnswer: "Palpating for a thrill and auscultating for a bruit." },
                            { question: "A patient on peritoneal dialysis reports cloudy dialysate return. The nurse's first action should be to suspect:", options: ["Excess fluid removal.", "Peritonitis.", "Hypotension.", "Dialysis machine malfunction."], correctAnswer: "Peritonitis." },
                            { question: "A nurse is teaching a patient about a new kidney transplant. The nurse should emphasize that the patient must take immunosuppressant drugs to prevent:", options: ["Kidney trauma.", "Hyperkalemia.", "Organ rejection.", "Urinary tract infections."], correctAnswer: "Organ rejection." },
                            { question: "Which type of renal replacement therapy would be most appropriate for a patient who cannot tolerate the rapid fluid shifts of standard hemodialysis due to low blood pressure?", options: ["Peritoneal dialysis (PD)", "Continuous Renal Replacement Therapy (CRRT)", "Kidney transplant", "AV fistula creation"], correctAnswer: "Continuous Renal Replacement Therapy (CRRT)" }
                        ]
                    },
                ]
            },
            'electrolytes-trauma': {
                title: 'Electrolytes & Kidney Trauma',
                // Kept the battery icon with a fixed, correct SVG path.
                icon: (
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-battery-low"><path d="M15 7h1c.6 0 1 .4 1 1v2h.5c.3 0 .5.2.5.5v3a.5.5 0 0 1-.5.5H17v2c0 .6-.4 1-1 1h-1"/><path d="M6 7h6a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V8a1 1 0 0 1 1-1z"/><path d="M2 13h1"/></svg>
                ),
                color: 'from-green-500 to-emerald-400',
                description: 'Review key electrolytes and manage the nursing care for patients with a traumatic kidney injury.',
                steps: [
                    { id: 'electrolyte-imbalances', title: 'Electrolyte Imbalances with Kidney Failure', type: 'text', content: `When kidneys fail, the body's ability to regulate key electrolytes is severely compromised. This requires meticulous nursing care.<br><br>
                    <strong>Potassium (K+):</strong> The most dangerous imbalance. **Hyperkalemia** (high potassium) can cause life-threatening cardiac arrhythmias.
                    <ul class="list-disc list-inside">
                        <li><strong>Nursing Interventions for Hyperkalemia:</strong> Administer insulin and glucose (D50) IV to shift potassium into cells, use potassium-binding resins (e.g., Kayexalate), and prepare for dialysis.</li>
                    </ul>
                    <strong>Phosphorus (PO4):</strong> Kidneys normally excrete excess phosphorus. In kidney failure, **hyperphosphatemia** (high phosphorus) develops, leading to bone and mineral disease.
                    <ul class="list-disc list-inside">
                        <li><strong>Nursing Interventions for Hyperphosphatemia:</strong> Administer phosphate-binding agents (e.g., Sevelamer) with meals to prevent absorption.</li>
                    </ul>
                    <strong>Calcium (Ca2+):</strong> Due to the reciprocal relationship with phosphorus, hyperphosphatemia often leads to **hypocalcemia** (low calcium), which can cause muscle cramps and tetany.
                    <ul class="list-disc list-inside">
                        <li><strong>Nursing Interventions for Hypocalcemia:</strong> Administer calcium supplements (e.g., Calcium Carbonate) and Vitamin D to increase absorption.</li>
                    </ul>`},
                    { id: 'kidney-trauma', title: 'Kidney Trauma', type: 'text', content: `Kidney trauma can be caused by blunt force (e.g., a fall, car accident) or penetrating injuries. As a nurse, you must recognize the signs and act quickly. <br><br>
                    <strong>Signs of Trauma:</strong>
                    <ul class="list-disc list-inside">
                        <li><strong>Hematuria:</strong> Blood in the urine.</li>
                        <li><strong>Flank or abdominal pain.</strong></li>
                        <li><strong>Tenderness, swelling, or ecchymosis</strong> (bruising) over the flank area (**Turner's sign**).</li>
                        <li><strong>Oliguria or Anuria:</strong> Decreased or no urine output.</li>
                        <li>Signs of **shock** due to internal bleeding.</li>
                    </ul><br>
                    <strong>Nursing Care:</strong>
                    <ul class="list-disc list-inside">
                        <li>Monitor hemodynamic status (blood pressure, heart rate) and a CBC to check for a drop in H&H (hemoglobin and hematocrit).</li>
                        <li>Anticipate imaging such as an ultrasound or CT scan to assess the extent of the injury.</li>
                        <li><strong>Priority:</strong> Control bleeding and prevent shock.</li>
                        <li>Provide postoperative care if a partial or total nephrectomy is required.</li>
                    </ul>`},
                    { id: 'case-study-final', title: 'Clinical Case Study: AKI and Electrolytes', type: 'case_study', case: {
                        scenario: `You are the nurse in the emergency department. A 68-year-old male is brought in by his family with confusion, lethargy, and general weakness. His family reports he has a history of heart failure and recently started a new diuretic. His vital signs are: BP 88/50 mmHg, HR 112 bpm, RR 24, O2 Sat 92% on room air. Lab results show a serum creatinine of 4.2 mg/dL (up from a baseline of 1.2 mg/dL) and a serum potassium of 6.8 mEq/L.`,
                        question: `Based on the patient's presentation, which of the following is the most immediate priority nursing intervention?`,
                        options: [
                            "Option C: Administer IV insulin and D50 to treat hyperkalemia.",
                            "Option A: Administer a diuretic to decrease fluid overload.",
                            "Option B: Administer a PRN dose of IV magnesium sulfate.",
                            "Option D: Encourage the patient to increase oral fluid intake.",
                        ],
                        correctAnswer: "Option C: Administer IV insulin and D50 to treat hyperkalemia.",
                        explanation: `<strong>Rationale:</strong>
                        The patient is presenting with signs of **prerenal Acute Kidney Injury (AKI)**, likely due to hypovolemia from the new diuretic and pre-existing heart failure (BP 88/50 mmHg, HR 112 bpm). The elevated creatinine (4.2 mg/dL) confirms this acute injury.
                        
                        However, the most immediate and life-threatening finding is the severe **hyperkalemia** (potassium 6.8 mEq/L). High potassium levels can cause fatal cardiac arrhythmias (a patient safety and ABC priority). Administering IV insulin and D50 is a rapid intervention to shift potassium from the extracellular space back into the cells, temporarily lowering serum levels.
                        
                        <ul class="list-disc list-inside">
                            <li><strong>Option A (Administering a diuretic):</strong> This would worsen the patient's hypotension and dehydration, exacerbating the prerenal AKI.</li>
                            <li><strong>Option B (IV magnesium sulfate):</strong> This is the treatment for Torsades de Pointes, a specific arrhythmia often associated with hypomagnesemia, not the hyperkalemia seen here.</li>
                            <li><strong>Option C (Correct):</strong> This directly addresses the life-threatening hyperkalemia, which is the immediate priority based on the patient's presentation and lab values.</li>
                            <li><strong>Option D (Increase oral fluids):</strong> While the patient is dehydrated, his altered mental status makes oral intake a choking risk, and this is not a fast enough intervention to address the critically high potassium.</li>
                        </ul>
                        <strong>Key takeaway:</strong> Always prioritize the most life-threatening condition first. In this case, that is the severe hyperkalemia and its potential for cardiac arrest.`
                    }},
                    { id: 'final-quiz', title: 'Final NCLEX Review', type: 'quiz',
                        questions: [
                            { question: "A nurse is caring for a patient with AKI who is in the diuretic phase. What is the priority nursing intervention?", options: ["Restricting fluid intake.", "Administering a vasopressor to increase blood pressure.", "Monitoring for signs of dehydration and electrolyte imbalances.", "Preparing the patient for hemodialysis."], correctAnswer: "Monitoring for signs of dehydration and electrolyte imbalances." },
                            { question: "A patient with CKD is prescribed Sevelamer. The nurse should provide which of the following instructions?", options: ["Take this medication on an empty stomach.", "Take this medication with meals.", "This medication will increase your potassium levels.", "This medication is used to control your blood pressure."], correctAnswer: "Take this medication with meals." },
                            { question: "Which sign is a key indicator of a functioning AV fistula for hemodialysis?", options: ["A palpable thrill.", "Absence of a bruit.", "Pain and redness at the site.", "A firm, non-vibrating mass."], correctAnswer: "A palpable thrill." },
                            { question: "What is a primary sign of kidney trauma a nurse should assess for?", options: ["Chest pain.", "Turner's sign (flank ecchymosis).", "Abnormal heart rhythms.", "Increased urine output."], correctAnswer: "Turner's sign (flank ecchymosis)." },
                        ]
                    },
                ]
            },
        };

        const preAssessmentQuizData = [
            { moduleId: 'elimination-concepts', question: "What is the key functional unit of the kidney responsible for filtering waste from the blood?", options: ["Bladder", "Nephron", "Ureter", "Glomerulus"], correctAnswer: "Nephron" },
            { moduleId: 'elimination-concepts', question: "A patient's GFR is reported as 45. This indicates which stage of Chronic Kidney Disease?", options: ["Stage 1", "Stage 2", "Stage 3a", "Stage 3b"], correctAnswer: "Stage 3a" },
            { moduleId: 'acute-kidney-injury', question: "What is the most common cause of prerenal acute kidney injury (AKI)?", options: ["Kidney stones", "Severe dehydration", "Infection within the kidney", "Glomerulonephritis"], correctAnswer: "Severe dehydration" },
            { moduleId: 'acute-kidney-injury', question: "During which phase of AKI is the patient at the greatest risk for fluid overload and hyperkalemia?", options: ["Initiation phase", "Oliguric phase", "Diuretic phase", "Recovery phase"], correctAnswer: "Oliguric phase" },
            { moduleId: 'chronic-kidney-disease', question: "The multisystem effects of chronic kidney disease can include neurological symptoms such as confusion and lethargy due to:", options: ["Fluid overload", "Anemia", "Uremia", "Hypertension"], correctAnswer: "Uremia" },
            { moduleId: 'renal-therapies', question: "What is a major complication risk for a patient undergoing peritoneal dialysis?", options: ["Hypotension", "Peritonitis", "Thrill and bruit loss", "Hypokalemia"], correctAnswer: "Peritonitis" },
            { moduleId: 'renal-therapies', question: "A nurse is teaching a patient about their new AV fistula. The nurse knows teaching was effective if the patient states they will check for a 'thrill' which is:", options: ["A visual sign of swelling.", "A painful sensation at the site.", "A buzzing vibration felt at the site.", "A swishing sound heard at the site."], correctAnswer: "A buzzing vibration felt at the site." },
            { moduleId: 'electrolytes-trauma', question: "A patient in acute renal failure develops a high serum potassium level. The nurse should anticipate administering which medication to rapidly shift potassium into the cells?", options: ["Oral phosphate binders", "Calcium carbonate", "IV insulin and glucose", "Furosemide"], correctAnswer: "IV insulin and glucose" },
        ];

        // Utility for conditionally joining Tailwind CSS classes.
        const cn = (...classes) => classes.filter(Boolean).join(' ');

        // --- Child Components ---

        const Quiz = ({ questions, onComplete, isPreAssessment = false }) => {
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [selectedOption, setSelectedOption] = useState(null);
            const [feedback, setFeedback] = useState(null);
            const [answers, setAnswers] = useState([]);

            const currentQuestion = questions[currentQuestionIndex];

            const handleOptionSelect = (option) => {
                if (feedback && !isPreAssessment) return;
                setSelectedOption(option);
            };

            const handleSubmit = () => {
                if (selectedOption === null) return;

                const isCorrect = selectedOption === currentQuestion.correctAnswer;
                setFeedback(isCorrect ? 'correct' : 'incorrect');

                const updatedAnswers = [...answers, { question: currentQuestion, isCorrect }];
                setAnswers(updatedAnswers);
                
                if (isPreAssessment) {
                    if (currentQuestionIndex < questions.length - 1) {
                        setCurrentQuestionIndex(currentQuestionIndex + 1);
                        setSelectedOption(null);
                        setFeedback(null);
                    } else {
                        onComplete(updatedAnswers);
                    }
                }
            };
            
            const handleNext = () => {
                if (!isPreAssessment) {
                    const finalAnswers = [...answers]; // Capture final answer state
                    if (currentQuestionIndex < questions.length - 1) {
                        setCurrentQuestionIndex(currentQuestionIndex + 1);
                        setSelectedOption(null);
                        setFeedback(null);
                    } else {
                        const finalScore = finalAnswers.reduce((acc, ans) => acc + (ans.isCorrect ? 1 : 0), 0);
                        onComplete({ score: finalScore, total: questions.length });
                    }
                }
            };

            return (
                <div className="p-4 bg-white rounded-xl shadow-inner animate-fade-in border-2 border-gray-100">
                    <h4 className="font-bold text-lg text-gray-800 mb-2">Quiz: {currentQuestionIndex + 1} of {questions.length}</h4>
                    <p className="font-semibold text-gray-700 mb-4">{currentQuestion.question}</p>
                    <div className="space-y-2">
                        {currentQuestion.options.map((option, index) => {
                            const isSelected = selectedOption === option;
                            const isCorrectOption = option === currentQuestion.correctAnswer;
                            let optionClass = 'bg-gray-50 hover:bg-gray-100 border-gray-200';

                            if (feedback) {
                                if (isCorrectOption) {
                                    optionClass = 'bg-emerald-100 border-emerald-500 text-emerald-800';
                                } else if (isSelected && !isCorrectOption) {
                                    optionClass = 'bg-red-100 border-red-500 text-red-800';
                                }
                            } else if (isSelected) {
                                optionClass = 'bg-indigo-100 border-indigo-500 text-indigo-800';
                            }

                            return (
                                <div
                                    key={index}
                                    onClick={() => handleOptionSelect(option)}
                                    className={cn('p-3 rounded-lg border-2 cursor-pointer transition-colors duration-200', optionClass)}
                                >
                                    <div className="flex items-center">
                                        {feedback && (
                                            isCorrectOption ? <span className="text-emerald-600 mr-2">✓</span> : (isSelected && <span className="text-red-600 mr-2">✗</span>)
                                        )}
                                        <span className="flex-1">{option}</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    <div className="mt-6 text-center">
                        {isPreAssessment ? (
                            <button
                                onClick={handleSubmit}
                                disabled={selectedOption === null}
                                className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-full shadow-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 transform hover:scale-105"
                            >
                                {currentQuestionIndex < questions.length - 1 ? 'Next Question' : 'Finish Assessment'}
                            </button>
                        ) : (
                            <>
                            {!feedback ? (
                                <button
                                    onClick={handleSubmit}
                                    disabled={selectedOption === null}
                                    className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-full shadow-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 transform hover:scale-105"
                                >
                                    Submit Answer
                                </button>
                            ) : (
                                <button
                                    onClick={handleNext}
                                    className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-full shadow-lg hover:bg-indigo-700 transition-all duration-300 transform hover:scale-105"
                                >
                                    {currentQuestionIndex < questions.length - 1 ? 'Next Question' : 'View Results'}
                                </button>
                            )}
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const PreAssessmentQuiz = ({ onComplete, onExit }) => {
            const [results, setResults] = useState(null);

            const handleQuizComplete = (finalAnswers) => {
                const moduleResults = {};
                finalAnswers.forEach(answer => {
                    const { moduleId } = answer.question;
                    if (!moduleResults[moduleId]) {
                        moduleResults[moduleId] = { correct: 0, total: 0 };
                    }
                    if (answer.isCorrect) {
                        moduleResults[moduleId].correct++;
                    }
                    moduleResults[moduleId].total++;
                });

                const completedModules = [];
                for (const moduleId in moduleResults) {
                    if (moduleResults[moduleId].correct === moduleResults[moduleId].total) {
                        completedModules.push(moduleId);
                    }
                }
                setResults({ completedModules, total: finalAnswers.length, correct: finalAnswers.filter(a => a.isCorrect).length });
                onComplete(completedModules);
            };

            if (results) {
                return (
                    <div className="fixed inset-0 bg-slate-50 flex items-center justify-center z-40 p-4 animate-fade-in">
                        <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full text-center border-4 border-emerald-400 transform scale-100 transition-transform duration-300">
                            <h2 className="text-3xl font-extrabold text-gray-800 mb-4">Assessment Complete!</h2>
                            <p className="text-lg text-gray-600 mb-6">
                                You correctly answered {results.correct} out of {results.total} questions.
                            </p>
                            {results.completedModules.length > 0 ? (
                                <>
                                    <p className="text-emerald-600 font-bold mb-4 text-xl">You've tested out of the following modules:</p>
                                    <ul className="list-disc list-inside text-left mb-6 bg-emerald-50 p-6 rounded-2xl border border-emerald-200">
                                        {results.completedModules.map(id => <li key={id}>{contentData[id].title}</li>)}
                                    </ul>
                                </>
                            ) : (
                                <p className="text-yellow-600 font-bold mb-6 text-lg">You haven't tested out of any modules. You can proceed to the main modules for learning.</p>
                            )}
                            <button
                                onClick={onExit}
                                className="px-8 py-3 bg-indigo-600 text-white font-semibold rounded-full shadow-lg hover:bg-indigo-700 transition-colors duration-300 transform hover:scale-105"
                            >
                                Return to Dashboard
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="fixed inset-0 bg-slate-50 flex items-center justify-center z-40 p-4">
                    <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full border-4 border-indigo-400">
                        <h2 className="text-3xl font-bold text-center text-gray-800 mb-6">Diagnostic Quiz</h2>
                        <p className="text-center text-gray-600 mb-6">Answer these questions to see if you can skip ahead.</p>
                        <Quiz questions={preAssessmentQuizData} onComplete={handleQuizComplete} isPreAssessment={true} />
                    </div>
                </div>
            );
        };


        const Dashboard = ({ onSelectModule, progress, onResetProgress, onStartPreAssessment, userId }) => {
            let totalCompletedSteps = 0;
            let totalPossibleSteps = 0;
            let totalQuizCorrect = 0;
            let totalQuizQuestions = 0;

            Object.entries(contentData).forEach(([moduleId, module]) => {
                totalPossibleSteps += module.steps.length;
                const moduleProgress = progress[moduleId] || {};
                
                Object.values(moduleProgress).forEach(stepProgress => {
                    if (stepProgress.completed) {
                        totalCompletedSteps++;
                    }
                    if (stepProgress.score !== undefined) {
                        totalQuizCorrect += stepProgress.score;
                    }
                });

                module.steps.forEach(step => {
                    if (step.type === 'quiz') {
                        totalQuizQuestions += step.questions.length;
                    }
                });
            });

            const overallPercentage = totalPossibleSteps > 0 ? (totalCompletedSteps / totalPossibleSteps) * 100 : 0;

            return (
                <div className="p-4 sm:p-6 md:p-8 min-h-screen w-full flex flex-col items-center">
                    <div className="w-full max-w-6xl">
                        <header className="mb-8 text-center animate-fade-in">
                            <h1 className="text-4xl sm:text-5xl font-extrabold text-gray-800 tracking-tight mb-2">Renal Function Module</h1>
                            <p className="text-lg text-gray-500 max-w-2xl mx-auto">Master key concepts in urinary elimination and renal health for your clinical practice and exams.</p>
                             <div className="mt-2 text-xs text-gray-400 font-mono">User ID: <span className="break-all">{userId}</span></div>
                        </header>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 animate-fade-in delay-100">
                             <button
                                onClick={onStartPreAssessment}
                                className="w-full px-6 py-4 bg-teal-500 text-white font-bold rounded-2xl shadow-lg hover:bg-teal-600 transition-all duration-300 transform hover:scale-105 flex items-center justify-center gap-3 group"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-graduation-cap group-hover:scale-110 transition-transform"><path d="M21.42 10.922a1 1 0 0 0-.019-1.393L12.067 2.607a1.01 1.01 0 0 0-1.415 0L2.6 9.529a1 1 0 0 0 0 1.414l8.475 8.475a1 1 0 0 0 1.414 0l8.475-8.475Z"/><path d="M11.96 16.51c.092.365.317.365.409 0l.965-3.86a.25.25 0 0 1 .457-.101l3.86 3.86c.365.092.365.317 0 .409l-3.86.965a.25.25 0 0 1-.101.457l-3.86 3.86c-.092.365-.317.365-.409 0l-.965-3.86a.25.25 0 0 1-.457-.101l-3.86-3.86c-.365-.092-.365-.317 0-.409l3.86-.965a.25.25 0 0 1 .101-.457l3.86-3.86zM6 16v-3a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0v-2.5h-2v2.5a.5.5 0 0 1-1 0z"/></svg>
                                <div>
                                    <div className="text-xl font-bold">Skip Ahead: Take Diagnostic Quiz</div>
                                    <div className="text-sm font-normal opacity-90">Test your knowledge and potentially skip modules.</div>
                                </div>
                            </button>
                            <div className="w-full px-6 py-4 bg-white text-gray-800 font-bold rounded-2xl shadow-lg border border-gray-200 flex items-center justify-between gap-3 animate-fade-in delay-200">
                                <div>
                                    <h3 className="text-xl font-bold">Overall Progress</h3>
                                    <div className="text-sm text-gray-500 font-normal mt-1">{Math.round(overallPercentage)}% Complete</div>
                                </div>
                                <div className="relative w-16 h-16 flex-shrink-0">
                                    <svg className="w-full h-full" viewBox="0 0 36 36">
                                        <path className="text-gray-200" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="3" />
                                        <path className="text-indigo-500" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="3" strokeDasharray={`${overallPercentage}, 100`} strokeLinecap="round" transform="rotate(-90 18 18)" />
                                    </svg>
                                    <span className="absolute inset-0 flex items-center justify-center text-xs font-bold text-gray-600">{Math.round(overallPercentage)}%</span>
                                </div>
                                <button
                                    onClick={onResetProgress}
                                    className="p-2 text-sm bg-red-500 text-white font-semibold rounded-full shadow-md hover:bg-red-600 transition-colors flex items-center gap-1 absolute top-3 right-3"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V4a1 1 0 112 0v1.001A7.002 7.002 0 0112.292 4.293a1 1 0 111.414 1.414A9.002 9.002 0 004 9.899V11a1 1 0 11-2 0V3a1 1 0 011-1z" clipRule="evenodd" /></svg>
                                </button>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 w-full animate-fade-in">
                            {Object.entries(contentData).map(([id, module], index) => {
                                const moduleProgress = progress[id] || {};
                                const completedCount = Object.values(moduleProgress).filter(p => p.completed).length;
                                const totalSteps = module.steps.length;
                                const percentage = totalSteps > 0 ? (completedCount / totalSteps) * 100 : 0;

                                let statusText = "Not Started";
                                let statusColor = "text-gray-500";
                                if (completedCount === totalSteps) {
                                    statusText = "Completed";
                                    statusColor = "text-emerald-600";
                                } else if (completedCount > 0) {
                                    statusText = "In Progress";
                                    statusColor = "text-yellow-600";
                                }

                                const quizStep = module.steps.find(step => step.type === 'quiz');
                                const quizProgress = quizStep ? moduleProgress[quizStep.id] : null;

                                return (
                                    <div
                                        key={id}
                                        onClick={() => onSelectModule(id)}
                                        className="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 cursor-pointer transition-all duration-300 hover:shadow-xl hover:-translate-y-1 group flex flex-col transform scale-100 hover:scale-105"
                                        style={{ animationDelay: `${index * 50}ms` }}
                                    >
                                        <div className="flex justify-between items-start mb-4">
                                            <div className={cn("p-3 rounded-full bg-gradient-to-br", module.color, "w-12 h-12 flex items-center justify-center text-white text-lg font-bold shadow-md flex-shrink-0")}>
                                                {module.icon}
                                            </div>
                                            <div className="relative w-12 h-12 flex-shrink-0">
                                                <svg className="w-full h-full" viewBox="0 0 36 36">
                                                    <path className="text-gray-200" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="3" />
                                                    <path className="text-indigo-500" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="3" strokeDasharray={`${percentage}, 100`} strokeLinecap="round" transform="rotate(-90 18 18)" />
                                                </svg>
                                                <span className="absolute inset-0 flex items-center justify-center text-xs font-bold text-gray-600">{Math.round(percentage)}%</span>
                                            </div>
                                        </div>
                                        <h3 className="text-xl font-bold text-gray-800 mb-2">{module.title}</h3>
                                        <p className="text-gray-500 text-sm mb-2 h-10">{module.description}</p>
                                        <div className="mt-auto">
                                            <p className={cn("text-sm font-semibold", statusColor)}>{statusText}</p>
                                            {quizProgress && quizProgress.score !== undefined && (
                                                <p className="text-sm text-gray-600 mt-1">Quiz Score: {quizProgress.score} / {quizStep.questions.length}</p>
                                            )}
                                            <div className="flex items-center justify-end text-sm font-medium text-indigo-600 group-hover:text-indigo-700 mt-2">
                                                Start Learning <span className="ml-1 transition-transform group-hover:translate-x-1">&rarr;</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const CaseStudy = ({ caseData, onComplete }) => {
            const [selectedAnswer, setSelectedAnswer] = useState(null);

            const handleSelect = (option) => {
                if (selectedAnswer) return;
                setSelectedAnswer(option);
                const isCorrect = Array.isArray(caseData.correctAnswer) ? caseData.correctAnswer.includes(option) : option === caseData.correctAnswer;
                if (isCorrect) {
                    onComplete({ score: 1 });
                } else {
                    onComplete({ score: 0 });
                }
            };

            const showFeedback = selectedAnswer !== null;

            return (
                <div className="p-4 bg-white rounded-xl shadow-inner animate-fade-in border-2 border-gray-100">
                    <h4 className="font-bold text-lg text-gray-800 mb-4">Case Study Challenge</h4>
                    <p className="bg-blue-100 text-blue-800 p-4 rounded-xl mb-4 text-sm leading-relaxed" dangerouslySetInnerHTML={{ __html: caseData.scenario }}></p>
                    <p className="font-semibold text-gray-700 mb-4">{caseData.question}</p>
                    <div className="space-y-2">
                        {caseData.options.map(option => {
                            const isSelected = selectedAnswer === option;
                            const isCorrectOption = Array.isArray(caseData.correctAnswer) ? caseData.correctAnswer.includes(option) : option === caseData.correctAnswer;
                            let optionClass = 'bg-gray-50 hover:bg-gray-100 border-gray-200';
                            
                            if (showFeedback) {
                                if (isCorrectOption) {
                                    optionClass = 'bg-emerald-100 border-emerald-500 text-emerald-800';
                                } else if (isSelected && !isCorrectOption) {
                                    optionClass = 'bg-red-100 border-red-500 text-red-800';
                                }
                            } else if (isSelected) {
                                optionClass = 'bg-indigo-100 border-indigo-500 text-indigo-800';
                            }

                            return (
                                <div
                                    key={option}
                                    onClick={() => handleSelect(option)}
                                    className={cn('p-3 rounded-lg border-2 cursor-pointer transition-colors duration-200', optionClass)}
                                >
                                    <div className="flex items-center">
                                        {showFeedback && (
                                            isCorrectOption ? <span className="text-emerald-600 mr-2">✓</span> : (isSelected && <span className="text-red-600 mr-2">✗</span>)
                                        )}
                                        <span className="flex-1">{option}</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    {selectedAnswer && (
                        <div className="mt-6 p-4 bg-indigo-50 rounded-lg border-l-4 border-indigo-500 animate-fade-in">
                            <h5 className="font-bold text-indigo-800 mb-1">Explanation</h5>
                            <p className="text-sm text-indigo-700" dangerouslySetInnerHTML={{ __html: caseData.explanation }}></p>
                        </div>
                    )}
                </div>
            );
        };

        const StaticContentStep = ({ step, onComplete }) => {
            useEffect(() => {
                const timer = setTimeout(() => {
                    onComplete();
                }, 100);
                return () => clearTimeout(timer);
            }, [onComplete]);

            return (
                <div className="prose max-w-none text-gray-700 leading-relaxed p-4 bg-white rounded-xl shadow-inner animate-fade-in border-2 border-gray-100">
                    <div dangerouslySetInnerHTML={{ __html: step.content }}></div>
                </div>
            );
        };

        const CompletionModal = ({ isOpen, onClose, onNextModule, hasNextModule }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center transform animate-scale-in">
                        <h3 className="text-3xl font-bold text-indigo-700 mb-4">Module Completed! 🎉</h3>
                        <p className="text-gray-700 mb-6">You've successfully completed all steps in this module. Great job!</p>
                        <div className="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                            <button
                                onClick={onClose}
                                className="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-full hover:bg-gray-400 transition-colors shadow-sm transform hover:scale-105"
                            >
                                Back to Dashboard
                            </button>
                            {hasNextModule && (
                                <button
                                    onClick={onNextModule}
                                    className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-full shadow-lg hover:bg-indigo-700 transition-colors transform hover:scale-105"
                                >
                                    Continue to Next Module
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const LearningModule = ({ module, onBack, progress, onProgressUpdate, onNextModule, hasNextModule }) => {
            const [activeStep, setActiveStep] = useState(0);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [isCompletionModalOpen, setIsCompletionModalOpen] = useState(false);

            const handleStepComplete = useCallback((stepId, data = {}) => {
                onProgressUpdate(module.id, stepId, { completed: true, ...data });
            }, [onProgressUpdate, module.id]);

            const moduleProgress = progress[module.id] || {};
            const allStepsCompletedInModule = module.steps.every(step => moduleProgress[step.id] && moduleProgress[step.id].completed);

            const handleNextStep = () => {
                if (activeStep === module.steps.length - 1 && allStepsCompletedInModule) {
                    setIsCompletionModalOpen(true);
                } else if (activeStep < module.steps.length - 1) {
                    setActiveStep(activeStep + 1);
                }
            };

            const handlePrevStep = () => {
                if (activeStep > 0) {
                    setActiveStep(activeStep - 1);
                }
            };

            if (!module || !module.steps) {
                return <div className="fixed inset-0 flex items-center justify-center bg-slate-50 text-gray-700">Module content not found.</div>;
            }

            const currentStep = module.steps[activeStep];

            const renderStepContent = (step) => {
                if (!step) return <p>Please select a step.</p>;
                const onCompleteForStep = (data) => handleStepComplete(step.id, data);
                switch (step.type) {
                    case 'text': return <StaticContentStep key={step.id} step={step} onComplete={onCompleteForStep} />;
                    case 'case_study': return <CaseStudy key={step.id} caseData={step.case} onComplete={onCompleteForStep} />;
                    case 'quiz': return <Quiz key={step.id} questions={step.questions} onComplete={onCompleteForStep} />;
                    default: return <p key={step.id} className="text-red-600">Error: Content for this step type is not available.</p>;
                }
            };

            const handleModalClose = () => {
                setIsCompletionModalOpen(false);
                onBack();
            };

            const handleModalNextModule = () => {
                setIsCompletionModalOpen(false);
                onNextModule();
            };

            return (
                <div className="fixed inset-0 bg-slate-50 flex flex-col z-20">
                    <header className="bg-white shadow-md p-4 flex items-center justify-between z-30 flex-shrink-0">
                        <button onClick={onBack} className="flex items-center gap-2 text-indigo-600 font-semibold hover:text-indigo-800 transition-colors p-2 rounded-lg -ml-2">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clipRule="evenodd" /></svg>
                            <span className="hidden sm:inline">Dashboard</span>
                        </button>
                        <h2 className="text-xl font-bold text-gray-800 text-center flex-1 sm:flex-initial truncate px-2">{module.title}</h2>
                        <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="md:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors">
                           <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        </button>
                    </header>
                    {isSidebarOpen && <div onClick={() => setIsSidebarOpen(false)} className="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden"></div>}
                    <div className="flex flex-1 overflow-hidden">
                        <aside className={cn(
                            "bg-white border-r border-gray-200 p-4 w-72 lg:w-80 flex-shrink-0 flex flex-col transition-transform duration-300 ease-in-out md:translate-x-0 absolute md:static h-full z-20",
                            isSidebarOpen ? 'translate-x-0' : '-translate-x-full'
                        )}>
                            <h3 className="text-lg font-semibold mb-4 text-gray-700 px-3">Module Steps</h3>
                            <nav className="space-y-1 overflow-y-auto flex-1 pr-1">
                                {module.steps.map((step, index) => (
                                    <button
                                        key={step.id}
                                        onClick={() => {
                                            setActiveStep(index);
                                            setIsSidebarOpen(false);
                                        }}
                                        className={cn(
                                            'w-full text-left p-3 rounded-xl flex items-center gap-3 transition-colors',
                                            activeStep === index ? 'bg-indigo-100 text-indigo-700 font-semibold shadow-md' : 'hover:bg-gray-100 text-gray-700'
                                        )}
                                    >
                                        <div className="w-5 h-5 flex-shrink-0 flex items-center justify-center">
                                            {moduleProgress[step.id]?.completed ? (
                                                <svg className="w-5 h-5 text-emerald-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>
                                            ) : (
                                                <div className={cn("w-3 h-3 rounded-full border-2", activeStep === index ? "border-indigo-500 bg-indigo-500" : "border-gray-400 bg-white")}></div>
                                            )}
                                        </div>
                                        <span className="flex-1 text-sm">{step.title}</span>
                                    </button>
                                ))}
                            </nav>
                        </aside>

                        <main className="flex-1 overflow-y-auto p-4 sm:p-6 md:p-8">
                            <div className="max-w-5xl mx-auto">
                                <h3 className="text-2xl font-bold text-gray-800 mb-4">{currentStep.title}</h3>
                                {renderStepContent(currentStep)}

                                <div className="flex justify-between mt-8">
                                    <button
                                        onClick={handlePrevStep}
                                        disabled={activeStep === 0}
                                        className="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-full hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm transform hover:scale-105"
                                    >
                                        Previous
                                    </button>

                                    <button
                                        onClick={handleNextStep}
                                        disabled={activeStep === module.steps.length - 1 && !allStepsCompletedInModule}
                                        className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-full shadow-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors transform hover:scale-105"
                                    >
                                        {activeStep === module.steps.length - 1 ? 'Finish Module' : 'Next'}
                                    </button>
                                </div>
                            </div>
                        </main>
                    </div>
                    <CompletionModal
                        isOpen={isCompletionModalOpen}
                        onClose={handleModalClose}
                        onNextModule={handleModalNextModule}
                        hasNextModule={hasNextModule}
                    />
                </div>
            );
        };

        function App() {
            const [currentModuleId, setCurrentModuleId] = useState(null);
            const [isPreAssessmentActive, setIsPreAssessmentActive] = useState(false);
            const [userId, setUserId] = useState(null);
            const [progress, setProgress] = useState({});
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                const initFirebase = async () => {
                    try {
                        const uid = await window.firebaseAuthReady;
                        setUserId(uid);
                        const db = window.firebase.db;
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                        const userDocRef = window.firebase.firestore.doc(db, `artifacts/${appId}/users/${uid}/progress/data`);
                        const unsubscribe = window.firebase.firestore.onSnapshot(userDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                setProgress(docSnap.data() || {});
                            } else {
                                setProgress({});
                            }
                            setIsLoading(false);
                        }, (error) => {
                            console.error("Failed to listen to progress updates:", error);
                            setIsLoading(false);
                        });
                        return () => unsubscribe();
                    } catch (e) {
                        console.error("Firebase initialization failed:", e);
                        setIsLoading(false);
                    }
                };

                initFirebase();
            }, []);

            const handleProgressUpdate = useCallback(async (moduleId, stepId, data = {}) => {
                if (!userId || isLoading) return;
                const db = window.firebase.db;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userDocRef = window.firebase.firestore.doc(db, `artifacts/${appId}/users/${userId}/progress/data`);

                setProgress(currentProgress => {
                    const newProgress = {
                        ...currentProgress,
                        [moduleId]: {
                            ...(currentProgress[moduleId] || {}),
                            [stepId]: { ...(currentProgress[moduleId]?.[stepId] || {}), ...data }
                        }
                    };
                    window.firebase.firestore.setDoc(userDocRef, newProgress).catch(e => console.error("Failed to save progress to Firestore:", e));
                    return newProgress;
                });
            }, [userId, isLoading]);

            const handlePreAssessmentComplete = useCallback(async (completedModuleIds) => {
                if (!userId || isLoading) return;
                const db = window.firebase.db;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userDocRef = window.firebase.firestore.doc(db, `artifacts/${appId}/users/${userId}/progress/data`);
                
                const newProgress = { ...progress };
                completedModuleIds.forEach(moduleId => {
                    const module = contentData[moduleId];
                    if (module) {
                        newProgress[moduleId] = {};
                        module.steps.forEach(step => {
                            newProgress[moduleId][step.id] = { completed: true };
                        });
                    }
                });

                window.firebase.firestore.setDoc(userDocRef, newProgress).then(() => {
                    setProgress(newProgress);
                }).catch(e => console.error("Failed to save pre-assessment results:", e));
            }, [userId, isLoading, progress]);

            const handleResetProgress = useCallback(async () => {
                if (!userId || isLoading) return;
                const db = window.firebase.db;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userDocRef = window.firebase.firestore.doc(db, `artifacts/${appId}/users/${userId}/progress/data`);
                
                window.firebase.firestore.deleteDoc(userDocRef).then(() => {
                    setProgress({});
                }).catch(e => console.error("Failed to reset progress:", e));
            }, [userId, isLoading]);

            const handleNextModule = useCallback(() => {
                const moduleIds = Object.keys(contentData);
                const currentIndex = moduleIds.indexOf(currentModuleId);
                if (currentIndex !== -1 && currentIndex < moduleIds.length - 1) {
                    setCurrentModuleId(moduleIds[currentIndex + 1]);
                } else {
                    setCurrentModuleId(null);
                }
            }, [currentModuleId]);

            const selectedModule = currentModuleId ? { ...contentData[currentModuleId], id: currentModuleId } : null;
            const moduleIds = Object.keys(contentData);
            const currentIndex = selectedModule ? moduleIds.indexOf(selectedModule.id) : -1;
            const hasNextModule = currentIndex !== -1 && currentIndex < moduleIds.length - 1;

            if (isLoading) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-slate-50">
                        <div className="flex flex-col items-center">
                            <svg className="animate-spin text-indigo-500 w-12 h-12 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p className="text-gray-600 font-semibold">Loading your learning module...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="bg-slate-50 min-h-screen font-sans text-gray-900">
                    {isPreAssessmentActive ? (
                        <PreAssessmentQuiz
                            onComplete={handlePreAssessmentComplete}
                            onExit={() => setIsPreAssessmentActive(false)}
                        />
                    ) : selectedModule ? (
                        <LearningModule
                            key={selectedModule.id}
                            module={selectedModule}
                            onBack={() => setCurrentModuleId(null)}
                            progress={progress}
                            onProgressUpdate={handleProgressUpdate}
                            onNextModule={handleNextModule}
                            hasNextModule={hasNextModule}
                        />
                    ) : (
                        <Dashboard
                            onSelectModule={setCurrentModuleId}
                            progress={progress}
                            onResetProgress={handleResetProgress}
                            onStartPreAssessment={() => setIsPreAssessmentActive(true)}
                            userId={userId}
                        />
                    )}
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
