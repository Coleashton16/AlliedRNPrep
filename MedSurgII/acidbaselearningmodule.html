<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acid-Base Balance and Imbalance Nursing Module</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind CSS configuration to use the Inter font and custom animations.
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    keyframes: {
                        'fade-in': {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                    },
                    animation: {
                        'fade-in': 'fade-in 0.3s ease-out forwards',
                    },
                },
            },
        };
    </script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="font-sans antialiased text-gray-900 bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        // --- React and Library Setup ---
        const { useState, useEffect, useCallback, useMemo } = React;

        // --- Mock Authentication Setup for Standalone Demo ---
        // This mock simulates user authentication for local storage keying.
        const mockAuth = {
            onAuthStateChanged: (callback) => {
                setTimeout(() => callback({ uid: 'standalone-acidbase-user' }), 100);
                return () => {};
            },
            signInAnonymously: () => Promise.resolve({ user: { uid: 'standalone-acidbase-user' } }),
        };

        // --- Content & Data Structure for the Learning Modules (UPDATED CONTENT) ---
        const contentData = {
            'acid-base-fundamentals': {
                title: 'Acid-Base Fundamentals: pH, Buffers, & CO₂',
                color: 'from-blue-600 to-indigo-700',
                description: 'Master the pH scale, role of hydrogen ions, buffers, and the carbonic anhydrase equation.',
                steps: [
                    { id: 'ab-learning-outcomes', title: 'Learning Outcomes and Definitions', type: 'text', content: `This module covers the core concepts of acid-base balance. You will learn to:<br><br>
                        <ul>
                            <li><strong>Define</strong> acid-base balance, acidosis, and alkalosis.</li>
                            <li><strong>Interpret</strong> assessment findings related to <strong>ABG</strong> values and clinical presentation.</li>
                            <li><strong>Explain</strong> the role of buffers and compensatory mechanisms.</li>
                            <li><strong>Plan</strong> and <strong>implement</strong> evidence-based nursing care for patients with acid-base disturbances.</li>
                        </ul>
                        <h4 class="font-bold mt-4">Key Definitions:</h4>
                        <ul>
                            <li><strong>Acid-Base Balance:</strong> The maintenance of arterial blood <strong>pH</strong> between <strong>7.35</strong> and <strong>7.45</strong> through control of <strong>hydrogen ion</strong> production and elimination.</li>
                            <li><strong>Acidosis:</strong> Arterial blood <strong>pH</strong> level < <strong>7.35</strong> (higher concentration of acids).</li>
                            <li><strong>Alkalosis:</strong> Arterial blood <strong>pH</strong> level > <strong>7.45</strong> (higher concentration of bases).</li>
                            <li><strong>Acids:</strong> Substances that <strong>release</strong> <strong>H ions</strong> when dissolved in fluid (e.g., <strong>HCl</strong> - a strong acid).</li>
                            <li><strong>Bases:</strong> Substances that <strong>bind</strong> free <strong>H ions</strong> in solution (e.g., <strong>Bicarbonate (HCO3)</strong>).</li>
                        </ul>` },
                    { id: 'ph-and-h-ion', title: 'The pH Scale and H Ion Control', type: 'text', content: `The <strong>pH</strong> is a <strong>negative logarithm</strong> measure of the free <strong>hydrogen ion (H ion)</strong> level. Because of this relationship:<br>
                        <ul>
                            <li>The <strong>lower</strong> the <strong>pH</strong> value (< <strong>7.0</strong>), the <strong>higher</strong> the concentration of <strong>H ions</strong> (more acidic).</li>
                            <li>The <strong>higher</strong> the <strong>pH</strong> value (> <strong>7.0</strong>), the <strong>lower</strong> the concentration of <strong>H ions</strong> (more alkaline).</li>
                            <li>Normal Arterial Blood <strong>pH</strong> Range: <strong>7.35-7.45</strong>.</li>
                        </ul>
                        <p class="mt-4 p-3 bg-red-100 border-l-4 border-red-500">
                        <strong>Clinical Significance:</strong> <strong>H ions</strong> are the most tightly controlled substance in the body. Even small increases (e.g., <strong>pH</strong> <strong>7.4</strong> to <strong>7.3</strong>) represent a huge increase in free <strong>H ions</strong> and can severely reduce body function, leading to death.
                        </p>` },
                    { id: 'buffers-and-h2co3-ratio', title: 'Buffers: The H Ion Sponges', type: 'text', content: `<strong>Buffers</strong> are the body's first line of defense. They are substances that can react as either an acid (releasing <strong>H ions</strong>) or a base (binding <strong>H ions</strong>) to keep the <strong>pH</strong> within the normal range.<br><br>
                        <ul>
                            <li><strong>Function:</strong> They act like "sponges," soaking up <strong>H ions</strong> when there are too many, and squeezing out <strong>H ions</strong> when there are too few.</li>
                            <li><strong>Main ECF Buffer:</strong> <strong>Bicarbonate (HCO3)</strong>, which is a weak base.</li>
                            <li><strong>Other Buffers:</strong> Phosphate (in the ICF) and <strong>Proteins</strong> (Albumin, Globulins, and importantly, <strong>Hemoglobin</strong> inside red blood cells).</li>
                        </ul>
                        <h4 class="font-bold mt-4">The Bicarbonate:Carbonic Acid Ratio</h4>
                        In health, the body maintains a constant ratio of <strong>1 part Carbonic Acid (H2CO3) to 20 parts Bicarbonate (HCO3)</strong>. Disruption of this <strong>1:20 ratio</strong> indicates an acid-base imbalance.` },
                    { id: 'carbonic-anhydrase-equation', title: 'Carbonic Anhydrase Equation: CO₂ and H Ions', type: 'text', content: `The <strong>Carbonic Anhydrase Equation</strong> is key because it shows the direct relationship between respiratory control (<strong>CO2</strong>) and acid control (<strong>H ions</strong>):<br>
                        <p class="font-mono bg-gray-100 p-3 rounded-md text-center my-4 font-bold">
                            CO2 + H2O <-> H2CO3 <-> H ions + HCO3
                        </p>
                        <br>
                        <ul>
                            <li><strong>CO2 (Acid Component):</strong> Carbon dioxide is a gas eliminated by the <strong>lungs</strong> (respiratory control). An increase in <strong>CO2</strong> shifts the equation to the <strong>right</strong>, increasing <strong>H ions</strong> (lower <strong>pH</strong>, acidosis).</li>
                            <li><strong>HCO3 (Base Component):</strong> Bicarbonate is controlled by the <strong>kidneys</strong> (metabolic control).</li>
                        </ul>
                        <p class="mt-4 p-3 bg-yellow-100 border-l-4 border-yellow-500">
                        <strong>Clinical Takeaway:</strong> If the <strong>CO2</strong> level changes, the <strong>pH</strong> changes to the <strong>opposite</strong> direction. If the <strong>CO2</strong> increases, the <strong>pH</strong> drops (acidic).
                        </p>` },
                    { id: 'sources-of-acids', title: 'Sources of Acids and Bicarbonate', type: 'text', content: `Acids are continuously produced through normal body metabolism:<br><br>
                        <ul>
                            <li><strong>Carbohydrate Metabolism:</strong> Forms <strong>CO2</strong> (volatile acid, eliminated by lungs).</li>
                            <li><strong>Protein Breakdown:</strong> Forms Sulfuric Acid.</li>
                            <li><strong>Fat Breakdown:</strong> Forms Fatty Acids and Ketoacids (seen in Diabetic Ketoacidosis (DKA) and starvation).</li>
                            <li><strong>Anaerobic Metabolism:</strong> Forms <strong>Lactic Acid</strong> (occurs during hypoxia, sepsis, and shock).</li>
                        </ul>
                        <h4 class="font-bold mt-4">Bicarbonate Production:</h4>
                        <strong>Bicarbonate (HCO3)</strong> is produced primarily in the <strong>pancreas</strong>, <strong>kidneys</strong>, and inside <strong>red blood cells</strong>. Unlike acid production, there are generally <strong>no natural pathologic conditions</strong> that lead to the excessive production of bicarbonate.` },
                    { id: 'fundamentals-quiz', title: 'Fundamentals Quiz', type: 'quiz',
                        questions: [
                            { question: "What is the normal and tightly regulated arterial blood pH range?", options: ["7.00-7.40", "7.40-7.80", "7.35-7.45", "6.80-7.80"], correctAnswer: "7.35-7.45" },
                            { question: "A strong acid, like hydrochloric acid (HCl), is characterized by:", options: ["Binding H ions in solution.", "Releasing only some of its H ions.", "Separating completely in water and releasing all of its H ions.", "Being the main buffer of the ECF."], correctAnswer: "Separating completely in water and releasing all of its H ions." },
                            { question: "Which acid is produced when cells metabolize under anaerobic (no oxygen) conditions?", options: ["Sulfuric Acid", "Carbonic Acid (H2CO3)", "Lactic Acid", "Ketoacids"], correctAnswer: "Lactic Acid" },
                            { question: "If the concentration of CO2 increases in the blood, the carbonic anhydrase equation shifts to the right, causing the pH to:", options: ["Increase (Alkalosis)", "Decrease (Acidosis)", "Remain Neutral (7.0)", "Remain in the normal range due to buffers"], correctAnswer: "Decrease (Acidosis)" }
                        ]
                    },
                ]
            },
            'regulatory-mechanisms': {
                title: 'Regulatory Mechanisms & Compensation',
                color: 'from-purple-600 to-pink-500',
                description: 'Understand how chemical, respiratory, and renal systems defend against pH changes.',
                steps: [
                    { id: 'chemical-control', title: 'First Line of Defense: Chemical Buffers', type: 'text', content: `The <strong>Chemical Buffer Systems</strong> are the first line of defense and respond <strong>very rapidly</strong> (seconds). They handle small, normal fluctuations.<br><br>
                        <ul>
                            <li><strong>Mechanism:</strong> They absorb excess <strong>H ions</strong> when blood is too acidic or release <strong>H ions</strong> when blood is too alkaline.</li>
                            <li><strong>Key Buffers:</strong> Bicarbonate-Carbonic Acid system, Phosphate system, and <strong>Proteins</strong> (Hemoglobin, albumin, globulins).</li>
                            <li><strong>Hemoglobin's Role:</strong> When <strong>H ions</strong> increase in the blood, excess <strong>H ions</strong> enters red blood cells and binds to hemoglobin, removing it from the blood and raising the <strong>pH</strong> back toward normal.</li>
                        </ul>` },
                    { id: 'respiratory-control', title: 'Second Line of Defense: Respiratory Regulation', type: 'text', content: `The <strong>Respiratory System</strong> is the second line of defense and responds <strong>quickly</strong> (within seconds to minutes). It controls the level of <strong>CO2</strong> (the volatile acid).<br><br>
                        <ul>
                            <li><strong>Increased H ions or CO2:</strong> Triggers the central chemoreceptors in the brain to <strong>increase the rate and depth of breathing (Hyperventilation)</strong>, which "blows off" more <strong>CO2</strong> and decreases <strong>H ions</strong>.</li>
                            <li><strong>Decreased H ions or CO2:</strong> Inhibits the brain, leading to a <strong>decreased rate and depth of breathing (Hypoventilation)</strong>, which retains <strong>CO2</strong> and increases <strong>H ions</strong>.</li>
                        </ul>
                        <p class="mt-4 p-3 bg-yellow-100 border-l-4 border-yellow-500">
                        <strong>Limitation:</strong> The respiratory response is rapid but <strong>limited</strong> and can be easily overwhelmed by severe changes.
                        </p>` },
                    { id: 'renal-control', title: 'Third Line of Defense: Kidney Regulation', type: 'text', content: `The <strong>Kidneys</strong> are the third line of defense and the <strong>most powerful</strong> regulators of acid-base balance, but they are the <strong>slowest</strong> to respond (taking <strong>24-48</strong> hours).<br><br>
                        The kidneys defend against wide or chronic <strong>pH</strong> changes through three primary actions:
                        <ul>
                            <li><strong>1. Bicarbonate (HCO3) Movement:</strong> When blood <strong>H ions</strong> is high (acidosis), the kidneys reabsorb and make additional <strong>HCO3</strong> to put back into the circulation. When blood <strong>H ions</strong> is low (alkalosis), <strong>HCO3</strong> is excreted in the urine.</li>
                            <li><strong>2. Formation of Acids:</strong> <strong>H ions</strong> binds to phosphate ions in the urine to be excreted as an acid (H2PO4).</li>
                            <li><strong>3. Formation of Ammonium:</strong> Ammonia (NH3) is converted to Ammonium (NH4) in the urine, which traps <strong>H ions</strong> and allows it to be excreted.</li>
                        </ul>` },
                    { id: 'compensation-principles', title: 'Compensation: Correcting the Imbalance', type: 'text', content: `<strong>Compensation</strong> is the body's adaptation to correct a <strong>pH</strong> change and maintain balance.<br><br>
                        <ul>
                            <li><strong>Respiratory Compensation:</strong> Occurs when the <strong>lungs</strong> correct for <strong>pH</strong> imbalances caused by <strong>metabolic</strong> problems (e.g., Kussmaul respirations in Diabetic Ketoacidosis to blow off <strong>CO2</strong>).</li>
                            <li><strong>Renal Compensation:</strong> Occurs when the <strong>kidneys</strong> correct for <strong>pH</strong> imbalances caused by <strong>respiratory</strong> problems (e.g., retaining <strong>HCO3</strong> in chronic <strong>COPD</strong>).</li>
                        </ul>
                        <h4 class="font-bold mt-4">Interpreting Compensation:</h4>
                        <ul>
                            <li><strong>Fully Compensated:</strong> The blood <strong>pH</strong> has returned to the normal range (<strong>7.35-7.45</strong>), but <strong>PaCO2</strong> and <strong>HCO3</strong> levels are still abnormal.</li>
                            <li><strong>Partially Compensated:</strong> The <strong>pH</strong> remains outside the normal range, but the compensatory organ is attempting to correct it (its value is moving in the opposite direction of the primary imbalance).</li>
                            <li><strong>Uncompensated:</strong> Only the primary problem component (<strong>PaCO2</strong> or <strong>HCO3</strong>) is abnormal, and the compensating component is still normal.</li>
                        </ul>` },
                    { id: 'abg-reference-ranges', title: 'ABG Interpretation: Reference Ranges', type: 'text', content: `Interpreting <strong>Arterial Blood Gas (ABG)</strong> values is critical for identifying the type of acid-base disturbance:<br><br>
                        <table class="min-w-full divide-y divide-gray-200 shadow overflow-hidden sm:rounded-lg">
                            <thead>
                                <tr class="bg-indigo-50">
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Test</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Normal Range</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acidosis Indicator</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alkalosis Indicator</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">pH</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">7.35-7.45</td><td class="px-6 py-4 whitespace-nowrap text-sm text-red-600"><7.35</td><td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">>7.45</td></tr>
                                <tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">PaCO2 (Respiratory)</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">35-45 mm Hg</td><td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">>45</td><td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600"><35</td></tr>
                                <tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">HCO3 (Metabolic)</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">21-28 mEq/L</td><td class="px-6 py-4 whitespace-nowrap text-sm text-red-600"><21</td><td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">>28</td></tr>
                                <tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">PaO2 (Oxygenation)</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">80-100 mm Hg</td><td class="px-6 py-4 whitespace-nowrap text-sm text-red-600"><80</td><td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">Normal</td></tr>
                            </tbody>
                        </table>
                        <p class="mt-4 text-sm text-gray-600">
                        *Note: <strong>PaO2</strong> (Partial pressure of arterial oxygen) is low in respiratory acidosis due to poor gas exchange but typically normal in metabolic acidosis unless the patient is hypoxic for other reasons.
                        </p>` },
                    { id: 'regulation-quiz', title: 'Regulatory Mechanisms Quiz', type: 'quiz',
                        questions: [
                            { question: "Which acid-base regulatory mechanism is the most powerful but the slowest to respond?", options: ["Chemical Buffers", "Respiratory System", "Kidney System", "GI System"], correctAnswer: "Kidney System" },
                            { question: "If a patient has a metabolic problem resulting in acidosis, the body's compensatory mechanism will be:", options: ["Hypoventilation to retain CO2.", "Increased excretion of HCO3 by the kidneys.", "Hyperventilation to blow off CO2.", "Decreased H ion binding by chemical buffers."], correctAnswer: "Hyperventilation to blow off CO2." },
                            { question: "A patient's ABG results show a pH of 7.38, PaCO2 of 50 mm Hg, and HCO3 of 31 mEq/L. How should the nurse interpret this finding?", options: ["Uncompensated Respiratory Acidosis", "Uncompensated Metabolic Alkalosis", "Fully Compensated Respiratory Acidosis", "Partial Compensated Metabolic Acidosis"], correctAnswer: "Fully Compensated Respiratory Acidosis" },
                            { question: "Which term describes the pattern of deep and rapid breathing associated with metabolic acidosis?", options: ["Cheyne-Stokes respiration", "Kussmaul respiration", "Biot's respiration", "Apneustic breathing"], correctAnswer: "Kussmaul respiration" }
                        ]
                    }
                ]
            },
            'acidosis-management': {
                title: 'Acidosis: Pathophysiology and Care',
                color: 'from-red-600 to-rose-700',
                description: 'Focus on causes, clinical presentation, K shifts, and specific nursing interventions for acidosis.',
                steps: [
                    { id: 'acidosis-pathophysiology', title: 'Pathophysiology of Acidosis', type: 'text', content: `<strong>Acidosis</strong> (<strong>pH</strong> < <strong>7.35</strong>) results from an excess of <strong>H ions</strong>. This can be caused by an <strong>actual acid excess</strong> (overproduction or underelimination of acids) or a <strong>relative acid excess</strong> (underproduction or overelimination of bases).<br><br>
                        <h4 class="font-bold">Metabolic Acidosis (Acid/Base Problem):</h4>
                        The hallmark is a <strong>low pH</strong> (<7.35) and <strong>low HCO3</strong> (<21 mEq/L).
                        <ul>
                            <li><strong>Overproduction of H ions:</strong> Diabetic Ketoacidosis (DKA) or starvation (excessive fatty acid breakdown), heavy exercise/seizures (lactic acidosis).</li>
                            <li><strong>Underelimination of H ions:</strong> Kidney failure (retaining H ions).</li>
                            <li><strong>Overelimination of HCO3:</strong> <strong>Diarrhea</strong> (most common cause of base deficit acidosis).</li>
                            <li><strong>Underproduction of HCO3:</strong> Kidney or Pancreatic failure.</li>
                        </ul>
                        <h4 class="font-bold mt-4">Respiratory Acidosis (CO2 Retention):</h4>
                        The hallmark is a <strong>low pH</strong> (<7.35) and <strong>high PaCO2</strong> (>45 mm Hg).
                        <ul>
                            <li><strong>Mechanism:</strong> Impaired respiratory function $\to$ <strong>CO2</strong> retention $\to$ increased <strong>H ions</strong> production via carbonic anhydrase equation.</li>
                            <li><strong>Causes:</strong> Respiratory depression (opioids, anesthetics), inadequate chest expansion (muscle weakness, obesity, trauma), airway obstruction, and reduced alveolar-capillary diffusion (pneumonia, <strong>COPD</strong>, <strong>ARDS</strong>).</li>
                        </ul>` },
                    { id: 'acidosis-clinical-cues', title: 'Clinical Cues: Assessment and Hyperkalemia', type: 'text', content: `Acidosis significantly reduces the ability of excitable membranes to respond, affecting the <strong>CNS</strong>, cardiac, and musculoskeletal systems.<br><br>
                        <h4 class="font-bold">Critical Electrolyte Shift (Hyperkalemia):</h4>
                        <p>As blood <strong>H ions</strong> level rises (acidosis), excess <strong>H ions</strong> moves <strong>into</strong> the cells for buffering. To maintain electroneutrality, an equal number of <strong>Potassium (K) ions</strong> move <strong>out of the cells into the blood</strong>, causing <strong>Hyperkalemia</strong> (high <strong>K</strong>). This is a critical safety issue.</p>
                        <h4 class="font-bold mt-4">Key Features:</h4>
                        <ul>
                            <li><strong>Cardiovascular:</strong> Bradycardia $\to$ <strong>cardiac arrest</strong>. <strong>Tall, peaked T waves</strong> and <strong>widened QRS complex</strong> on <strong>EKG</strong> (signs of hyperkalemia). Hypotension, thready peripheral pulses.</li>
                            <li><strong>CNS:</strong> Depression (lethargy, confusion, stupor, coma). Older adults are especially vulnerable to cognitive changes.</li>
                            <li><strong>Respiratory:</strong> Metabolic acidosis causes <strong>Kussmaul respirations</strong> (deep, rapid). Respiratory acidosis causes <strong>shallow, rapid, ineffective breaths</strong>.</li>
                            <li><strong>Neuromuscular:</strong> Hyporeflexia, skeletal muscle weakness, flaccid paralysis.</li>
                            <li><strong>Integumentary:</strong> Metabolic acidosis $\to$ Warm, flushed, dry skin. Respiratory acidosis $\to$ Pale-to-cyanotic, dry skin.</li>
                        </ul>
                        <p class="mt-4 p-3 bg-red-200 border-l-4 border-red-700 font-bold">
                        <strong>Nursing Safety Priority:</strong> Always assess the <strong>cardiovascular system first</strong> in any patient at risk for acidosis due to the risk of hyperkalemic cardiac arrest.
                        </p>` },
                    { id: 'acidosis-interventions', title: 'Interventions and Management Priorities', type: 'text', content: `Interventions for acidosis focus on correcting the underlying cause and supporting vital functions.<br><br>
                        <h4 class="font-bold">Metabolic Acidosis Management:</h4>
                        Goals: Correct the problem causing the acid excess and restore fluid/electrolyte balance.
                        <ul>
                            <li><strong>Hydration:</strong> Provide intravenous fluids.</li>
                            <li><strong>DKA:</strong> Administer <strong>Insulin</strong> to halt ketone body production.</li>
                            <li><strong>Diarrhea:</strong> Administer <strong>antidiarrheal</strong> agents and rehydration.</li>
                            <li><strong>Bicarbonate:</strong> Administer <strong>IV Bicarbonate</strong> only if <strong>serum HCO3</strong> is very low and <strong>pH</strong> is < <strong>7.2</strong> (used cautiously).</li>
                            <li><strong>Monitoring:</strong> Continuous monitoring of cardiovascular status and <strong>ABG</strong> results is paramount.</li>
                        </ul>
                        <h4 class="font-bold mt-4">Respiratory Acidosis Management:</h4>
                        Goals: Improve gas exchange and ventilation to eliminate <strong>CO2</strong>.
                        <ul>
                            <li><strong>Drug Therapy:</strong> <strong>Bronchodilators</strong> (to open airways), <strong>antiinflammatories</strong>, and <strong>mucolytics</strong> (to clear secretions).</li>
                            <li><strong>Oxygen Therapy:</strong> Use the <strong>lowest flow</strong> of <strong>O2</strong> that prevents hypoxemia (to avoid <strong>O2</strong>-induced tissue damage).</li>
                            <li><strong>Ventilatory Support:</strong> May require <strong>mechanical ventilation</strong> if <strong>O2</strong> saturation cannot be maintained at ><strong>90</strong>% or if respiratory muscles fatigue.</li>
                            <li><strong>Monitoring:</strong> Monitor breathing status hourly (muscle retractions, accessory muscle use, grunt/wheeze, cyanosis).</li>
                        </ul>` },
                    { id: 'acidosis-case-study', title: 'Case Study: DKA and Respiratory Compensation', type: 'case_study', case: {
                        scenario: `A 45-year-old male with Type 1 Diabetes Mellitus presents to the ED. He is lethargic, reports deep, rapid breathing (Kussmaul), and fruity-smelling breath. His EKG shows tall, peaked T waves. Initial ABG results are pH 7.18, PaCO2 28 mm Hg, HCO3 10 mEq/L, and serum K 6.1 mEq/L (Hyperkalemic).`,
                        question: `Which set of nursing interventions and rationale are most appropriate to address the patient's immediate primary problem and its corresponding electrolyte imbalance?`,
                        options: [
                            "Option A: Administer IV Bicarbonate to raise pH; Restrict fluid intake to prevent fluid overload.",
                            "Option B: Administer IV Insulin and IV fluids (hydration); Monitor cardiac rhythm continuously due to Hyperkalemia.",
                            "Option C: Administer Naloxone to reverse respiratory depression; Encourage shallow breathing to retain CO2.",
                            "Option D: Administer Kayexalate to lower K; Prepare for immediate dialysis.",
                        ],
                        correctAnswer: "Option B: Administer IV Insulin and IV fluids (hydration); Monitor cardiac rhythm continuously due to Hyperkalemia.",
                        explanation: `<strong>Rationale:</strong>
                        The <strong>ABG</strong> shows <strong>Metabolic Acidosis</strong> (<strong>low pH</strong>, <strong>low HCO3</strong>) likely due to <strong>DKA</strong> (ketoacids). The <strong>low PaCO2</strong> (28 mm Hg) indicates <strong>Respiratory Compensation</strong> (Kussmaul breathing) attempting to correct the <strong>pH</strong>. The <strong>K</strong> of 6.1 mEq/L confirms <strong>Hyperkalemia</strong> (a common and dangerous consequence of acidosis).

                        <ul>
                            <li><strong>Option B (Correct):</strong> The underlying cause is <strong>DKA</strong>, which requires <strong>IV Insulin</strong> to stop acid (ketone) production and <strong>IV Fluids (hydration)</strong> to correct dehydration and flush ketones. Continuous <strong>Cardiac Monitoring</strong> is the highest safety priority due to the <strong>tall, peaked T waves</strong> and <strong>Hyperkalemia</strong>, which can lead to cardiac arrest.</li>
                            <li><strong>Option A (Incorrect):</strong> IV Bicarbonate is rarely used unless <strong>pH</strong> is dangerously low (<7.1 or 7.0). Fluid restriction is contraindicated as the patient is severely dehydrated.</li>
                            <li><strong>Option C (Incorrect):</strong> The patient is hyperventilating due to metabolic compensation, not respiratory depression. Retaining <strong>CO2</strong> would worsen the acidosis.</li>
                            <li><strong>Option D (Incorrect):</strong> While Kayexalate is an option for <strong>Hyperkalemia</strong>, the priority is treating the underlying <strong>DKA</strong> and monitoring the heart. Dialysis is generally reserved for severe renal failure, not initial <strong>DKA</strong>.</li>
                        </ul>`
                    }},
                ]
            },
            'alkalosis-review': {
                title: 'Alkalosis, Interventions, & Final Review',
                color: 'from-green-500 to-teal-600',
                description: 'Analyze the causes and clinical manifestations of alkalosis, and perform a comprehensive review.',
                steps: [
                    { id: 'alkalosis-pathophysiology', title: 'Pathophysiology and Assessment of Alkalosis', type: 'text', content: `<strong>Alkalosis</strong> (<strong>pH</strong> > <strong>7.45</strong>) results from an <strong>excess of bases</strong> (<strong>HCO3</strong>) or an <strong>acid deficit</strong> (loss of <strong>H ions</strong>).<br><br>
                        <h4 class="font-bold">Metabolic Alkalosis (HCO3 Excess):</h4>
                        The hallmark is a <strong>high pH</strong> (>7.45) and <strong>high HCO3</strong> (>28 mEq/L).
                        <ul>
                            <li><strong>Causes:</strong> Excessive antacid use, IV sodium bicarbonate, massive blood transfusions, <strong>prolonged vomiting</strong> (loss of gastric acid), <strong>NG</strong> suctioning, diuretic use (loop/thiazide).</li>
                        </ul>
                        <h4 class="font-bold mt-4">Respiratory Alkalosis (CO2 Loss):</h4>
                        The hallmark is a <strong>high pH</strong> (>7.45) and <strong>low PaCO2</strong> (<35 mm Hg).
                        <ul>
                            <li><strong>Causes:</strong> <strong>Hyperventilation</strong> (excessive loss of <strong>CO2</strong>) due to anxiety, fear, improper mechanical ventilator settings, fever, or salicylate toxicity.</li>
                        </ul>
                        <h4 class="font-bold mt-4">Clinical Cues:</h4>
                        Alkalosis causes <strong>Hypokalemia</strong> and <strong>Hypocalcemia</strong> (as <strong>H ions</strong> leaves the cell and <strong>K</strong> moves in, <strong>Ca</strong> binds to albumin), leading to <strong>increased stimulation</strong> of excitable tissues.
                        <ul>
                            <li><strong>CNS/Neuromuscular:</strong> Dizziness, anxiety, irritability, hyperreflexia, muscle cramping/twitching, and <strong>Tetany</strong> (continuous contractions). Signs of <strong>Hypocalcemia</strong> include <strong>Positive Chvostek and Trousseau signs</strong>.</li>
                            <li><strong>Cardiovascular:</strong> Increased heart rate (tachycardia), normal or low <strong>BP</strong>. Increased risk for <strong>Digoxin Toxicity</strong> due to Hypokalemia.</li>
                        </ul>` },
                    { id: 'alkalosis-interventions', title: 'Alkalosis Interventions and Safety', type: 'text', content: `Interventions focus on preventing further losses of acids and electrolytes (<strong>H ions</strong>, <strong>K</strong>, <strong>Ca</strong>, <strong>Cl</strong>) and correcting the underlying cause.<br><br>
                        <h4 class="font-bold">Nursing Priorities:</h4>
                        <ul>
                            <li><strong>Safety:</strong> Implement <strong>fall precautions</strong> due to potential hypotension and muscle weakness.</li>
                            <li><strong>Treatment Modification:</strong> Collaborate with the provider to <strong>stop or modify treatments</strong> contributing to the alkalosis (e.g., stopping diuretic use, reducing <strong>NG</strong> suctioning).</li>
                            <li><strong>Fluid/Electrolytes:</strong> Administer <strong>fluids and electrolyte replacement</strong> as prescribed (<strong>K</strong>, <strong>Cl</strong>).</li>
                            <li><strong>Monitoring:</strong> Monitor electrolytes daily until stable.</li>
                        </ul>
                        <h4 class="font-bold mt-4">Specific Alkalosis Management:</h4>
                        <ul>
                            <li><strong>Respiratory Alkalosis (Hyperventilation):</strong>
                                <ul>
                                    <li>If due to anxiety, instruct the patient to <strong>breathe into a paper bag</strong> (to retain <strong>CO2</strong>) or provide calm reassurance.</li>
                                    <li>Adjust mechanical ventilation settings to lower the respiratory rate or tidal volume.</li>
                                </ul>
                            </li>
                            <li><strong>Metabolic Alkalosis:</strong>
                                <ul>
                                    <li>Administer <strong>antiemetic</strong> drugs for vomiting.</li>
                                    <li>Provide fluids and electrolyte replacement (<strong>KCl</strong>).</li>
                                </ul>
                            </li>
                        </ul>` },
                    { id: 'final-review-quiz', title: 'Comprehensive Acid-Base Review', type: 'quiz',
                        questions: [
                            { question: "A patient's ABG results show pH 7.55, PaCO2 30 mm Hg, HCO3 24 mEq/L. The nurse determines this is:", options: ["Uncompensated Metabolic Alkalosis", "Partial Compensated Respiratory Acidosis", "Uncompensated Respiratory Alkalosis", "Fully Compensated Metabolic Alkalosis"], correctAnswer: "Uncompensated Respiratory Alkalosis" },
                            { question: "Which finding is a critical clinical cue for a patient experiencing alkalosis?", options: ["Tall, peaked T waves", "Hyporeflexia and depressed CNS", "Positive Chvostek and Trousseau signs", "Warm, flushed, dry skin"], correctAnswer: "Positive Chvostek and Trousseau signs" },
                            { question: "A patient with prolonged <strong>NG</strong> suctioning is at risk for which acid-base imbalance?", options: ["Metabolic Acidosis", "Respiratory Acidosis", "Metabolic Alkalosis", "Respiratory Alkalosis"], correctAnswer: "Metabolic Alkalosis" },
                            { question: "In acidosis, H ions move into the cell. What effect does this have on serum Potassium (K)?", options: ["K moves out of the cell, causing Hypokalemia.", "K moves out of the cell, causing Hyperkalemia.", "K moves into the cell, causing Hypokalemia.", "K remains unchanged."], correctAnswer: "K moves out of the cell, causing Hyperkalemia." },
                            { question: "Which intervention is the priority for a nurse managing a patient with respiratory acidosis caused by <strong>COPD</strong>?", options: ["Administering IV Bicarbonate.", "Applying aggressive supplemental oxygen.", "Administering bronchodilators to improve ventilation.", "Encouraging a low-sodium diet."], correctAnswer: "Administering bronchodilators to improve ventilation." },
                        ]
                    }
                ]
            }
        };

        // The pre-assessment quiz data now includes questions for all new modules.
        const preAssessmentQuizData = [
            // Questions for Acid-Base Fundamentals
            { moduleId: 'acid-base-fundamentals', question: "What is the normal and tightly regulated arterial blood pH range?", options: ["7.00-7.40", "7.40-7.80", "7.35-7.45", "6.80-7.80"], correctAnswer: "7.35-7.45" },
            { moduleId: 'acid-base-fundamentals', question: "Which acid is produced when cells metabolize under anaerobic (no oxygen) conditions?", options: ["Sulfuric Acid", "Carbonic Acid (H2CO3)", "Lactic Acid", "Ketoacids"], correctAnswer: "Lactic Acid" },

            // Questions for Regulatory Mechanisms
            { moduleId: 'regulatory-mechanisms', question: "Which acid-base regulatory mechanism is the most powerful but the slowest to respond?", options: ["Chemical Buffers", "Respiratory System", "Kidney System", "GI System"], correctAnswer: "Kidney System" },
            { moduleId: 'regulatory-mechanisms', question: "A patient's ABG results show a pH of 7.38, PaCO2 of 50 mm Hg, and HCO3 of 31 mEq/L. How should the nurse interpret this finding?", options: ["Uncompensated Respiratory Acidosis", "Uncompensated Metabolic Alkalosis", "Fully Compensated Respiratory Acidosis", "Partial Compensated Metabolic Acidosis"], correctAnswer: "Fully Compensated Respiratory Acidosis" },

            // Questions for Acidosis
            { moduleId: 'acidosis-management', question: "A low pH (<7.35) with a low HCO3 (<21 mEq/L) is the hallmark of:", options: ["Respiratory Acidosis", "Respiratory Alkalosis", "Metabolic Alkalosis", "Metabolic Acidosis"], correctAnswer: "Metabolic Acidosis" },
            { moduleId: 'acidosis-management', question: "The critical EKG changes associated with acidosis are a result of which electrolyte imbalance?", options: ["Hypocalcemia", "Hypokalemia", "Hyperkalemia", "Hypernatremia"], correctAnswer: "Hyperkalemia" },

            // Questions for Alkalosis & Review
            { moduleId: 'alkalosis-review', question: "A patient with prolonged <strong>NG</strong> suctioning is at risk for which acid-base imbalance?", options: ["Metabolic Acidosis", "Respiratory Acidosis", "Metabolic Alkalosis", "Respiratory Alkalosis"], correctAnswer: "Metabolic Alkalosis" },
            { moduleId: 'alkalosis-review', question: "Which intervention is appropriate for a patient with respiratory alkalosis due to anxiety-induced hyperventilation?", options: ["Administer IV Bicarbonate.", "Encourage the patient to breathe into a paper bag.", "Administer an insulin infusion.", "Increase the flow rate of supplemental oxygen."], correctAnswer: "Encourage the patient to breathe into a paper bag." }
        ];

        // --- Helper Functions ---
        // Utility for conditionally joining Tailwind CSS classes.
        const cn = (...classes) => classes.filter(Boolean).join(' ');


        // --- Child Components ---

        /**
         * Quiz component for interactive multiple-choice questions.
         * Users answer questions and receive immediate feedback.
         */
        const Quiz = ({ questions, onComplete, isPreAssessment = false }) => {
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [selectedOption, setSelectedOption] = useState(null); 
            const [feedback, setFeedback] = useState(null);
            const [answers, setAnswers] = useState([]);

            const currentQuestion = questions[currentQuestionIndex];

            // Handle option selection
            const handleOptionSelect = (option) => {
                if (feedback && !isPreAssessment) return; // Prevent changing answer after feedback in regular quiz
                setSelectedOption(option);
            };

            const checkCorrectness = (selected, correct) => {
                // Normalize and compare (case insensitive and space insensitive for simplicity)
                const normalize = (str) => String(str).toLowerCase().trim().replace(/\s+/g, ' ');
                return normalize(selected) === normalize(correct);
            }

            const handlePreAssessmentNext = () => {
                if (selectedOption === null) return;
                
                const isCorrect = checkCorrectness(selectedOption, currentQuestion.correctAnswer);
                
                const updatedAnswers = [...answers, { question: currentQuestion, isCorrect }];
                setAnswers(updatedAnswers);

                if (currentQuestionIndex < questions.length - 1) {
                    setCurrentQuestionIndex(currentQuestionIndex + 1);
                    setSelectedOption(null); // Reset for next question
                    setFeedback(null);
                } else {
                    onComplete(updatedAnswers);
                }
            };
            
            const handleRegularQuizSubmit = () => {
                if (selectedOption === null) return;
                
                const isCorrect = checkCorrectness(selectedOption, currentQuestion.correctAnswer);
                
                setFeedback(isCorrect ? 'correct' : 'incorrect');
                
                // Record the answer immediately for the next step function to use
                setAnswers(prevAnswers => [...prevAnswers, { question: currentQuestion, isCorrect }]);
            };

            const handleRegularQuizNext = () => {
                // This function is only called after submission, so the answer should be in `answers` state.
                
                if (currentQuestionIndex < questions.length - 1) {
                    setCurrentQuestionIndex(currentQuestionIndex + 1);
                    setSelectedOption(null); // Reset for next question
                    setFeedback(null);
                } else {
                    // This is the last question. Calculate score from accumulated answers.
                    const finalScore = answers.reduce((acc, ans) => acc + (ans.isCorrect ? 1 : 0), 0);
                    onComplete({ score: finalScore, total: questions.length });
                }
            };

            // If question has not been answered yet, wait for user selection
            const hasSubmittedAnswer = answers.length > currentQuestionIndex;
            let currentAnswerIsCorrect = false;
            if (hasSubmittedAnswer) {
                currentAnswerIsCorrect = answers[currentQuestionIndex].isCorrect;
            }


            return (
                <div className="p-4 bg-white rounded-xl shadow-lg">
                    <h4 className="font-bold text-lg text-gray-800 mb-2">Quiz: {currentQuestionIndex + 1} of {questions.length}</h4>
                    <p className="font-semibold text-gray-700 mb-3">{currentQuestion.question}</p>
                    <div className="space-y-2">
                        {currentQuestion.options.map((option, index) => {
                            const isSelected = selectedOption === option;
                            const isCorrectOption = checkCorrectness(option, currentQuestion.correctAnswer);
                            
                            let optionClass = 'bg-gray-50 hover:bg-gray-100 border-gray-200';

                            if (feedback && !isPreAssessment) {
                                if (isCorrectOption) {
                                    optionClass = 'bg-green-100 border-green-500 text-green-800';
                                } else if (isSelected && !isCorrectOption) {
                                    optionClass = 'bg-red-100 border-red-500 text-red-800';
                                }
                            } else if (isSelected) {
                                optionClass = 'bg-indigo-100 border-indigo-500 text-indigo-800';
                            }

                            return (
                                <div
                                    key={index}
                                    onClick={() => handleOptionSelect(option)}
                                    className={cn('p-3 rounded-lg border-2 cursor-pointer transition-colors', optionClass, (feedback && !isPreAssessment) && 'pointer-events-none')}
                                >
                                    <div className="flex items-center">
                                        {feedback && !isPreAssessment && (isCorrectOption || (isSelected && !isCorrectOption)) && (
                                            isCorrectOption ? <span className="text-green-600 mr-2">✓</span> : <span className="text-red-600 mr-2">✗</span>
                                        )}
                                        <span className="flex-1" dangerouslySetInnerHTML={{ __html: option }}></span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    <div className="mt-4 text-center">
                        {isPreAssessment ? (
                               <button
                                   onClick={handlePreAssessmentNext}
                                   disabled={selectedOption === null}
                                   className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                               >
                                   {currentQuestionIndex < questions.length - 1 ? 'Next Question' : 'Finish Assessment'}
                               </button>
                        ) : (
                            <>
                            {feedback ? (
                                <button
                                    onClick={handleRegularQuizNext}
                                    className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors"
                                >
                                    {currentQuestionIndex < questions.length - 1 ? 'Next Question' : 'View Results'}
                                </button>
                            ) : (
                                <button
                                    onClick={handleRegularQuizSubmit}
                                    disabled={selectedOption === null}
                                    className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                >
                                    Submit Answer
                                </button>
                            )}
                            </>
                        )}
                    </div>
                </div>
            );
        };
        
        /**
         * PreAssessmentQuiz component to handle the initial diagnostic quiz.
         * Displays quiz questions and then results, allowing users to "test out" of modules.
         */
        const PreAssessmentQuiz = ({ onComplete, onExit }) => {
            const [results, setResults] = useState(null);

            const handleQuizComplete = (finalAnswers) => {
                const moduleResults = {};
                finalAnswers.forEach(answer => {
                    const { moduleId } = answer.question;
                    if (!moduleResults[moduleId]) {
                        moduleResults[moduleId] = { correct: 0, total: 0 };
                    }
                    if (answer.isCorrect) {
                        moduleResults[moduleId].correct++;
                    }
                    moduleResults[moduleId].total++;
                });

                const completedModules = [];
                for (const moduleId in moduleResults) {
                    // Module is complete if 100% of its questions in the pre-assessment quiz were correct.
                    if (moduleResults[moduleId].correct === moduleResults[moduleId].total) {
                        completedModules.push(moduleId);
                    }
                }
                setResults({ completedModules, total: finalAnswers.length, correct: finalAnswers.filter(a => a.isCorrect).length });
                onComplete(completedModules);
            };

            if (results) {
                return (
                    <div className="fixed inset-0 bg-gray-100 flex items-center justify-center z-40 p-4 animate-fade-in">
                        <div className="bg-white rounded-2xl shadow-xl p-8 max-w-2xl w-full text-center">
                            <h2 className="text-3xl font-bold text-gray-800 mb-4">Assessment Complete!</h2>
                            <p className="text-lg text-gray-600 mb-6">
                                You correctly answered {results.correct} out of {results.total} questions.
                            </p>
                            {results.completedModules.length > 0 ? (
                                <>
                                    <p className="text-green-600 font-semibold mb-4">You've tested out of the following modules:</p>
                                    <ul className="list-disc list-inside text-left mb-6 bg-green-50 p-4 rounded-lg">
                                        {results.completedModules.map(id => <li key={id}>{contentData[id].title}</li>)}
                                    </ul>
                                </>
                            ) : (
                                <p className="text-yellow-600 font-semibold mb-6">You haven't tested out of any modules. Proceed to the dashboard to begin learning!</p>
                            )}
                            <button
                                onClick={onExit}
                                className="px-8 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors"
                            >
                                Return to Dashboard
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="fixed inset-0 bg-gray-100 flex items-center justify-center z-40 p-4">
                    <div className="bg-white rounded-2xl shadow-xl p-8 max-w-2xl w-full">
                        <h2 className="text-2xl font-bold text-center text-gray-800 mb-6">Diagnostic Quiz: Acid-Base Balance</h2>
                        <Quiz questions={preAssessmentQuizData} onComplete={handleQuizComplete} isPreAssessment={true} />
                    </div>
                </div>
            );
        };


        /**
         * Dashboard component to display the available learning modules.
         * It allows users to select a module to start learning.
         * Shows progress for each module using a circular progress bar and status.
         */
        const Dashboard = ({ onSelectModule, progress, onResetProgress, onStartPreAssessment }) => {
            let totalCompletedSteps = 0;
            let totalPossibleSteps = 0;
            let totalQuizCorrect = 0;
            let totalQuizQuestions = 0;

            // Calculate overall progress and gather quiz scores
            Object.entries(contentData).forEach(([moduleId, module]) => {
                totalPossibleSteps += module.steps.length;
                const moduleProgress = progress[moduleId] || {};
                
                Object.values(moduleProgress).forEach(stepProgress => {
                    if (stepProgress.completed) {
                        totalCompletedSteps++;
                    }
                    if (stepProgress.score !== undefined) {
                        totalQuizCorrect += stepProgress.score;
                    }
                });

                module.steps.forEach(step => {
                    if (step.type === 'quiz') {
                        totalQuizQuestions += step.questions.length;
                    }
                });
            });


            const overallPercentage = totalPossibleSteps > 0 ? (totalCompletedSteps / totalPossibleSteps) * 100 : 0;

            return (
                <div className="p-4 sm:p-6 md:p-8 min-h-screen w-full flex flex-col">
                    <div className="w-full">
                        <header className="mb-8 text-center">
                            <div className="flex items-center justify-center gap-3 mb-2">
                                {/* Text placeholder for the main application identifier */}
                                <span className="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold text-xl shadow-lg">AB</span>
                                <h1 className="text-3xl sm:text-4xl font-extrabold text-gray-800">Acid-Base Balance Mastery</h1>
                                <span className="bg-gray-200 text-gray-600 text-xs font-mono px-2.5 py-1 rounded-full">V:1.0</span>
                            </div>
                            <p className="text-lg text-gray-500 max-w-2xl mx-auto">A detailed module focusing on the chemistry, regulation, and nursing management of ABG imbalances.</p>
                        </header>

                        {/* Skip Ahead Button */}
                        <div className="mb-8 text-center">
                            <button
                                onClick={onStartPreAssessment}
                                className="w-full max-w-md mx-auto px-6 py-4 bg-teal-500 text-white font-bold rounded-lg shadow-lg hover:bg-teal-600 transition-all duration-300 transform hover:scale-105"
                            >
                                <div className="text-xl">Skip Ahead: Diagnostic Quiz</div>
                                <div className="text-sm font-normal">Test your knowledge and potentially skip modules.</div>
                            </button>
                        </div>

                        {/* Overall Progress Bar & Reset Button */}
                        <div className="mb-8 bg-white rounded-2xl shadow-lg p-6 w-full">
                           <div className="flex justify-between items-center mb-3">
                               <h3 className="text-xl font-bold text-gray-800">Overall Progress</h3>
                               <button 
                                    onClick={onResetProgress}
                                    className="px-4 py-2 text-sm bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition-colors flex items-center gap-2"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V4a1 1 0 112 0v1.001A7.002 7.002 0 0112.292 4.293a1 1 0 111.414 1.414A9.002 9.002 0 004 9.899V11a1 1 0 11-2 0V3a1 1 0 011-1z" clipRule="evenodd" /></svg>
                                    Reset Progress
                               </button>
                           </div>
                            <div className="w-full bg-gray-200 rounded-full h-4">
                                <div
                                    className="bg-indigo-600 h-4 rounded-full transition-all duration-500 ease-out"
                                    style={{ width: `${overallPercentage}%` }}
                                ></div>
                            </div>
                            <div className="flex justify-between items-center">
                                <p className="text-left text-sm text-gray-600 mt-2">
                                    {totalQuizQuestions > 0 && `Quiz Performance: ${totalQuizCorrect} / ${totalQuizQuestions} correct`}
                                </p>
                                <p className="text-right text-sm text-gray-600 mt-2">{Math.round(overallPercentage)}% Completed</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 w-full">
                            {/* Iterate over all modules defined in contentData */}
                            {Object.entries(contentData).map(([id, module]) => {
                                const moduleProgress = progress[id] || {};
                                // Calculate completion count for steps within the module.
                                const completedCount = Object.values(moduleProgress).filter(p => p.completed).length;
                                const totalSteps = module.steps.length;
                                const percentage = totalSteps > 0 ? (completedCount / totalSteps) * 100 : 0;

                                let statusText = "Not Started";
                                let statusColor = "text-gray-500";
                                if (completedCount === totalSteps) {
                                    statusText = "Completed";
                                    statusColor = "text-green-600";
                                } else if (completedCount > 0) {
                                    statusText = "In Progress";
                                    statusColor = "text-yellow-600";
                                }

                                // Get quiz score for this module if available
                                const quizStep = module.steps.find(step => step.type === 'quiz');
                                const quizProgress = quizStep ? moduleProgress[quizStep.id] : null;

                                return (
                                    <div
                                        key={id}
                                        onClick={() => onSelectModule(id)}
                                        // Styling for module cards, including hover effects.
                                        className="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 cursor-pointer transition-all duration-300 hover:shadow-xl hover:-translate-y-1 group flex flex-col"
                                    >
                                        <div className="flex justify-between items-start mb-4">
                                            {/* Placeholder for module icon: Displays the acronym of the module title. */}
                                            <div className={cn("p-3 rounded-full bg-gradient-to-br", module.color, "w-10 h-10 flex items-center justify-center text-white text-lg font-bold shadow-md flex-shrink-0")}>
                                                {module.title.split(' ').map(word => word.charAt(0)).join('')}
                                            </div>
                                            {/* Progress Circle */}
                                            <div className="relative w-12 h-12 flex-shrink-0">
                                                <svg className="w-full h-full" viewBox="0 0 36 36">
                                                    {/* Background circle for the progress bar. */}
                                                    <path
                                                        className="text-gray-200"
                                                        d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        strokeWidth="3"
                                                    />
                                                    {/* Foreground arc representing the completion percentage. */}
                                                    <path
                                                        className="text-indigo-500"
                                                        d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        strokeWidth="3"
                                                        strokeDasharray={`${percentage}, 100`}
                                                        strokeLinecap="round"
                                                        transform="rotate(-90 18 18)"
                                                    />
                                                </svg>
                                                <span className="absolute inset-0 flex items-center justify-center text-xs font-bold text-gray-600">{Math.round(percentage)}%</span>
                                            </div>
                                        </div>
                                        <h3 className="text-xl font-bold text-gray-800 mb-2">{module.title}</h3>
                                        <p className="text-gray-500 text-sm mb-2 h-10" dangerouslySetInnerHTML={{ __html: module.description }}></p>
                                        <div className="mt-auto">
                                            <p className={cn("text-sm font-semibold", statusColor)}>{statusText}</p>
                                            {quizProgress && quizProgress.score !== undefined && (
                                                <p className="text-sm text-gray-600 mt-1">Quiz Score: {quizProgress.score} / {quizStep.questions.length}</p>
                                            )}
                                            <div className="flex items-center justify-end text-sm font-medium text-indigo-600 group-hover:text-indigo-700 mt-2">
                                                Start Learning <span className="ml-1 transition-transform group-hover:translate-x-1">&rarr;</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };
        
        /**
         * CaseStudy component for a multiple-choice case study challenge.
         */
        const CaseStudy = ({ caseData, onComplete }) => {
            // Case Studies are treated as single-select quizzes for simplicity, matching the data structure provided.
            const [selectedAnswer, setSelectedAnswer] = useState(null);
            const [feedbackShown, setFeedbackShown] = useState(false);

            // Handles the selection of an answer option.
            const handleSelect = (option) => {
                if (feedbackShown) return; // Prevent changing the answer once feedback is shown.
                setSelectedAnswer(option);
            };

            const handleSubmit = () => {
                setFeedbackShown(true);
                // Check if the selected answer matches the correct answer (single select logic used here)
                const isCorrect = String(selectedAnswer) === String(caseData.correctAnswer);
                
                // Note: The structure of the case study data uses a string for correctAnswer, so we treat it as single-select.
                if (isCorrect) {
                    onComplete({ score: 1 }); // Mark as complete with a score of 1 for correct.
                } else {
                    onComplete({ score: 0 }); // Mark as complete with a score of 0 for incorrect.
                }
            };

            const isAnswerSelected = selectedAnswer !== null;
            const correctAnswerNormalized = String(caseData.correctAnswer);

            return (
                <div className="p-4 bg-white rounded-xl shadow-lg">
                    <h4 className="font-bold text-lg text-gray-800 mb-2">Case Study Challenge</h4>
                    {/* Scenario description, using dangerouslySetInnerHTML to render HTML bold tags */}
                    <p className="bg-blue-100 text-blue-800 p-3 rounded-md mb-4 text-sm" dangerouslySetInnerHTML={{ __html: caseData.scenario }}></p>
                    <p className="font-semibold text-gray-700 mb-3">{caseData.question}</p>
                    <div className="space-y-2">
                        {caseData.options.map(option => {
                            const isSelected = selectedAnswer === option;
                            const isCorrectOption = String(option) === correctAnswerNormalized;
                            
                            let optionClass = 'bg-gray-50 hover:bg-gray-100 border-gray-200';
                            if (feedbackShown) {
                                if (isCorrectOption) {
                                    optionClass = 'bg-green-100 border-green-500 text-green-800';
                                } else if (isSelected && !isCorrectOption) {
                                    optionClass = 'bg-red-100 border-red-500 text-red-800';
                                }
                            } else if (isSelected) {
                                optionClass = 'bg-indigo-100 border-indigo-500 text-indigo-800';
                            }

                            return (
                                <div
                                    key={option}
                                    onClick={() => handleSelect(option)}
                                    className={cn('p-3 rounded-lg border-2 cursor-pointer transition-colors', optionClass, feedbackShown && 'pointer-events-none')}
                                >
                                    <div className="flex items-center">
                                        {feedbackShown && ( // Display a checkmark or cross icon if feedback is active
                                            isCorrectOption ? <span className="text-green-600 mr-2">✓</span> : (isSelected && <span className="text-red-600 mr-2">✗</span>)
                                        )}
                                        <span className="flex-1">{option}</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    {!feedbackShown && (
                        <div className="mt-4 text-center">
                            <button
                                onClick={handleSubmit}
                                disabled={!isAnswerSelected}
                                className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                            >
                                Submit Answer
                            </button>
                        </div>
                    )}
                    {feedbackShown && ( // Display the explanation after an answer has been selected.
                        <div className="mt-4 p-3 bg-indigo-50 rounded-lg border-l-4 border-indigo-500">
                            <h5 className="font-bold text-indigo-800">Explanation</h5>
                            <p className="text-sm text-indigo-700" dangerouslySetInnerHTML={{ __html: caseData.explanation }}></p>
                        </div>
                    )}
                </div>
            );
        };
        
        /**
         * StaticContentStep component for displaying basic text content.
         * Marks itself as complete immediately on render.
         */
        const StaticContentStep = ({ step, onComplete }) => {
            // For 'text' type steps, mark them as complete immediately upon rendering.
            useEffect(() => {
                onComplete({ completed: true, score: 1 }); // Mark as complete with a score of 1 for reading content.
            }, []); // Empty dependency array ensures this runs only once.

            // Using dangerouslySetInnerHTML to render HTML content (e.g., <strong> tags and LaTeX notation).
            return (
                <div className="prose max-w-none text-gray-700 leading-relaxed p-4 bg-white rounded-xl shadow-lg space-y-4">
                    <div dangerouslySetInnerHTML={{ __html: step.content }}></div>
                </div>
            );
        };

        /**
         * CompletionModal component displayed when a module is completed.
         */
        const CompletionModal = ({ isOpen, onClose, onNextModule, hasNextModule }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full text-center transform animate-fade-in">
                        <h3 className="text-2xl font-bold text-indigo-700 mb-4">Module Completed! 🎉</h3>
                        <p className="text-gray-700 mb-6">You've successfully completed all steps in this module. Great job!</p>
                        <div className="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                            <button
                                onClick={onClose}
                                className="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition-colors shadow-sm"
                            >
                                Back to Dashboard
                            </button>
                            {hasNextModule && (
                                <button
                                    onClick={onNextModule}
                                    className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors"
                                >
                                    Continue to Next Module
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        /**
         * LearningModule component to manage steps within the selected module.
         * Provides navigation between steps and renders the appropriate content for each.
         */
        const LearningModule = ({ module, onBack, progress, onProgressUpdate, onNextModule, hasNextModule }) => {
            const [activeStep, setActiveStep] = useState(0); // Manages the index of the currently active step.
            const [isSidebarOpen, setIsSidebarOpen] = useState(false); // Controls the visibility of the sidebar on mobile.
            const [isCompletionModalOpen, setIsCompletionModalOpen] = useState(false); // State for completion modal 

            // Callback function to update the completion status of a specific step.
            const handleStepComplete = useCallback((stepId, data = {}) => {
                onProgressUpdate(module.id, stepId, { completed: true, ...data });
            }, [onProgressUpdate, module.id]);

            const moduleProgress = progress[module.id] || {};
            
            // Check if all steps in the current module are completed
            const allStepsCompletedInModule = module.steps.every(step =>
                moduleProgress[step.id] && moduleProgress[step.id].completed
            );

            // Navigates to the next step, if available.
            const handleNextStep = () => {
                // If it's the last step and all steps in the module are completed, open the modal 
                if (activeStep === module.steps.length - 1 && allStepsCompletedInModule) {
                    setIsCompletionModalOpen(true);
                } else if (activeStep < module.steps.length - 1) {
                    setActiveStep(activeStep + 1);
                }
            };

            // Navigates to the previous step, if available.
            const handlePrevStep = () => {
                if (activeStep > 0) {
                    setActiveStep(activeStep - 1);
                }
            };
            
            // Ensure module and its steps are defined before accessing properties 
            if (!module || !module.steps) {
                console.error("LearningModule received invalid module prop:", module);
                return <div className="fixed inset-0 flex items-center justify-center bg-gray-100 text-gray-700">Loading module...</div>;
            }

            const currentStep = module.steps[activeStep];
            
            // Renders the appropriate content component based on the current step's type.
            const renderStepContent = (step) => {
                if (!step) return <p>Please select a step.</p>;

                const onCompleteForStep = (data) => handleStepComplete(step.id, data);

                switch (step.type) {
                    case 'text':
                        return <StaticContentStep key={step.id} step={step} onComplete={onCompleteForStep} />;
                    case 'case_study':
                        return <CaseStudy key={step.id} caseData={step.case} onComplete={onCompleteForStep} />;
                    case 'quiz':
                        // If quiz is already complete and user revisits, prevent re-taking by passing the score from progress
                        const quizStatus = moduleProgress[step.id];
                        if (quizStatus && quizStatus.completed && quizStatus.score !== undefined) {
                            // Render a simple completion message instead of the interactive quiz
                            return (
                                <div className="p-6 bg-white rounded-xl shadow-lg border-l-4 border-green-500">
                                    <h4 className="text-xl font-bold text-green-700 mb-2">Quiz Completed!</h4>
                                    <p className="text-gray-700">You scored {quizStatus.score} out of {step.questions.length} on this quiz.</p>
                                    <button onClick={handleNextStep} className="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Continue</button>
                                </div>
                            );
                        }
                        return <Quiz key={step.id} questions={step.questions} onComplete={onCompleteForStep} />;
                    default:
                        // Fallback for unrecognized step types, ensuring robust error handling.
                        return <p key={step.id} className="text-red-600">Error: Content for this step type is not available.</p>;
                }
            };

            const handleModalClose = () => {
                setIsCompletionModalOpen(false);
                onBack(); // Go back to dashboard when modal is closed 
            };

            const handleModalNextModule = () => {
                setIsCompletionModalOpen(false);
                onNextModule(); // Proceed to next module 
            };


            return (
                <div className="fixed inset-0 bg-gray-100 flex flex-col z-20">
                    {/* Header for the learning module, including back button and module title. */}
                    <header className="bg-white shadow-md p-4 flex items-center justify-between z-30 flex-shrink-0">
                        <button onClick={onBack} className="flex items-center gap-2 text-indigo-600 font-semibold hover:text-indigo-800 transition-colors p-2 rounded-lg -ml-2">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clipRule="evenodd" /></svg>
                            <span className="hidden sm:inline">Dashboard</span>
                        </button>
                        <div className="flex items-center gap-3">
                            <h2 className="text-xl font-bold text-gray-800 text-center flex-1 sm:flex-initial truncate px-2">{module.title}</h2>
                        </div>
                        {/* Mobile sidebar toggle button using text/emoji placeholders. */}
                        <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="md:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        </button>
                    </header>
                    {isSidebarOpen && <div onClick={() => setIsSidebarOpen(false)} className="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden"></div>}
                    <div className="flex flex-1 overflow-hidden">
                        {/* Sidebar for navigation steps within the module. */}
                        <aside className={cn(
                            "bg-white border-r border-gray-200 p-4 w-72 lg:w-80 flex-shrink-0 flex flex-col transition-transform duration-300 ease-in-out md:translate-x-0 absolute md:static h-full z-20",
                            isSidebarOpen ? 'translate-x-0' : '-translate-x-full'
                        )}>
                            <h3 className="text-lg font-semibold mb-4 text-gray-700 px-3">Module Steps</h3>
                            <nav className="space-y-1 overflow-y-auto flex-1 pr-1">
                                {module.steps.map((step, index) => (
                                    <button
                                        key={step.id}
                                        onClick={() => {
                                            setActiveStep(index);
                                            setIsSidebarOpen(false); // Close sidebar on mobile after a step is selected.
                                        }}
                                        className={cn(
                                            'w-full text-left p-3 rounded-lg flex items-center gap-3 transition-colors',
                                            activeStep === index ? 'bg-indigo-100 text-indigo-700 font-semibold' : 'hover:bg-gray-100 text-gray-700'
                                        )}
                                    >
                                        {/* Step completion indicator */}
                                        <div className="w-5 h-5 flex-shrink-0 flex items-center justify-center">
                                            {moduleProgress[step.id]?.completed ? (
                                                <svg className="w-5 h-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>
                                            ) : (
                                                <div className={cn("w-3 h-3 rounded-full border-2", activeStep === index ? "border-indigo-500 bg-indigo-500" : "border-gray-400 bg-white")}></div>
                                            )}
                                        </div>
                                        <span className="flex-1 text-sm">{step.title}</span>
                                    </button>
                                ))}
                            </nav>
                        </aside>

                        {/* Main content area for the current step. */}
                        <main className="flex-1 overflow-y-auto p-4 sm:p-6 md:p-8">
                            <div className="max-w-5xl mx-auto">
                                <h3 className="text-2xl font-bold text-gray-800 mb-4">{currentStep.title}</h3>
                                {renderStepContent(currentStep)}

                                {/* Navigation buttons for moving between steps. */}
                                <div className="flex justify-between mt-8">
                                    <button
                                        onClick={handlePrevStep}
                                        disabled={activeStep === 0}
                                        className="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm"
                                    >
                                        Previous
                                    </button>

                                    <button
                                        onClick={handleNextStep}
                                        disabled={activeStep === module.steps.length - 1 && !allStepsCompletedInModule}
                                        className="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-md"
                                    >
                                        {activeStep === module.steps.length - 1 ? 'Finish Module' : 'Next'}
                                    </button>
                                </div>
                            </div>
                        </main>
                    </div>
                    <CompletionModal
                        isOpen={isCompletionModalOpen}
                        onClose={handleModalClose}
                        onNextModule={handleModalNextModule}
                        hasNextModule={hasNextModule}
                    />
                </div>
            );
        };
        
        // --- Main App Component ---
        /**
         * The root component of the Acid-Base Balance learning module application.
         * Manages overall application state, including module selection, user ID, and progress.
         */
        function App() {
            // State for the currently selected learning module's ID. Null means Dashboard is active.
            const [currentModuleId, setCurrentModuleId] = useState(null);
            const [isPreAssessmentActive, setIsPreAssessmentActive] = useState(false);
            // State for the authenticated user's ID, used for local storage progress tracking.
            const [userId, setUserId] = useState(null);
            // State for storing the user's progress across all modules and steps.
            const [progress, setProgress] = useState({});
            // State to indicate if authentication is complete and user ID is available.
            const [isAuthReady, setIsAuthReady] = useState(false);

            // Effect hook for handling initial authentication and setting the user ID.
            useEffect(() => {
                const unsubscribe = mockAuth.onAuthStateChanged((user) => {
                    if (user) setUserId(user.uid);
                    setIsAuthReady(true); // Mark authentication as ready once user is determined.
                });
                return () => unsubscribe(); // Cleanup the auth state listener on component unmount.
            }, []); // Empty dependency array ensures this runs only once on mount.

            // Effect hook for loading user progress from localStorage after authentication is ready.
            useEffect(() => {
                if (!isAuthReady || !userId) return; // Only proceed if auth is ready and userId is available.
                const storedProgress = localStorage.getItem(`acid-base-module-progress-${userId}`);
                if (storedProgress) {
                    try {
                        setProgress(JSON.parse(storedProgress)); // Attempt to parse and set stored progress.
                    } catch (e) {
                        console.error("Failed to parse stored progress, resetting.", e);
                        setProgress({}); // Reset progress if parsing fails (e.g., corrupted data).
                    }
                }
            }, [isAuthReady, userId]); // Reruns when auth status or userId changes.

            // Callback function to update and persist the user's progress for a specific step.
            const handleProgressUpdate = useCallback((moduleId, stepId, data = {}) => {
                if (!isAuthReady || !userId) return;

                setProgress(currentProgress => {
                    const currentStepProgress = currentProgress[moduleId]?.[stepId] || {};
                    const newStepProgress = { ...currentStepProgress, ...data };

                    // Prevent unnecessary state update if data hasn't actually changed.
                    if (JSON.stringify(currentStepProgress) === JSON.stringify(newStepProgress)) {
                        return currentProgress;
                    }

                    // Otherwise, proceed with the update.
                    const newProgress = {
                        ...currentProgress,
                        [moduleId]: {
                            ...(currentProgress[moduleId] || {}),
                            [stepId]: newStepProgress
                        }
                    };

                    localStorage.setItem(`acid-base-module-progress-${userId}`, JSON.stringify(newProgress));
                    return newProgress;
                });
            }, [isAuthReady, userId]);

            const handlePreAssessmentComplete = (completedModuleIds) => {
                const newProgress = { ...progress };
                completedModuleIds.forEach(moduleId => {
                    const module = contentData[moduleId];
                    if (module) {
                        newProgress[moduleId] = {};
                        module.steps.forEach(step => {
                            newProgress[moduleId][step.id] = { completed: true };
                        });
                    }
                });
                setProgress(newProgress);
                localStorage.setItem(`acid-base-module-progress-${userId}`, JSON.stringify(newProgress));
            };
            
            // Callback to reset all progress
            const handleResetProgress = useCallback(() => {
                if (!isAuthReady || !userId) return;
                // Clear from state
                setProgress({});
                // Clear from localStorage
                localStorage.removeItem(`acid-base-module-progress-${userId}`);
            }, [isAuthReady, userId]);

            // Function to navigate to the next module in the sequence
            const handleNextModule = useCallback(() => {
                const moduleIds = Object.keys(contentData);
                const currentIndex = moduleIds.indexOf(currentModuleId);
                if (currentIndex !== -1 && currentIndex < moduleIds.length - 1) {
                    setCurrentModuleId(moduleIds[currentIndex + 1]);
                } else {
                    // If it's the last module, go back to the dashboard.
                    setCurrentModuleId(null);
                }
            }, [currentModuleId]);

            // Determine which module is currently selected based on `currentModuleId`.
            const selectedModule = currentModuleId && contentData[currentModuleId]
                                                     ? { ...contentData[currentModuleId], id: currentModuleId }
                                                     : null;

            const moduleIds = Object.keys(contentData);
            const currentIndex = selectedModule ? moduleIds.indexOf(selectedModule.id) : -1;
            const hasNextModule = currentIndex !== -1 && currentIndex < moduleIds.length - 1;


            return (
                <div className="bg-gray-100 min-h-screen font-sans text-gray-900">
                    {isPreAssessmentActive ? (
                        <PreAssessmentQuiz 
                            onComplete={handlePreAssessmentComplete} 
                            onExit={() => setIsPreAssessmentActive(false)}
                        />
                    ) : selectedModule ? (
                        <LearningModule
                            key={selectedModule.id}
                            module={selectedModule}
                            onBack={() => setCurrentModuleId(null)}
                            progress={progress}
                            onProgressUpdate={handleProgressUpdate}
                            onNextModule={handleNextModule}
                            hasNextModule={hasNextModule}
                        />
                    ) : (
                        <Dashboard 
                            onSelectModule={setCurrentModuleId} 
                            progress={progress} 
                            onResetProgress={handleResetProgress}
                            onStartPreAssessment={() => setIsPreAssessmentActive(true)}
                        />
                    )}
                </div>
            );
        }

        // --- Render the App into the DOM ---
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
